from flask import session

SUPPORTED_LANGS = ["it", "en"]
DEFAULT_LANG = "it"

TRANSLATIONS = {
    "it": {
        "nav.containers": "Container",
        "nav.images": "Immagini",
        "nav.updates": "Aggiornamenti",
        "nav.autodiscovery": "Autodiscovery",
        "nav.settings": "Impostazioni",
        "nav.security": "Sicurezza",
        "nav.logout": "Esci",
        "nav.events": "Eventi",
        "nav.home": "Dashboard",
        "login.title": "D2HA – Accesso",
        "login.button": "Accedi",
        "login.heading": "Benvenuto in D2HA",
        "login.username": "Nome utente",
        "login.password": "Password",
        "login.token": "Codice 2FA",
        "login.reminder": "Completa la configurazione iniziale se richiesto.",
        "wizard.step1.title": "Configurazione account amministratore",
        "wizard.step2.title": "Autenticazione a due fattori (2FA)",
        "wizard.step3.title": "Modalità del sistema",
        "wizard.step4.title": "Autodiscovery MQTT e Home Assistant",
        "setup_account.title": "Aggiorna le credenziali di accesso",
        "setup_account.submit": "Continua",
        "setup_2fa.enable": "Abilita 2FA",
        "setup_2fa.skip": "Salta per ora",
        "setup_modes.title": "Modalità del sistema",
        "setup_modes.safe": "Modalità sicura",
        "setup_modes.performance": "Modalità prestazioni",
        "setup_autodiscovery.title": "Autodiscovery MQTT e Home Assistant",
        "setup_autodiscovery.enable_all": "Abilita tutte le entità",
        "setup_autodiscovery.disable_all": "Disattiva autodiscovery",
        "safe_mode.label": "Modalità sicura",
        "performance_mode.label": "Modalità prestazioni",
        "theme.label": "Tema",
        "theme.dark": "Scuro",
        "theme.light": "Chiaro",
        "language.label": "Lingua",
        "language.italian": "Italiano",
        "language.english": "English",
        "settings.title": "Impostazioni",
        "settings.security_hint": "Gestisci autenticazione e modalità sicura.",
        "settings.performance_hint": "Riduci carico e polling automatico.",
        "settings.safe_hint": "Richiedi conferma o blocca le modifiche critiche.",
        "settings.backend_status": "Stato backend",
        "settings.notifications": "Notifiche",
        "settings.close": "Chiudi",
        "settings.refresh": "Aggiorna ora",
        "settings.os": "OS installato",
        "settings.docker": "Versione Docker",
        "settings.uptime": "Uptime",
        "theme.switch_label": "Tema",
        "theme.dark.label": "Scuro",
        "theme.light.label": "Chiaro",
        "footer.logout": "Esci",
        "backend_status.no_recent_update": "Nessun aggiornamento riuscito di recente",
        "flash.login_rate_limited": "Troppi tentativi di accesso falliti da questo indirizzo. Riprova più tardi.",
        "flash.invalid_credentials": "Credenziali o codice 2FA non validi.",
        "flash.password_required": "Scegli una password.",
        "flash.passwords_mismatch": "Le password non coincidono.",
        "flash.password_admin_forbidden": "Per sicurezza, la password non può rimanere 'admin'.",
        "flash.password_length_short": "Scegli una password più lunga (almeno 10 caratteri).",
        "flash.account_updated_onboarding": "Account aggiornato. Completiamo la configurazione della sicurezza.",
        "flash.setup2fa_skipped": "L'autenticazione a due fattori è disattivata. Potrai abilitarla più tardi nelle Impostazioni di sicurezza.",
        "flash.setup2fa_enabled": "Autenticazione a due fattori abilitata.",
        "flash.setup2fa_invalid_code": "Codice di verifica non valido. Riprova.",
        "flash.autodiscovery_invalid_choice": "Seleziona una opzione valida per l'autodiscovery MQTT.",
        "flash.autodiscovery_apply_failed": "Impossibile applicare automaticamente l'autodiscovery MQTT. Puoi riprovare dalla pagina Autodiscovery.",
        "flash.autodiscovery_complete": "Configurazione iniziale completata. Potrai modificare queste impostazioni in qualsiasi momento.",
        "flash.autodiscovery_partial": "Configurazione iniziale completata, ma alcune impostazioni MQTT potrebbero richiedere un nuovo tentativo dalla pagina Autodiscovery.",
        "flash.security_current_password_incorrect": "Password attuale non corretta.",
        "flash.security_current_totp_missing": "Inserisci il codice 2FA corrente.",
        "flash.security_totp_config_invalid": "Configurazione 2FA non valida. Riavvia la procedura.",
        "flash.security_totp_invalid": "Codice 2FA non valido. Riprova.",
        "flash.security_new_passwords_mismatch": "Le nuove password non coincidono.",
        "flash.security_new_password_admin_forbidden": "Per sicurezza, la password non può essere 'admin'.",
        "flash.security_new_password_short": "Scegli una password più lunga (almeno 10 caratteri).",
        "flash.security_password_updated": "Password aggiornata correttamente.",
        "flash.security_no_changes": "Nessuna modifica effettuata.",
        "flash.security_fix_errors": "Correggi gli errori e riprova.",
        "flash.security_credentials_updated": "Credenziali aggiornate.",
        "flash.security_2fa_already_enabled": "2FA già abilitata.",
        "flash.security_scan_qr_to_enable": "Scansiona il codice e conferma con un token per abilitare la 2FA.",
        "flash.security_totp_secret_missing": "Segreto TOTP non disponibile. Riavvia la procedura.",
        "flash.security_2fa_enabled_invalid_code": "Codice 2FA non valido. Riprova.",
        "flash.security_2fa_enabled": "Autenticazione a due fattori abilitata con successo.",
        "flash.security_2fa_already_disabled": "2FA già disabilitata.",
        "flash.security_2fa_disabled_warning": "2FA disabilitata. Attenzione: l’account è ora protetto solo da username e password.",
        "login.onboarding_hint": "Accedi con le credenziali amministrative. Al primo login con <strong>admin / admin</strong> ti guideremo in un rapido setup sicuro.",
    },
    "en": {
        "nav.containers": "Containers",
        "nav.images": "Images",
        "nav.updates": "Updates",
        "nav.autodiscovery": "Autodiscovery",
        "nav.settings": "Settings",
        "nav.security": "Security",
        "nav.logout": "Logout",
        "nav.events": "Events",
        "nav.home": "Dashboard",
        "login.title": "D2HA – Login",
        "login.button": "Sign in",
        "login.heading": "Welcome to D2HA",
        "login.username": "Username",
        "login.password": "Password",
        "login.token": "2FA code",
        "login.reminder": "Complete the initial setup if prompted.",
        "wizard.step1.title": "Admin account setup",
        "wizard.step2.title": "Two-factor authentication (2FA)",
        "wizard.step3.title": "System modes",
        "wizard.step4.title": "MQTT Autodiscovery & Home Assistant",
        "setup_account.title": "Update sign-in credentials",
        "setup_account.submit": "Continue",
        "setup_2fa.enable": "Enable 2FA",
        "setup_2fa.skip": "Skip for now",
        "setup_modes.title": "System modes",
        "setup_modes.safe": "Safe mode",
        "setup_modes.performance": "Performance mode",
        "setup_autodiscovery.title": "MQTT Autodiscovery & Home Assistant",
        "setup_autodiscovery.enable_all": "Enable all entities",
        "setup_autodiscovery.disable_all": "Disable autodiscovery",
        "safe_mode.label": "Safe mode",
        "performance_mode.label": "Performance mode",
        "theme.label": "Theme",
        "theme.dark": "Dark",
        "theme.light": "Light",
        "language.label": "Language",
        "language.italian": "Italiano",
        "language.english": "English",
        "settings.title": "Settings",
        "settings.security_hint": "Manage authentication and safe mode.",
        "settings.performance_hint": "Reduce load and automatic polling.",
        "settings.safe_hint": "Require confirmation or block critical changes.",
        "settings.backend_status": "Backend status",
        "settings.notifications": "Notifications",
        "settings.close": "Close",
        "settings.refresh": "Refresh now",
        "settings.os": "Installed OS",
        "settings.docker": "Docker version",
        "settings.uptime": "Uptime",
        "theme.switch_label": "Theme",
        "theme.dark.label": "Dark",
        "theme.light.label": "Light",
        "footer.logout": "Logout",
        "backend_status.no_recent_update": "No recent successful updates",
        "flash.login_rate_limited": "Too many failed login attempts from this address. Please try again later.",
        "flash.invalid_credentials": "Invalid credentials or 2FA code.",
        "flash.password_required": "Please choose a password.",
        "flash.passwords_mismatch": "Passwords do not match.",
        "flash.password_admin_forbidden": "For security, the password cannot remain 'admin'.",
        "flash.password_length_short": "Choose a longer password (at least 10 characters).",
        "flash.account_updated_onboarding": "Account updated. Let's finish configuring security.",
        "flash.setup2fa_skipped": "Two-factor authentication is disabled. You can enable it later in Security settings.",
        "flash.setup2fa_enabled": "Two-factor authentication enabled.",
        "flash.setup2fa_invalid_code": "Invalid verification code. Please try again.",
        "flash.autodiscovery_invalid_choice": "Select a valid option for MQTT autodiscovery.",
        "flash.autodiscovery_apply_failed": "Could not automatically apply MQTT autodiscovery. You can retry from the Autodiscovery page.",
        "flash.autodiscovery_complete": "Initial setup completed. You can change these settings anytime.",
        "flash.autodiscovery_partial": "Initial setup completed, but some MQTT settings may need another try from the Autodiscovery page.",
        "flash.security_current_password_incorrect": "Current password is incorrect.",
        "flash.security_current_totp_missing": "Enter the current 2FA code.",
        "flash.security_totp_config_invalid": "Invalid 2FA configuration. Restart the process.",
        "flash.security_totp_invalid": "Invalid 2FA code. Please try again.",
        "flash.security_new_passwords_mismatch": "New passwords do not match.",
        "flash.security_new_password_admin_forbidden": "For security, the password cannot be 'admin'.",
        "flash.security_new_password_short": "Choose a longer password (at least 10 characters).",
        "flash.security_password_updated": "Password updated successfully.",
        "flash.security_no_changes": "No changes made.",
        "flash.security_fix_errors": "Fix the errors and try again.",
        "flash.security_credentials_updated": "Credentials updated.",
        "flash.security_2fa_already_enabled": "2FA already enabled.",
        "flash.security_scan_qr_to_enable": "Scan the code and confirm with a token to enable 2FA.",
        "flash.security_totp_secret_missing": "TOTP secret not available. Restart the process.",
        "flash.security_2fa_enabled_invalid_code": "Invalid 2FA code. Please try again.",
        "flash.security_2fa_enabled": "Two-factor authentication enabled successfully.",
        "flash.security_2fa_already_disabled": "2FA already disabled.",
        "flash.security_2fa_disabled_warning": "2FA disabled. Warning: the account is now protected only by username and password.",
        "login.onboarding_hint": "Sign in with the admin credentials. On first login with <strong>admin / admin</strong> we'll guide you through a quick secure setup.",
    },
}


def get_current_lang() -> str:
    lang = session.get("lang") or DEFAULT_LANG
    if lang not in SUPPORTED_LANGS:
        lang = DEFAULT_LANG
    return lang


def set_current_lang(lang: str) -> None:
    if lang in SUPPORTED_LANGS:
        session["lang"] = lang


def t(key: str) -> str:
    lang = get_current_lang()
    return TRANSLATIONS.get(lang, {}).get(
        key,
        TRANSLATIONS.get(DEFAULT_LANG, {}).get(key, key),
    )
