{% extends "layouts/auth_base.html" %}
{% block title %}{{ t("login.title") }}{% endblock %}

{% block auth_content %}
  <h1>{{ t("login.heading") }}</h1>
  {% if show_onboarding_hint %}
  <p>{{ t("login.onboarding_hint")|safe }}</p>
  {% endif %}

  <form method="post" autocomplete="off">
    <div>
      <label for="username">{{ t("login.username") }}</label>
      <input type="text" id="username" name="username" required />
    </div>
    <div>
      <label for="password">{{ t("login.password") }}</label>
      <div class="password-input-wrapper">
        <input type="password" id="password" name="password" required />
        <button type="button" class="password-toggle" aria-label="{{ t('password.toggle.show') }}" title="{{ t('password.toggle.show') }}">üëÅ</button>
      </div>
    </div>
    {% if two_factor %}
    <div>
      <label for="token">{{ t("login.token") }}</label>
      <input type="text" id="token" name="token" pattern="\d{6}" inputmode="numeric" autocomplete="one-time-code" />
      <p class="hint">{{ t("wizard.step2.title") }}</p>
    </div>
    {% endif %}
    <button type="submit" class="btn">{{ t("login.button") }}</button>
  </form>
{% endblock %}

{% block auth_scripts %}
  <script>
    (function enhancePasswordInputs() {
      const showLabel = '{{ t('password.toggle.show') }}';
      const hideLabel = '{{ t('password.toggle.hide') }}';

      document.querySelectorAll('input[type="password"]').forEach((input) => {
        const existingWrapper = input.closest('.password-input-wrapper');
        const wrapper = existingWrapper || (() => {
          const created = document.createElement('div');
          created.className = 'password-input-wrapper';
          input.parentNode.insertBefore(created, input);
          created.appendChild(input);
          return created;
        })();

        let toggle = wrapper.querySelector('.password-toggle');
        if (!toggle) {
          toggle = document.createElement('button');
          toggle.type = 'button';
          toggle.className = 'password-toggle';
          wrapper.appendChild(toggle);
        }

        if (toggle.dataset.bound === 'true') return;

        const updateState = (isHidden) => {
          toggle.setAttribute('aria-label', isHidden ? showLabel : hideLabel);
          toggle.title = isHidden ? showLabel : hideLabel;
          toggle.textContent = isHidden ? 'üëÅ' : 'üôà';
        };

        updateState(true);

        toggle.addEventListener('click', () => {
          const isHidden = input.type === 'password';
          input.type = isHidden ? 'text' : 'password';
          updateState(!isHidden);
        });

        toggle.dataset.bound = 'true';
      });
    })();
  </script>
{% endblock %}
