<!DOCTYPE html>
<html lang="{{ get_current_lang() }}">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}D2HA{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
</head>
<body
  class="theme-{{ get_current_theme() }}"
  data-safe-mode="{{ '1' if safe_mode_enabled else '0' }}"
  data-performance-mode="{{ '1' if performance_mode_enabled else '0' }}"
  data-debug-mode="{{ '1' if debug_mode_enabled else '0' }}"
>
  <script>
    (() => {
      try {
        if (localStorage.getItem('d2haCompactMode') === '1') {
          document.body.classList.add('compact-mode');
        }
      } catch (err) {
        console.warn('Unable to restore compact mode', err);
      }
    })();
  </script>
  <div class="auth-page">
    <!-- Auth animated tech background (login + wizard) -->
    <canvas id="authCanvas" class="auth-canvas" aria-hidden="true"></canvas>
    <div class="auth-title" aria-hidden="true">D2HA</div>
    <div class="auth-logo" aria-hidden="true">
      <img src="{{ url_for('static', filename='img/logo.svg') }}" alt="D2HA Logo">
    </div>

    <div class="auth-overlay">
      {% include 'partials/flash_messages.html' %}

      <div class="onboarding-toolbar">
        <button id="compactToggleAuth" class="onboarding-toggle compact-toggle" type="button" aria-pressed="false" aria-label="{{ t('compact_mode.label') }}" title="{{ t('compact_mode.hint') }}">üóúÔ∏è</button>
        <button id="onboardingToggle" class="onboarding-toggle" type="button" aria-expanded="false" aria-controls="onboardingMenu" title="{{ t('settings.title') }}">üåê</button>
        <div id="onboardingMenu" class="onboarding-menu" role="region" aria-label="{{ t('settings.title') }}">
          <h2>{{ t('settings.title') }}</h2>
          <form method="post" action="{{ url_for('auth.set_language') }}">
            <input type="hidden" name="next" value="{{ request.path }}">
            <label for="onboarding-lang">{{ t('language.label') }}</label>
            <select id="onboarding-lang" name="lang" onchange="this.form.submit()">
              {% for lang_code in SUPPORTED_LANGS %}
              <option value="{{ lang_code }}" {% if get_current_lang() == lang_code %}selected{% endif %}>
                {{ t('language.italian') if lang_code == 'it' else t('language.english') }}
              </option>
              {% endfor %}
            </select>
          </form>
          <form method="post" action="{{ url_for('auth.set_theme') }}">
            <input type="hidden" name="next" value="{{ request.path }}">
            <label for="onboarding-theme">{{ t('theme.label') }}</label>
            <select id="onboarding-theme" name="theme" onchange="this.form.submit()">
              {% for theme in SUPPORTED_THEMES %}
              <option value="{{ theme }}" {% if get_current_theme() == theme %}selected{% endif %}>{{ t('theme.' + theme) }}</option>
              {% endfor %}
            </select>
          </form>
        </div>
      </div>

      <div class="auth-card">
        {% block auth_content %}{% endblock %}
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/auth_background.js') }}"></script>
  <script>
    const onboardingToggle = document.getElementById('onboardingToggle');
    const onboardingMenu = document.getElementById('onboardingMenu');

    if (onboardingToggle && onboardingMenu) {
      onboardingToggle.addEventListener('click', (event) => {
        event.stopPropagation();
        onboardingMenu.classList.toggle('open');
        onboardingToggle.setAttribute('aria-expanded', onboardingMenu.classList.contains('open'));
      });

      document.addEventListener('click', (event) => {
        if (!onboardingMenu.contains(event.target) && event.target !== onboardingToggle) {
          onboardingMenu.classList.remove('open');
          onboardingToggle.setAttribute('aria-expanded', 'false');
        }
      });
    }

    const compactToggleAuth = document.getElementById('compactToggleAuth');
    const compactStorageKey = 'd2haCompactMode';

    function applyCompactMode(enabled) {
      const isEnabled = !!enabled;
      document.body.classList.toggle('compact-mode', isEnabled);
      compactToggleAuth?.setAttribute('aria-pressed', isEnabled ? 'true' : 'false');
    }

    function initCompactToggle() {
      applyCompactMode(localStorage.getItem(compactStorageKey) === '1');
      if (!compactToggleAuth) return;
      compactToggleAuth.addEventListener('click', () => {
        const next = !document.body.classList.contains('compact-mode');
        applyCompactMode(next);
        localStorage.setItem(compactStorageKey, next ? '1' : '0');
      });
    }

    initCompactToggle();
  </script>
  {% block auth_scripts %}{% endblock %}
</body>
</html>
