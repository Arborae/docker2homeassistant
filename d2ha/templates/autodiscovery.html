<!DOCTYPE html>
<html lang="{{ get_current_lang() }}">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D2HA – MQTT</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  {% include 'partials/notifications_styles.html' %}
</head>

<body class="theme-{{ get_current_theme() }}" data-safe-mode="{{ '1' if safe_mode_enabled else '0' }}"
  data-performance-mode="{{ '1' if performance_mode_enabled else '0' }}"
  data-debug-mode="{{ '1' if debug_mode_enabled else '0' }}">
  <header>
    <div class="header-shell">
      {% include 'partials/notifications_panel.html' %}
      <nav id="primaryNav" role="navigation">
        <a href="{{ url_for('ui.index') }}" class="tab {{ 'active' if active_page == 'home' else '' }}">Home</a>
        <a href="{{ url_for('ui.containers_view') }}"
          class="tab {{ 'active' if active_page == 'containers' else '' }}">{{
          t("nav.containers") }}</a>
        <a href="{{ url_for('ui.images_view') }}" class="tab {{ 'active' if active_page == 'images' else '' }}">{{
          t("nav.images") }}</a>
        <a href="{{ url_for('ui.volumes_view') }}" class="tab {{ 'active' if active_page == 'volumes' else '' }}">{{
          t("nav.volumes") }}</a>
        <a href="{{ url_for('ui.networks_view') }}" class="tab {{ 'active' if active_page == 'networks' else '' }}">{{
          t("nav.networks") }}</a>
        <a href="{{ url_for('ui.updates') }}" class="tab {{ 'active' if active_page == 'updates' else '' }}">{{
          t("nav.updates") }}</a>
        <a href="{{ url_for('ui.events_view') }}" class="tab {{ 'active' if active_page == 'events' else '' }}">{{
          t("nav.events") }}</a>
        <a href="{{ url_for('ui.autodiscovery_view') }}"
          class="tab {{ 'active' if active_page == 'autodiscovery' else '' }}">{{ t("nav.autodiscovery") }}</a>
        <a href="{{ url_for('auth.logout') }}" class="tab logout-link">{{ t("nav.logout") }}</a>
      </nav>
    </div>
  </header>

  {% include 'partials/flash_messages.html' %}

  <main>
    <section class="mqtt-status-bar">
      <div class="title">
        <h3>MQTT</h3>
        <div class="meta">
          {% if mqtt_status.broker %}
          Broker {{ mqtt_status.broker }}{% if mqtt_status.port %}:{{ mqtt_status.port }}{% endif %}
          {% else %}
          Nessun broker configurato
          {% endif %}
        </div>
      </div>
      <div class="status-chips">
        <div class="status-chip {{ 'success' if mqtt_status.connected else 'danger' }}">
          <span class="dot" aria-hidden="true"></span>
          <span>{{ 'Connesso' if mqtt_status.connected else 'Non connesso' }}</span>
        </div>
        <div class="status-chip">
          <span class="dot" aria-hidden="true"></span>
          <span>Sensori condivisi: {{ mqtt_status.shared_entities }} / {{ mqtt_status.total_entities }}</span>
        </div>
        <button type="button" class="status-chip status-chip-button" id="open-mqtt-log">
          <span class="dot" aria-hidden="true"></span>
          <span>Log pubblicazioni</span>
        </button>
      </div>
    </section>

    <section class="section-summary-bar">
      <div>
        <h3>Entità MQTT esposte</h3>
        <div class="meta">{{ summary.running }} container attivi · {{ summary.total_containers }} totali · {{
          summary.images }} immagini installate</div>
      </div>
      <button type="submit" form="autodiscovery-form" class="btn-primary-glow">Salva preferenze</button>
    </section>

    <form id="autodiscovery-form" class="stacks" method="POST">
      <section class="section-card">
        <div class="section-card-header">
          <div class="title">
            <span>Azioni generali</span>
          </div>
        </div>
        <div class="section-card-body">
          <div class="checkbox-row">
            <label class="checkbox-item" title="Esponi su MQTT il bottone per cancellare le immagini non in uso">
              <input type="checkbox" name="delete_unused_images"
                aria-label="Esponi su MQTT il bottone cancella immagini non in uso" {% if
                global_preferences.get('delete_unused_images') %}checked{% endif %} />
              <span class="checkbox-label">Bottone "Cancella immagini non in uso"</span>
            </label>
          </div>
          <div class="muted">Rende disponibile su MQTT il comando per eliminare le immagini Docker non utilizzate.</div>
          <div class="checkbox-row" style="margin-top: 1rem;">
            <label class="checkbox-item" title="Esponi su MQTT un sensore con il numero di container da aggiornare">
              <input type="checkbox" name="updates_overview"
                aria-label="Esponi su MQTT un sensore con il numero di container da aggiornare" {% if
                global_preferences.get('updates_overview') %}checked{% endif %} />
              <span class="checkbox-label">Sensore "Container da aggiornare"</span>
            </label>
          </div>
          <div class="muted">Pubblica un sensore con il numero di container con aggiornamenti disponibili e i loro nomi
            negli attributi.</div>
          <div class="checkbox-row" style="margin-top: 1rem;">
            <label class="checkbox-item" title="Esponi su MQTT un bottone per aggiornare tutti i container">
              <input type="checkbox" name="full_update_all"
                aria-label="Esponi su MQTT un bottone per aggiornare tutti i container" {% if
                global_preferences.get('full_update_all') %}checked{% endif %} />
              <span class="checkbox-label">Bottone "Aggiorna tutti i container"</span>
            </label>
          </div>
          <div class="muted">Esegue il pull e la ricreazione di tutti i container con aggiornamenti disponibili.</div>
        </div>
      </section>

      {% for stack, containers in stack_map.items() %}
      <section class="section-card">
        <div class="section-card-header section-toggle" data-stack-toggle>
          <div class="title">
            <button type="button" class="section-toggle-btn" aria-expanded="true"
              aria-label="Mostra o nascondi sezione">
              <span class="chevron">▾</span>
            </button>
            <span>{{ ('Senza stack' if stack == '_no_stack' else stack) | upper }}</span>
          </div>
          <div class="section-card-actions">
            <button type="button" class="btn-chip deselect-stack">Seleziona/Deseleziona tutti</button>
            <div class="section-card-badge">{{ containers|length }} container</div>
          </div>
        </div>
        <div class="section-card-body stack-content" style="overflow-x:auto;">
          <table class="responsive-table">
            <colgroup>
              <col class="col-name">
              <col class="col-image">
              <col class="col-status">
              <col class="col-pref">
            </colgroup>
            <thead>
              <tr>
                <th>{{ t("nav.containers") }}</th>
                <th>Immagine</th>
                <th>Stato</th>
                <th class="align-center">Preferenze</th>
              </tr>
            </thead>
            <tbody>
              {% for c in containers %}
              {% set pref = preferences.get(c.stable_id, {'state': True, 'actions': {}}) %}
              <tr>
                <td data-label="Container">
                  <div class="name">{{ c.name }}</div>
                  <div class="muted">{{ c.short_id }}</div>
                </td>
                <td data-label="Immagine">{{ c.image }}</td>
                <td data-label="Stato">{{ c.status }}</td>
                <td data-label="Preferenze" class="align-center">
                  <div class="checkbox-row">
                    <label class="checkbox-item" title="Autodiscovery stato per {{ c.name }}">
                      <input type="checkbox" name="{{ c.stable_id }}_state"
                        aria-label="Autodiscovery stato per {{ c.name }}" {% if pref.state %}checked{% endif %} />
                      <span class="checkbox-label">Stato</span>
                    </label>
                    {% for action in actions %}
                    <label class="checkbox-item" title="{{ action.replace('_', ' ')|title }} per {{ c.name }}">
                      <input type="checkbox" name="{{ c.stable_id }}_{{ action }}"
                        aria-label="{{ action.replace('_', ' ')|title }} per {{ c.name }}" {% if
                        pref.actions.get(action, True) %}checked{% endif %} />
                      <span class="checkbox-label">{{ action.replace('_', ' ')|title }}</span>
                    </label>
                    {% endfor %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
      {% endfor %}
    </form>
  </main>
  <div class="modal-backdrop" id="mqtt-log-modal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mqtt-log-title">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="mqtt-log-title">Pubblicazioni MQTT</div>
          <div class="modal-subtitle">Ultimi messaggi inviati verso il broker</div>
        </div>
        <button class="modal-close" type="button" id="mqtt-log-close" aria-label="Chiudi">✕</button>
      </div>
      <div class="modal-body">
        <div id="mqtt-log-terminal" class="terminal" role="log" aria-live="polite" aria-label="Log pubblicazioni MQTT">
        </div>
      </div>
    </div>
  </div>
  {% include 'partials/notifications_script.html' %}
  <script>
    const stackToggles = Array.from(document.querySelectorAll('[data-stack-toggle]'));
    const deselectButtons = Array.from(document.querySelectorAll('.deselect-stack'));
    const autodiscoveryForm = document.getElementById('autodiscovery-form');
    const mqttLogModal = document.getElementById('mqtt-log-modal');
    const mqttLogTerminal = document.getElementById('mqtt-log-terminal');
    const mqttLogOpenBtn = document.getElementById('open-mqtt-log');
    const mqttLogCloseBtn = document.getElementById('mqtt-log-close');
    let mqttLogInterval = null;

    function formatMqttEntry(entry) {
      const timestamp = entry?.timestamp ? new Date(entry.timestamp) : null;
      const timeStr = timestamp && !Number.isNaN(timestamp.getTime())
        ? timestamp.toLocaleTimeString([], { hour12: false })
        : '--:--:--';
      const qosStr = typeof entry?.qos === 'number' ? ` qos=${entry.qos}` : '';
      const retainStr = entry?.retain ? ' retain' : '';
      const topic = entry?.topic || '<topic sconosciuto>';
      const payload = entry?.payload ?? '';
      return `[${timeStr}] ${topic} -> ${payload}${qosStr}${retainStr}`;
    }

    function renderMqttLog(entries) {
      if (!mqttLogTerminal) return;
      mqttLogTerminal.innerHTML = '';

      if (!entries || !entries.length) {
        const emptyState = document.createElement('div');
        emptyState.className = 'terminal-empty';
        emptyState.textContent = 'Nessuna pubblicazione recente.';
        mqttLogTerminal.appendChild(emptyState);
        return;
      }

      entries.forEach((entry) => {
        const line = document.createElement('div');
        line.className = 'terminal-line';
        line.textContent = formatMqttEntry(entry);
        mqttLogTerminal.appendChild(line);
      });

      mqttLogTerminal.scrollTop = mqttLogTerminal.scrollHeight;
    }

    async function refreshMqttLog() {
      try {
        const response = await fetch('/api/mqtt/publishes');
        if (!response.ok) throw new Error('Richiesta non valida');
        const data = await response.json();
        renderMqttLog(data.entries || []);
      } catch (err) {
        console.error('Impossibile recuperare il log MQTT', err);
      }
    }

    function openMqttLogModal() {
      if (!mqttLogModal) return;
      mqttLogModal.classList.add('visible');
      mqttLogModal.setAttribute('aria-hidden', 'false');
      refreshMqttLog();
      mqttLogInterval = setInterval(refreshMqttLog, 3000);
    }

    function closeMqttLogModal() {
      if (!mqttLogModal) return;
      mqttLogModal.classList.remove('visible');
      mqttLogModal.setAttribute('aria-hidden', 'true');
      if (mqttLogInterval) {
        clearInterval(mqttLogInterval);
        mqttLogInterval = null;
      }
    }

    if (mqttLogOpenBtn) {
      mqttLogOpenBtn.addEventListener('click', openMqttLogModal);
    }
    if (mqttLogCloseBtn) {
      mqttLogCloseBtn.addEventListener('click', closeMqttLogModal);
    }
    if (mqttLogModal) {
      mqttLogModal.addEventListener('click', (event) => {
        if (event.target === mqttLogModal) closeMqttLogModal();
      });
    }
    stackToggles.forEach((header) => {
      const btn = header.querySelector('.section-toggle-btn, .stack-toggle-btn');
      const content = header.nextElementSibling;
      const card = header.closest('.section-card');
      const chevron = btn ? btn.querySelector('.chevron') : null;
      if (!btn || !content) return;

      const setExpanded = (expanded) => {
        content.classList.toggle('collapsed', !expanded);
        if (card) card.classList.toggle('collapsed', !expanded);
        btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        if (chevron) chevron.textContent = expanded ? '▾' : '▸';
      };

      setExpanded(true);

      const toggle = () => {
        const isExpanded = btn.getAttribute('aria-expanded') === 'true';
        setExpanded(!isExpanded);
      };

      btn.addEventListener('click', (event) => {
        event.stopPropagation();
        toggle();
      });

      header.addEventListener('click', (event) => {
        if (event.target === btn || btn.contains(event.target)) return;
        toggle();
      });
    });

    deselectButtons.forEach((button) => {
      button.addEventListener('click', (event) => {
        event.stopPropagation();
        const stackSection = button.closest('.section-card');
        if (!stackSection) return;

        const checkboxes = Array.from(stackSection.querySelectorAll('input[type="checkbox"]'));
        const shouldSelectAll = checkboxes.some((checkbox) => !checkbox.checked);

        checkboxes.forEach((checkbox) => {
          checkbox.checked = shouldSelectAll;
        });
      });
    });

    function applySafeModeLock(enabled) {
      if (!autodiscoveryForm) return;
      autodiscoveryForm.classList.toggle('safe-locked', enabled);
      autodiscoveryForm.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
        checkbox.disabled = enabled;
      });
      deselectButtons.forEach((button) => {
        button.disabled = enabled;
      });
    }

    const initialSafeMode = window.d2haSafeMode?.enabled ?? ((document.body.dataset.safeMode || '0') === '1');
    applySafeModeLock(initialSafeMode);
    document.addEventListener('safe-mode-changed', (event) => {
      applySafeModeLock(!!event.detail?.enabled);
    });
  </script>
</body>

</html>