<!DOCTYPE html>
<html lang="{{ get_current_lang() }}">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D2HA – Aggiornamenti</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  {% include 'partials/notifications_styles.html' %}
</head>

<body class="theme-{{ get_current_theme() }}" data-safe-mode="{{ '1' if safe_mode_enabled else '0' }}"
  data-performance-mode="{{ '1' if performance_mode_enabled else '0' }}"
  data-debug-mode="{{ '1' if debug_mode_enabled else '0' }}">
  <header>
    <div class="header-shell">
      {% include 'partials/notifications_panel.html' %}
      <nav id="primaryNav" role="navigation">
        <a href="{{ url_for('ui.index') }}" class="tab {{ 'active' if active_page == 'home' else '' }}">Home</a>
        <a href="{{ url_for('ui.containers_view') }}"
          class="tab {{ 'active' if active_page == 'containers' else '' }}">{{
          t("nav.containers") }}</a>
        <a href="{{ url_for('ui.images_view') }}" class="tab {{ 'active' if active_page == 'images' else '' }}">{{
          t("nav.images") }}</a>
        <a href="{{ url_for('ui.volumes_view') }}" class="tab {{ 'active' if active_page == 'volumes' else '' }}">{{
          t("nav.volumes") }}</a>
        <a href="{{ url_for('ui.networks_view') }}" class="tab {{ 'active' if active_page == 'networks' else '' }}">{{
          t("nav.networks") }}</a>
        <a href="{{ url_for('ui.updates') }}" class="tab {{ 'active' if active_page == 'updates' else '' }}">{{
          t("nav.updates") }}</a>
        <a href="{{ url_for('ui.events_view') }}" class="tab {{ 'active' if active_page == 'events' else '' }}">{{
          t("nav.events") }}</a>
        <a href="{{ url_for('ui.autodiscovery_view') }}"
          class="tab {{ 'active' if active_page == 'autodiscovery' else '' }}">{{ t("nav.autodiscovery") }}</a>
        <a href="{{ url_for('auth.logout') }}" class="tab logout-link">{{ t("nav.logout") }}</a>
      </nav>
    </div>
  </header>

  {% include 'partials/flash_messages.html' %}

  <main>
    {% set total = stacks | map(attribute='containers') | map('length') | sum %}
    <section class="section-summary-bar">
      <div>
        <h3>Controllo aggiornamenti</h3>
        <div class="meta">{{ total }} container analizzati · {{ summary.images }} immagini installate</div>
      </div>
      <div class="section-card-actions">
        <div class="performance-hint" id="updates-performance-hint">
          <div>
            <span class="hint-title">Modalità prestazioni attiva</span>
            <p class="small">Per ridurre il carico, la scansione automatica è disattivata. Avvia manualmente quando
              serve.</p>
          </div>
          <button class="btn-chip" type="button" id="updates-scan-btn">Scansiona aggiornamenti</button>
        </div>
      </div>
    </section>
    {% for stack in stacks %}
    <section class="section-card" data-stack="{{ stack.name }}">
      <div class="section-card-header section-toggle" data-stack-toggle>
        <div class="title">
          <button class="section-toggle-btn" type="button" aria-expanded="true" aria-label="Mostra o nascondi sezione">
            <span class="chevron">▾</span>
          </button>
          <span class="stack-title">{{ ('Senza stack' if stack.name == '_no_stack' else stack.name) | upper }}</span>
        </div>
        <div class="section-card-actions">
          <div class="section-card-badge">{{ stack.containers|length }} container</div>
        </div>
      </div>
      <div class="section-card-body stack-body">
        <table class="responsive-table">
          <colgroup>
            <col class="col-name">
            <col class="col-status">
            <col class="col-version">
            <col class="col-version">
            <col class="col-log">
            <col class="col-breaking">
            <col class="col-actions">
          </colgroup>
          <thead>
            <tr>
              <th>{{ t("nav.containers") }}</th>
              <th>Stato</th>
              <th>Vers. installata</th>
              <th>Vers. remota</th>
              <th>Change log</th>
              <th>Breaking</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody>
            {% for c in stack.containers %}
            <tr class="container-row" data-container-id="{{ c.id }}">
              {% set installed_display = c.installed_display_version or c.installed_version or c.installed_tag or
              c.installed_id_short %}
              {% set remote_display = c.remote_display_version or c.remote_version or c.remote_tag or c.remote_id_short
              %}
              <td data-label="Container">
                <div><strong>{{ c.name }}</strong></div>
                <div class="small">{{ c.image_ref }}</div>
                <div class="small">Stack: {{ 'no stack' if c.stack == '_no_stack' else c.stack }}</div>
              </td>
              <td data-label="Stato">
                {% set state = c.update_state %}
                {% set status_class = "status-pill " %}
                {% if state == 'update_available' %}
                {% set status_class = status_class + 'status-update-available' %}
                {% set status_label = 'Update disponibile' %}
                {% elif state == 'up_to_date' %}
                {% set status_class = status_class + 'status-up-to-date' %}
                {% set status_label = 'Aggiornato' %}
                {% else %}
                {% set status_class = status_class + 'status-unknown' %}
                {% set status_label = 'Sconosciuto' %}
                {% endif %}
                <div class="status-meta">
                  <span class="{{ status_class }}" data-status-pill>{{ status_label }}</span>
                </div>
              </td>
              <td data-label="Vers. installata">
                <div class="pill-row">
                  <span class="badge" data-installed-tag>{{ installed_display or 'n/d' }}</span>
                  <span class="small" data-installed-id>{{ c.installed_id_short }}</span>
                </div>
              </td>
              <td data-label="Vers. remota">
                <div class="pill-row">
                  <span class="badge {% if not remote_display %}badge-null{% endif %}" data-remote-tag>{{ remote_display
                    or 'n/d' }}</span>
                  <span class="small" data-remote-id style="{% if not c.remote_id_short %}display:none{% endif %}">{{
                    c.remote_id_short or '' }}</span>
                </div>
              </td>
              <td data-label="Change log">
                {% if c.changelog %}
                <div class="changelog-container" data-changelog-container>
                  <div class="changelog-preview" data-changelog>{{ c.changelog[:500] }}{% if c.changelog|length > 500
                    %}...{% endif %}</div>
                  {% if c.changelog_url %}
                  <a href="{{ c.changelog_url }}" target="_blank" rel="noopener" class="changelog-link small">Vedi
                    release notes ↗</a>
                  {% endif %}
                </div>
                {% else %}
                <span class="small" data-changelog>Nessuna nota</span>
                {% endif %}
              </td>
              <td data-label="Breaking">
                {% if c.breaking_changes %}
                <div class="breaking-container" data-breaking-container>
                  <div class="breaking" data-breaking>{{ c.breaking_changes[:500] }}{% if c.breaking_changes|length >
                    500 %}...{% endif %}</div>
                </div>
                {% else %}
                <span class="small" data-breaking>Nessuna info</span>
                {% endif %}
              </td>
              <td class="actions-cell" data-label="Azioni">
                <div class="actions">
                  <form class="full-update-form" data-container-name="{{ c.name }}" data-container-id="{{ c.id }}"
                    method="post" action="#" data-safe-confirm="Aggiornare l'immagine di {{ c.name }}?"
                    data-safe-modal="external">
                    <button class="btn-primary-glow" type="submit">Aggiorna immagine</button>
                  </form>
                  <div class="field" style="margin-top: 8px;">
                    <label class="small" for="track-{{ c.id }}">Tag da monitorare</label>
                    <div class="input-row">
                      <input id="track-{{ c.id }}" class="input" type="text" list="track-options"
                        data-update-track="{{ c.id }}" value="{{ c.check_tag or '' }}"
                        placeholder="Es: latest, nightly" />
                      <button type="button" class="inline-btn" data-save-track
                        data-container-id="{{ c.id }}">Salva</button>
                    </div>
                    <div class="small" data-track-feedback="{{ c.id }}">{{ 'Controllo su "' ~ c.check_tag ~ '"' if
                      c.check_tag else 'Usa il tag configurato nel container' }}</div>
                  </div>
                  <div class="small">ID: <code>{{ c.id }}</code></div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
    {% endfor %}
  </main>

  <datalist id="track-options">
    <option value="latest"></option>
    <option value="stable"></option>
    <option value="dev"></option>
    <option value="nightly"></option>
  </datalist>

  <div class="debug-overlay" id="debug-overlay" aria-hidden="true">
    <div class="debug-panel">
      <div class="debug-header">
        <div>
          <div class="debug-eyebrow">Debug live</div>
          <div class="debug-title" id="debug-title">Stream aggiornamento</div>
        </div>
        <div class="debug-actions">
          <button class="inline-btn" type="button" id="debug-clear">Pulisci</button>
          <button class="inline-btn" type="button" id="debug-close">Chiudi</button>
        </div>
      </div>
      <div class="debug-body">
        <div class="debug-column">
          <div class="debug-subtitle">Comandi</div>
          <div class="debug-list" id="debug-commands"></div>
        </div>
        <div class="debug-column">
          <div class="debug-subtitle">Log live</div>
          <div class="debug-log" id="debug-logs"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="safe-confirm-backdrop" id="confirm-modal">
    <div class="safe-confirm-modal">
      <h3 class="safe-confirm-title" id="confirm-title">Aggiornare l'immagine?</h3>
      <p id="confirm-message" class="safe-confirm-message small"></p>
      <div id="confirm-loading" class="confirm-loading" style="display: none;">
        <div class="spinner"></div>
        <p class="loading-text">Aggiornamento in corso...</p>
        <p class="loading-hint small">Pull immagine, rimozione e ricreazione container</p>
      </div>
      <p id="confirm-result" class="confirm-result small" style="display: none;"></p>
      <div class="safe-confirm-actions" id="confirm-actions">
        <button type="button" class="btn btn-secondary" id="cancel-confirm">Annulla</button>
        <button type="button" class="btn btn-accent" id="confirm-continue" data-safe-confirm="true">Procedi</button>
      </div>
    </div>
  </div>


  {% include 'partials/notifications_script.html' %}
  <script>
    const statusClasses = {
      update_available: 'status-update-available',
      up_to_date: 'status-up-to-date',
      unknown: 'status-unknown'
    };
    const updatesHint = document.getElementById('updates-performance-hint');
    const manualScanBtn = document.getElementById('updates-scan-btn');
    const pollingDefaults = { intervalMs: 20000 };
    const pollingPerformance = { intervalMs: 45000 };
    let refreshIntervalMs = pollingDefaults.intervalMs;
    let refreshTimer = null;
    let autoScanEnabled = !(window.d2haSettings?.performanceMode);
    const debugOverlay = document.getElementById('debug-overlay');
    const debugTitle = document.getElementById('debug-title');
    const debugCommands = document.getElementById('debug-commands');
    const debugLogs = document.getElementById('debug-logs');
    const debugClose = document.getElementById('debug-close');
    const debugClear = document.getElementById('debug-clear');
    const debugEnabled = document.body.dataset.debugMode === '1';
    const debugStreamSupported = debugEnabled && typeof EventSource !== 'undefined';
    let activeDebugStream = null;

    const safeParseEvent = (evt) => {
      try { return JSON.parse(evt.data); }
      catch (e) { return {}; }
    };

    const clearDebugOverlay = () => {
      debugCommands.innerHTML = '';
      debugLogs.innerHTML = '';
    };

    const openDebugOverlay = (title) => {
      if (!debugStreamSupported) return;
      clearDebugOverlay();
      debugTitle.textContent = title;
      debugOverlay.classList.add('visible');
      debugOverlay.setAttribute('aria-hidden', 'false');
    };

    const closeDebugOverlay = () => {
      if (activeDebugStream) {
        activeDebugStream.close();
        activeDebugStream = null;
      }
      debugOverlay.classList.remove('visible');
      debugOverlay.setAttribute('aria-hidden', 'true');
    };

    const pushCommand = (text) => {
      if (!debugEnabled) return;
      const row = document.createElement('div');
      row.className = 'command';
      row.textContent = text;
      debugCommands.appendChild(row);
      debugCommands.scrollTop = debugCommands.scrollHeight;
    };

    const pushLog = (text, tag = 'LOG') => {
      if (!debugEnabled) return;
      const row = document.createElement('div');
      row.className = 'debug-log-line';
      const badge = document.createElement('span');
      badge.className = 'tag';
      badge.textContent = tag;
      const body = document.createElement('span');
      body.className = 'text';
      body.textContent = text;
      row.appendChild(badge);
      row.appendChild(body);
      debugLogs.appendChild(row);
      debugLogs.scrollTop = debugLogs.scrollHeight;
    };

    const stackToggles = Array.from(document.querySelectorAll('[data-stack-toggle]'));
    stackToggles.forEach((header) => {
      const btn = header.querySelector('.section-toggle-btn, .stack-toggle-btn');
      const content = header.nextElementSibling;
      const card = header.closest('.section-card');
      const chevron = btn ? btn.querySelector('.chevron') : null;
      if (!btn || !content) return;

      const setExpanded = (expanded) => {
        content.classList.toggle('collapsed', !expanded);
        if (card) card.classList.toggle('collapsed', !expanded);
        btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        if (chevron) chevron.textContent = expanded ? '▾' : '▸';
      };

      setExpanded(true);

      const toggle = () => {
        const isExpanded = btn.getAttribute('aria-expanded') === 'true';
        setExpanded(!isExpanded);
      };

      btn.addEventListener('click', (event) => {
        event.stopPropagation();
        toggle();
      });

      header.addEventListener('click', (event) => {
        if (event.target === btn || btn.contains(event.target)) return;
        toggle();
      });
    });

    const trackButtons = Array.from(document.querySelectorAll('[data-save-track]'));

    function applyStatus(row, state) {
      const pill = row.querySelector('[data-status-pill]');
      if (!pill) return;
      pill.classList.remove('status-update-available', 'status-up-to-date', 'status-unknown');
      pill.classList.add(statusClasses[state] || 'status-unknown');

      let label = 'Sconosciuto';
      if (state === 'update_available') label = 'Update disponibile';
      else if (state === 'up_to_date') label = 'Aggiornato';
      pill.textContent = label;
    }

    async function refreshRow(row) {
      const id = row.dataset.containerId;
      try {
        const res = await fetch(`/api/containers/${id}/updates`, { method: 'POST' });
        if (!res.ok) return;
        const data = await res.json();
        applyStatus(row, data.update_state);

        const installedEl = row.querySelector('[data-installed-tag]');
        const installedIdEl = row.querySelector('[data-installed-id]');
        const remoteEl = row.querySelector('[data-remote-tag]');
        const remoteIdEl = row.querySelector('[data-remote-id]');

        if (installedEl) {
          const installedDisplay =
            data.installed_display_version ||
            data.installed_version ||
            data.installed_tag ||
            data.installed_id_short;
          installedEl.textContent = installedDisplay || 'n/d';
        }
        if (installedIdEl) installedIdEl.textContent = data.installed_id_short || '';

        if (remoteEl) {
          const remoteDisplay =
            data.remote_display_version ||
            data.remote_version ||
            data.remote_tag ||
            data.remote_id_short;
          remoteEl.textContent = remoteDisplay || 'n/d';
          remoteEl.classList.toggle('badge-null', !remoteDisplay);
        }

        if (remoteIdEl) {
          if (data.remote_id_short) {
            remoteIdEl.textContent = data.remote_id_short;
            remoteIdEl.style.display = 'inline';
          } else {
            remoteIdEl.textContent = '';
            remoteIdEl.style.display = 'none';
          }
        }

        const feedback = row.querySelector('[data-track-feedback]');
        if (feedback) {
          if (data.check_tag) {
            feedback.textContent = `Controllo su "${data.check_tag}"`;
          } else {
            feedback.textContent = 'Usa il tag configurato nel container';
          }
        }
      } catch (e) {
        // silently ignore
      }
    }

    function scheduleRefresh() {
      const rows = Array.from(document.querySelectorAll('.container-row'));
      rows.forEach(row => refreshRow(row));
    }

    function startUpdateDebugStream(containerId, containerName) {
      if (!debugStreamSupported) return Promise.reject(new Error('Debug disabilitato'));

      return new Promise((resolve, reject) => {
        openDebugOverlay(`PULL – ${containerName || containerId}`);
        pushCommand(`Richiesta aggiornamento per ${containerName || containerId}`);

        const source = new EventSource(`/api/containers/${containerId}/actions/pull/stream`);
        activeDebugStream = source;
        let ended = false;

        source.addEventListener('command', (evt) => {
          const data = safeParseEvent(evt);
          if (data?.message) pushCommand(data.message);
        });

        source.addEventListener('status', (evt) => {
          const data = safeParseEvent(evt);
          if (data?.state) pushLog(`Stato: ${data.state}`, 'STAT');
        });

        source.addEventListener('log', (evt) => {
          const data = safeParseEvent(evt);
          if (data?.line) pushLog(data.line, 'LOG');
        });

        source.addEventListener('result', () => {
          const row = document.querySelector(`[data-container-id="${containerId}"]`);
          if (row) refreshRow(row);
        });

        source.addEventListener('end', () => {
          ended = true;
          pushLog('Stream concluso', 'DONE');
          source.close();
          activeDebugStream = null;
          resolve();
        });

        source.addEventListener('error', () => {
          pushLog('Stream interrotto', 'ERR');
          source.close();
          activeDebugStream = null;
          if (!ended) reject(new Error('Stream interrotto'));
        });
      });
    }
    function startUpdatesPolling() {
      clearInterval(refreshTimer);
      if (!autoScanEnabled) return;
      scheduleRefresh();
      refreshTimer = setInterval(scheduleRefresh, refreshIntervalMs);
    }

    manualScanBtn?.addEventListener('click', () => {
      scheduleRefresh();
    });

    window.registerPerformanceHandler?.((enabled) => {
      refreshIntervalMs = enabled ? pollingPerformance.intervalMs : pollingDefaults.intervalMs;
      autoScanEnabled = !enabled;
      updatesHint?.classList.toggle('visible', enabled);
      startUpdatesPolling();
    });

    startUpdatesPolling();

    const modal = document.getElementById('confirm-modal');
    const messageEl = document.getElementById('confirm-message');
    const cancelBtn = document.getElementById('cancel-confirm');
    const confirmBtn = document.getElementById('confirm-continue');
    const confirmTitle = document.getElementById('confirm-title');
    const confirmLoading = document.getElementById('confirm-loading');
    const confirmResult = document.getElementById('confirm-result');
    const confirmActions = document.getElementById('confirm-actions');
    let pendingForm = null;

    function resetModalState() {
      messageEl.style.display = 'block';
      confirmLoading.style.display = 'none';
      confirmResult.style.display = 'none';
      confirmActions.style.display = 'flex';
      confirmResult.className = 'confirm-result small';
      confirmTitle.textContent = "Aggiornare l'immagine?";
    }

    function showModalLoading() {
      messageEl.style.display = 'none';
      confirmLoading.style.display = 'block';
      confirmResult.style.display = 'none';
      confirmActions.style.display = 'none';
      confirmTitle.textContent = 'Aggiornamento in corso';
    }

    function showModalResult(success, message) {
      confirmLoading.style.display = 'none';
      confirmResult.style.display = 'block';
      confirmResult.className = `confirm-result small ${success ? 'success' : 'error'}`;
      confirmResult.textContent = message;
      confirmActions.style.display = 'flex';
      cancelBtn.textContent = 'Chiudi';
      confirmBtn.style.display = 'none';
      confirmTitle.textContent = success ? 'Aggiornamento completato' : 'Errore';
    }

    function openConfirm(form) {
      pendingForm = form;
      resetModalState();
      cancelBtn.textContent = 'Annulla';
      confirmBtn.style.display = 'inline-flex';
      const name = form.dataset.containerName || 'questo container';
      messageEl.textContent = `Vuoi aggiornare l'immagine di "${name}"?`;
      modal.classList.add('visible');
    }

    function closeConfirm() {
      pendingForm = null;
      modal.classList.remove('visible');
    }

    document.querySelectorAll('.full-update-form').forEach(form => {
      form.addEventListener('submit', (evt) => {
        evt.preventDefault();
        openConfirm(form);
      });
    });

    trackButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.containerId;
        const input = document.querySelector(`[data-update-track="${id}"]`);
        const feedback = document.querySelector(`[data-track-feedback="${id}"]`);
        if (!id || !input) return;

        const tag = input.value.trim();
        if (feedback) feedback.textContent = 'Salvataggio...';

        try {
          const res = await fetch(`/api/containers/${id}/updates/track`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tag }),
          });

          if (!res.ok) throw new Error('failed');
          await refreshRow(btn.closest('.container-row'));
        } catch (err) {
          if (feedback) feedback.textContent = 'Errore nel salvataggio';
        }
      });
    });

    debugClose?.addEventListener('click', closeDebugOverlay);
    debugClear?.addEventListener('click', clearDebugOverlay);
    debugOverlay?.addEventListener('click', (evt) => {
      if (evt.target === debugOverlay) closeDebugOverlay();
    });

    cancelBtn.addEventListener('click', closeConfirm);
    modal.addEventListener('click', (evt) => {
      if (evt.target === modal) closeConfirm();
    });

    confirmBtn.addEventListener('click', async () => {
      if (!pendingForm) return;

      const containerId = pendingForm.dataset.containerId;
      const containerName = pendingForm.dataset.containerName || 'container';

      // Show loading state
      showModalLoading();

      if (debugStreamSupported && containerId) {
        try {
          await startUpdateDebugStream(containerId, containerName);
          closeConfirm();
          return;
        } catch (err) {
          console.warn('Stream debug non disponibile, procedo con API POST', err);
        }
      }

      // Fallback: use POST API endpoint
      if (containerId) {
        try {
          const res = await fetch(`/api/containers/${containerId}/full_update`, { method: 'POST' });
          const data = await res.json();

          const row = document.querySelector(`[data-container-id="${containerId}"]`);

          if (data.success) {
            if (row) refreshRow(row);
            showModalResult(true, `Container "${containerName}" aggiornato con successo!`);
          } else {
            console.error('Update failed:', data.error);
            showModalResult(false, data.error || 'Errore durante l\'aggiornamento');
          }
        } catch (err) {
          console.error('Update request failed:', err);
          showModalResult(false, 'Errore di connessione al server');
        }
      } else {
        showModalResult(false, 'ID container non valido');
      }
    });
  </script>
</body>

</html>