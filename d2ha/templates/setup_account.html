{% extends "layouts/auth_base.html" %}
{% block title %}D2HA â€“ Primo accesso{% endblock %}

{% block auth_content %}
  <h1>{{ t('setup_account.heading') }}</h1>
  <p>{{ t('setup_account.intro')|safe }}</p>
  <p>{{ t('setup_account.tips_title') }}</p>
  <ul>
    <li>{{ t('setup_account.tip_length') }}</li>
    <li>{{ t('setup_account.tip_unique') }}</li>
    <li>{{ t('setup_account.tip_username').format(current_username=current_username) }}</li>
  </ul>

  {% include 'partials/flash_messages.html' %}

  <form method="post" autocomplete="off">
    <div>
      <label for="new_username">{{ t('setup_account.new_username') }}</label>
      <input type="text" id="new_username" name="new_username" placeholder="{{ current_username }}" />
    </div>
    <div>
      <label for="new_password">{{ t('setup_account.new_password') }}</label>
      <div class="password-input-wrapper">
        <input type="password" id="new_password" name="new_password" required />
        <button type="button" class="password-toggle" aria-label="{{ t('password.toggle.show') }}" title="{{ t('password.toggle.show') }}">ğŸ‘</button>
      </div>
      <div id="passwordStrength" class="password-hint" aria-live="polite"></div>
    </div>
    <div>
      <label for="new_password_confirm">{{ t('setup_account.confirm_password') }}</label>
      <div class="password-input-wrapper">
        <input type="password" id="new_password_confirm" name="new_password_confirm" required />
        <button type="button" class="password-toggle" aria-label="{{ t('password.toggle.show') }}" title="{{ t('password.toggle.show') }}">ğŸ‘</button>
      </div>
      <div id="passwordMatch" class="password-hint" aria-live="polite"></div>
    </div>
    <button type="submit" class="btn">{{ t('setup_account.submit') }}</button>
  </form>
{% endblock %}

{% block auth_scripts %}
  <script>
    const strengthLabel = document.getElementById('passwordStrength');
    const matchLabel = document.getElementById('passwordMatch');
    const passwordInput = document.getElementById('new_password');
    const confirmInput = document.getElementById('new_password_confirm');
    const strengthTexts = {
      weak: '{{ t('password.strength.weak') }}',
      medium: '{{ t('password.strength.medium') }}',
      strong: '{{ t('password.strength.strong') }}',
    };
    const strengthPrefix = '{{ t('password.strength.label') }}';
    const matchText = '{{ t('password.match') }}';
    const mismatchText = '{{ t('password.mismatch') }}';
    const showLabel = '{{ t('password.toggle.show') }}';
    const hideLabel = '{{ t('password.toggle.hide') }}';

    function enhancePasswordInputs() {
      document.querySelectorAll('input[type="password"]').forEach((input) => {
        if (input.closest('.password-input-wrapper')) return;

        const wrapper = document.createElement('div');
        wrapper.className = 'password-input-wrapper';
        input.parentNode.insertBefore(wrapper, input);
        wrapper.appendChild(input);

        const toggle = document.createElement('button');
        toggle.type = 'button';
        toggle.className = 'password-toggle';
        toggle.setAttribute('aria-label', showLabel);
        toggle.title = showLabel;
        toggle.textContent = 'ğŸ‘';
        toggle.addEventListener('click', () => {
          const isHidden = input.type === 'password';
          input.type = isHidden ? 'text' : 'password';
          toggle.setAttribute('aria-label', isHidden ? hideLabel : showLabel);
          toggle.title = isHidden ? hideLabel : showLabel;
          toggle.textContent = isHidden ? 'ğŸ™ˆ' : 'ğŸ‘';
        });

        wrapper.appendChild(toggle);
      });
    }

    function evaluateStrength(password) {
      if (!password) return null;
      let score = 0;
      if (password.length >= 10) score += 1;
      if (/[A-Z]/.test(password) && /[a-z]/.test(password)) score += 1;
      if (/\d/.test(password)) score += 1;
      if (/[^A-Za-z0-9]/.test(password)) score += 1;

      if (score >= 3) return 'strong';
      if (score === 2) return 'medium';
      return 'weak';
    }

    function updateStrength() {
      const value = passwordInput.value.trim();
      const level = evaluateStrength(value);
      strengthLabel.textContent = '';
      strengthLabel.className = 'password-hint';

      if (level) {
        strengthLabel.textContent = `${strengthPrefix}: ${strengthTexts[level]}`;
        strengthLabel.classList.add(`strength-${level}`);
      }
    }

    function updateMatch() {
      const password = passwordInput.value.trim();
      const confirm = confirmInput.value.trim();
      matchLabel.textContent = '';
      matchLabel.className = 'password-hint';

      if (!confirm) return;

      if (password && password === confirm) {
        matchLabel.textContent = matchText;
        matchLabel.classList.add('strength-strong');
      } else {
        matchLabel.textContent = mismatchText;
        matchLabel.classList.add('strength-weak');
      }
    }

    enhancePasswordInputs();
    passwordInput.addEventListener('input', () => {
      updateStrength();
      updateMatch();
    });
    confirmInput.addEventListener('input', updateMatch);
  </script>
{% endblock %}
