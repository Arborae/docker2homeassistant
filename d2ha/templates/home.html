{% extends "layouts/app_base.html" %}
{% set page_title = 'D2HA – Home' %}

{% block page_styles %}
  <style>
:root {
      --bg: var(--color-bg);
      --panel: var(--color-surface);
      --panel-2: var(--color-surface-muted);
      --accent: var(--color-accent);
      --accent-2: var(--color-accent-2);
      --accent-gradient: var(--gradient-accent);
      --accent-glow: var(--color-accent-glow);
      --accent-glow-soft: var(--color-accent-glow-soft);
      --accent-border-strong: var(--color-border-strong);
      --accent-border: var(--color-border);
      --accent-border-soft: var(--color-border-soft);
      --accent-surface: var(--color-accent-surface);
      --text: var(--color-text);
      --muted: var(--color-muted);
      --border: var(--color-border);
      --shadow: var(--shadow-md);
      --header-bg: var(--color-surface);
      --stack-header-bg: var(--color-surface-muted);
      --control-surface: var(--color-surface-alt);
      --text-on-accent: var(--color-on-accent);
      --frosted-weak: color-mix(in srgb, var(--color-text) 8%, transparent);
      --frosted-strong: color-mix(in srgb, var(--color-text) 12%, transparent);
      --frosted-intense: color-mix(in srgb, var(--color-text) 18%, transparent);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 10% 20%, color-mix(in srgb, var(--accent) 12%, transparent), transparent 25%),
                  radial-gradient(circle at 90% 10%, color-mix(in srgb, var(--accent-2) 12%, transparent), transparent 20%),
                  var(--bg);
      color: var(--text);
    }
    a { color: inherit; text-decoration: none; }
    header {
      background: var(--header-bg);
      border-bottom: 1px solid var(--border);
      padding: 16px 22px 12px;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: var(--shadow);
    }
    .brand-line {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .brand-line h1 {
      margin: 0;
      font-size: 1.35rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      text-align: center;
    }
    .brand-pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--accent-surface);
      color: var(--accent);
      font-size: 0.8rem;
      letter-spacing: 0.04em;
    }
    nav {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 8px 14px;
      border-radius: 8px;
      background: var(--frosted-weak);
      color: var(--muted);
      font-weight: 600;
      border: 1px solid transparent;
      transition: all 0.15s ease;
    }
    .tab:hover { color: var(--text); border-color: var(--border); }
    .tab.active {
      background: var(--accent-gradient);
      color: var(--text-on-accent);
      box-shadow: 0 6px 18px var(--accent-glow);
    }
    .logout-link {
      margin-left: auto;
      background: var(--accent-gradient);
      color: var(--text-on-accent);
      box-shadow: 0 6px 18px var(--accent-glow-soft);
    }
    .layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      padding: 18px;
      min-height: calc(100vh - 110px);
    }
    aside {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .aside-title {
      margin: 0 0 10px;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }
    details {
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 10px;
      padding: 10px 12px;
      transition: border-color 0.15s ease;
    }
    details[open] { border-color: var(--accent-border); }
    summary {
      cursor: pointer;
      list-style: none;
      font-weight: 700;
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    summary::-webkit-details-marker { display: none; }
    .stack-chip {
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      font-size: 0.78rem;
      color: var(--muted);
    }
    .container-list {
      margin: 10px 0 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .stack-container-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      font-size: 0.92rem;
      min-height: 56px;
    }
    .stack-container-main {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }
    .stack-container-main small { color: var(--muted); }
    .container-actions { display: inline-flex; align-items: center; gap: 10px; flex-shrink: 0; }
    .log-link {
      width: 26px;
      height: 26px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      transition: all 0.15s ease;
    }
    .log-link:hover {
      color: var(--accent);
      border-color: var(--accent-border);
      background: var(--accent-surface);
    }
    .log-link svg { width: 16px; height: 16px; fill: currentColor; }
    .modal-backdrop { position: fixed; inset:0; background: rgba(0,0,0,0.65); display:none; align-items:center; justify-content:center; z-index: 50; padding:20px; }
    .modal-backdrop.visible { display:flex; }
    .modal { background: var(--panel-2); border:1px solid var(--border); border-radius:16px; width:min(960px, 100%); height:72vh; max-height:72vh; overflow:hidden; box-shadow: var(--shadow); display:flex; flex-direction:column; }
    .modal-header { display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--border); background: var(--stack-header-bg); }
    .modal-title { font-weight:800; font-size:1rem; letter-spacing:0.02em; }
    .modal-close { background:none; border:none; color:var(--muted); font-size:1.2rem; cursor:pointer; }
    .modal-body { padding:16px; overflow-y:auto; flex:1; display:flex; flex-direction:column; gap:12px; min-height:0; }
    .inline-controls { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .inline-controls .inline-btn { padding:8px 12px; border-radius:10px; border:1px solid var(--border); background: var(--control-surface); color: var(--text); cursor:pointer; transition: all 0.15s ease; }
    .inline-controls .inline-btn:hover { border-color: var(--accent-border); color: var(--accent); box-shadow: 0 6px 18px var(--accent-glow-soft); }
    .select { background: var(--control-surface); color: var(--text); border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:0.9rem; }
    .logs-area { background: var(--control-surface); color: var(--text); border:1px solid var(--border); border-radius:12px; padding:10px; font-family:"JetBrains Mono", monospace; font-size:0.85rem; max-height:100%; overflow:auto; white-space:pre-wrap; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.02); }
    .logs-area .log-line { padding:4px 8px; border-left:3px solid transparent; margin-bottom:2px; border-radius:8px; display:flex; gap:8px; align-items:flex-start; }
    .logs-area .log-line:last-child { margin-bottom:0; }
    .logs-area .log-bullet { opacity:0.4; }
    .logs-area .log-info { border-color: var(--accent); background: var(--color-accent-surface); }
    .logs-area .log-warn { border-color: var(--color-warn); background: var(--color-warn-surface); }
    .logs-area .log-error { border-color: var(--color-error); background: var(--color-error-surface); }
    .logs-area .log-debug { border-color: var(--muted); background: var(--frosted-weak); color: var(--text); }
    .logs-area .log-other { border-color: var(--border); }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    .status-indicator {
      width: 26px;
      height: 26px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      flex-shrink: 0;
    }
    .status-indicator::before {
      content: "";
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: block;
    }
    .status-running { background: var(--color-success-surface); color: var(--color-success); }
    .status-stopped { background: var(--color-error-surface); color: var(--color-error); }
    .status-paused { background: var(--color-warn-surface); color: var(--color-warn); }
    .status-indicator.status-running::before { background: var(--color-success); box-shadow: 0 0 0 4px color-mix(in srgb, var(--color-success) 24%, transparent); }
    .status-indicator.status-stopped::before { background: var(--color-error); box-shadow: 0 0 0 4px color-mix(in srgb, var(--color-error) 24%, transparent); }
    .status-indicator.status-paused::before { background: var(--color-warn); box-shadow: 0 0 0 4px color-mix(in srgb, var(--color-warn) 24%, transparent); }
    main {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow: var(--shadow);
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }
    .metric {
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .metric .label { color: var(--muted); font-size: 0.95rem; line-height: 1.3; letter-spacing: 0.01em; }
    .metric .value { font-size: 1.6rem; font-weight: 750; margin-top: 2px; line-height: 1.25; }
    .metric .muted { font-size: 0.95rem; line-height: 1.35; }
    .muted { color: var(--muted); font-size: 0.88rem; }
    .bar {
      height: 8px;
      background: rgba(255,255,255,0.08);
      border-radius: 999px;
      overflow: hidden;
      margin-top: 10px;
    }
    .bar span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      width: 0;
      transition: width 0.4s ease;
    }
    .stack-tiles {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }
    .tile {
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }
    .tile h3 { margin: 0 0 8px; font-size: 1rem; }
    .flex-between { display: flex; justify-content: space-between; align-items: center; }
    .chart-box {
      aspect-ratio: 1 / 1;
      padding: 6px;
      border-radius: 10px;
      background: radial-gradient(circle at 20% 20%, rgba(49,196,255,0.06), transparent 35%),
                  radial-gradient(circle at 80% 10%, rgba(124,255,195,0.05), transparent 30%),
                  rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.04);
    }
    .chart-box canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
      aspect-ratio: 1 / 1;
      image-rendering: optimizeQuality;
      image-rendering: -webkit-optimize-contrast;
    }
    .chart-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
      margin-top: 8px;
      align-items: stretch;
    }
    .chart-row canvas {
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      padding: 6px;
      width: 100% !important;
      height: 100% !important;
      aspect-ratio: 16 / 9;
      display: block;
      border: 1px solid rgba(255,255,255,0.04);
      image-rendering: optimizeQuality;
      image-rendering: -webkit-optimize-contrast;
    }
    .chart-caption {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 0.9rem;
      line-height: 1.35;
      margin-top: 4px;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }
    .dot.accent { background: var(--accent); }
    .dot.success { background: var(--color-success); }
    .dot.warn { background: var(--color-warn); }
    .dot.error { background: var(--color-error); }
    .dot.surface { background: var(--panel-2); border: 1px solid var(--border); }
    @media (max-width: 960px) {
      .layout { grid-template-columns: 1fr; }
    }
  </style>
{% endblock %}

{% block page_content %}
<div class="card">
        <div class="flex-between">
          <div>
            <h2 style="margin:6px 0 0;">{{ t('home.server_status') }}</h2>
          </div>
          <span class="brand-pill">{{ summary.stacks }} {{ t('home.stacks_title')|lower }}</span>
        </div>
        <div class="metrics-grid" style="margin-top:12px;">
          <div class="metric">
            <div class="label">CPU</div>
            <div class="value" id="cpuValue">{{ summary.total_cpu }}% {{ t('home.total_label') }}</div>
            <div class="muted" id="cpuCores">{{ summary.cpu_count }} core</div>
            <div class="chart-box">
              <canvas id="cpuChart"></canvas>
            </div>
            <div class="chart-caption">
              <span class="dot accent"></span>
              <span>{{ t('home.cpu_caption') }}</span>
            </div>
          </div>
          <div class="metric">
            <div class="label">RAM</div>
            <div class="value" id="ramValue">{{ summary.mem_percent }}%</div>
            <div class="muted" id="ramUsage">{{ summary.mem_used_h }} / {{ summary.mem_total_h }}</div>
            <div class="bar"><span id="ramBar" style="width: {{ summary.mem_percent }}%"></span></div>
            <div class="chart-box">
              <canvas id="ramChart"></canvas>
            </div>
            <div class="chart-caption">
              <span class="dot success"></span>
              <span>{{ t('home.ram_caption') }}</span>
            </div>
          </div>
          <div class="metric">
            <div class="label">{{ t("nav.containers") }}</div>
            <div class="value" id="containerValue">{{ summary.running }}/{{ summary.total_containers }}</div>
            <div class="muted" id="containerStatus">{{ summary.paused }} {{ t('home.paused') }} · {{ summary.stopped }} {{ t('home.stopped') }}</div>
            <div class="chart-box">
              <canvas id="containersChart"></canvas>
            </div>
            <div class="chart-caption">
              <span class="dot success"></span>{{ t('home.legend.running') }}
              <span class="dot warn"></span>{{ t('home.legend.paused') }}
              <span class="dot error"></span>{{ t('home.legend.stopped') }}
            </div>
          </div>
          <div class="metric">
            <div class="label">{{ t("nav.images") }}</div>
            <div class="value" id="imagesValue">{{ summary.images }}</div>
            <div class="muted" id="imagesDetail">Disk layers: {{ summary.disk_layers_h }}</div>
            <div class="chart-box">
              <canvas id="imagesChart"></canvas>
            </div>
            <div class="chart-caption">
              <span class="dot accent"></span>{{ t('home.legend.in_use') }}
              <span class="dot surface"></span>{{ t('home.legend.not_in_use') }}
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="flex-between">
          <h2 style="margin:0;">{{ t('home.stacks_title') }}</h2>
        </div>
        <div class="stack-tiles" style="margin-top:12px;">
          {% for stack in stacks %}
            {% set cpu = stack.containers|sum(attribute='cpu_percent') %}
            {% set mem = stack.containers|sum(attribute='mem_usage_bytes') %}
            <div class="tile">
              <div class="flex-between">
                <h3>{{ t('home.no_stack') if stack.name == '_no_stack' else stack.name }}</h3>
                <span class="stack-chip">{{ stack.containers|length }} {{ t('home.stack_container_label') }}</span>
              </div>
              <div class="muted">CPU: {{ '%.1f' % cpu }}% · RAM: {{ human_bytes(mem) }}</div>
              {% set cpu_bar = [cpu, 100]|min %}
              <div class="bar"><span style="width: {{ cpu_bar }}%"></span></div>
              {% set stack_slug = (stack.name | lower | replace(' ', '-') | replace('.', '-') | replace('_', '-')) %}
              <div class="muted" id="stack-{{ stack_slug }}-net-text">{{ t('home.network') }}: {{ stack.total_net_rx_h }} ↓ · {{ stack.total_net_tx_h }} ↑</div>
              <div class="chart-row">
                <canvas id="stack-{{ stack_slug }}-cpu"></canvas>
                <canvas id="stack-{{ stack_slug }}-mem"></canvas>
                <canvas id="stack-{{ stack_slug }}-net"></canvas>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </main>
  </div>

  <div class="modal-backdrop" id="home-log-modal" aria-hidden="true">
    <div class="modal log-only-modal">
      <div class="modal-header">
        <div class="modal-title" id="home-log-title">{{ t('home.log.title') }}</div>
        <button class="modal-close" id="home-log-close" aria-label="{{ t('home.log.close') }}">✕</button>
      </div>
      <div class="modal-body">
        <div class="inline-controls">
          <label class="muted"><input type="checkbox" id="home-log-auto" checked> {{ t('home.log.auto') }}</label>
          <label class="muted">{{ t('home.log.lines') }}
            <select id="home-log-tail" class="select">
              <option value="10">10</option>
              <option value="50">50</option>
              <option value="100" selected>100</option>
              <option value="150">150</option>
              <option value="500">500</option>
              <option value="all">{{ t('home.log.unlimited') }}</option>
            </select>
          </label>
          <label class="muted">{{ t('home.log.severity') }}
            <select id="home-log-severity" class="select">
              <option value="all" selected>{{ t('home.log.all') }}</option>
              <option value="error">{{ t('home.log.errors') }}</option>
              <option value="warn">{{ t('home.log.warnings') }}</option>
              <option value="info">{{ t('home.log.info') }}</option>
              <option value="debug">{{ t('home.log.debug') }}</option>
              <option value="other">{{ t('home.log.other') }}</option>
            </select>
          </label>
          <button class="inline-btn" id="home-log-refresh">{{ t('home.log.refresh') }}</button>
        </div>
        <pre class="logs-area" id="home-log-output">{{ t('home.log.placeholder') }}</pre>
      </div>
    </div>
  </div>

{% endblock %}

{% block page_scripts %}
  <script>
const initialData = {{ {"summary": summary, "stacks": stacks}|tojson }};
    const homeText = {
      totalLabel: "{{ t('home.total_label') }}",
      paused: "{{ t('home.paused') }}",
      stopped: "{{ t('home.stopped') }}",
      noLogs: "{{ t('home.log.no_logs') }}",
      legendRunning: "{{ t('home.legend.running') }}",
      legendPaused: "{{ t('home.legend.paused') }}",
      legendStopped: "{{ t('home.legend.stopped') }}",
      legendInUse: "{{ t('home.legend.in_use') }}",
      legendNotInUse: "{{ t('home.legend.not_in_use') }}",
      logPlaceholder: "{{ t('home.log.placeholder') }}",
    };

    const homeLogModal = document.getElementById('home-log-modal');
    const homeLogTitle = document.getElementById('home-log-title');
    const homeLogClose = document.getElementById('home-log-close');
    const homeLogOutput = document.getElementById('home-log-output');
    const homeLogAuto = document.getElementById('home-log-auto');
    const homeLogTail = document.getElementById('home-log-tail');
    const homeLogSeverity = document.getElementById('home-log-severity');
    const homeLogRefresh = document.getElementById('home-log-refresh');
    const homeLogTriggers = Array.from(document.querySelectorAll('[data-open-home-logs]'));
    let homeLogContainerId = null;
    let homeLogInterval = null;
    let homeLogBuffer = '';
    const overviewDefaults = {
      overviewIntervalMs: 5000,
      maxSamples: 20,
      homeLogIntervalMs: 4000,
    };
    const overviewPerformance = {
      overviewIntervalMs: 10000,
      maxSamples: 12,
      homeLogIntervalMs: 7000,
    };
    let overviewIntervalMs = overviewDefaults.overviewIntervalMs;
    let overviewMaxSamples = overviewDefaults.maxSamples;
    let overviewInterval = null;
    let homeLogIntervalMs = overviewDefaults.homeLogIntervalMs;

    const escapeLogHtml = (str) =>
      (str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

    const getLogLevel = (line) => {
      const upper = (line || '').toUpperCase();
      if (upper.includes('ERROR') || upper.includes('ERR')) return 'log-error';
      if (upper.includes('WARN')) return 'log-warn';
      if (upper.includes('DEBUG')) return 'log-debug';
      if (upper.includes('INFO')) return 'log-info';
      return 'log-other';
    };

    const matchesHomeSeverity = (line, filter) => {
      if (filter === 'all') return true;
      const levelMap = {
        'log-error': 'error',
        'log-warn': 'warn',
        'log-info': 'info',
        'log-debug': 'debug',
        'log-other': 'other',
      };
      const levelClass = getLogLevel(line);
      return levelMap[levelClass] === filter;
    };

    const renderHomeLogs = (logs) => {
      if (!logs) {
        homeLogOutput.textContent = 'Nessun log disponibile';
        return;
      }

      const lines = logs.split(/\r?\n/);
      const filteredLines = lines
        .filter((line) => line !== '')
        .filter((line) => matchesHomeSeverity(line, homeLogSeverity.value));
      const html = filteredLines
        .map((line) => {
          const levelClass = getLogLevel(line);
          return `<div class="log-line ${levelClass}"><span class="log-bullet">•</span><span>${escapeLogHtml(line)}</span></div>`;
        })
        .join('');

      homeLogOutput.innerHTML = html || `<div class="muted">${homeText.noLogs}</div>`;
    };

    const updateHomeLogs = async () => {
      if (!homeLogContainerId) return;
      homeLogOutput.textContent = 'Caricamento log...';
      try {
        const tail = homeLogTail.value;
        const res = await fetch(`/api/containers/${homeLogContainerId}/logs?tail=${tail}`);
        if (!res.ok) throw new Error('Request failed');
        const data = await res.json();
        homeLogBuffer = data.logs;
        renderHomeLogs(homeLogBuffer);
      } catch (err) {
        homeLogOutput.textContent = 'Impossibile recuperare i log';
      }
    };

    const startHomeLogLoop = () => {
      clearInterval(homeLogInterval);
      if (homeLogAuto.checked && homeLogContainerId) {
        homeLogInterval = setInterval(updateHomeLogs, homeLogIntervalMs);
      }
    };

    const openHomeLogModal = (id, name) => {
      homeLogContainerId = id;
      homeLogTitle.textContent = `Log · ${name}`;
      homeLogModal.classList.add('visible');
      homeLogModal.setAttribute('aria-hidden', 'false');
      updateHomeLogs();
      startHomeLogLoop();
    };

    const closeHomeLogModal = () => {
      clearInterval(homeLogInterval);
      homeLogInterval = null;
      homeLogContainerId = null;
      homeLogBuffer = '';
      homeLogModal.classList.remove('visible');
      homeLogModal.setAttribute('aria-hidden', 'true');
    };

    homeLogTriggers.forEach((btn) => {
      btn.addEventListener('click', () => {
        openHomeLogModal(btn.dataset.containerId, btn.dataset.containerName);
      });
    });

    homeLogRefresh.addEventListener('click', updateHomeLogs);
    homeLogAuto.addEventListener('change', startHomeLogLoop);
    homeLogTail.addEventListener('change', updateHomeLogs);
    homeLogSeverity.addEventListener('change', () => renderHomeLogs(homeLogBuffer));
    homeLogClose.addEventListener('click', closeHomeLogModal);
    homeLogModal.addEventListener('click', (e) => {
      if (e.target === homeLogModal) closeHomeLogModal();
    });

    Chart.defaults.devicePixelRatio = Math.max(window.devicePixelRatio || 1, 2);
    Chart.defaults.font.family = 'Inter, system-ui, -apple-system, "Segoe UI", sans-serif';
    Chart.defaults.font.weight = '600';

    const rootStyles = getComputedStyle(document.documentElement);
    const cssVar = (name, fallback) => (rootStyles.getPropertyValue(name) || fallback).trim() || fallback;
    const palette = {
      accent: cssVar('--color-accent', '#31c4ff'),
      accent2: cssVar('--color-accent-2', '#7cffc3'),
      warn: cssVar('--color-warn', '#f4b22e'),
      error: cssVar('--color-error', '#ef476f'),
      info: cssVar('--color-info', '#4ea8ff'),
      success: cssVar('--color-success', '#35c48d'),
      text: cssVar('--color-text', '#e7ecf4'),
      muted: cssVar('--color-muted', '#9aa7bd'),
      bg: cssVar('--color-bg', '#0f1116'),
      panel: cssVar('--color-surface', '#151d32'),
      border: cssVar('--color-border', 'rgba(255,255,255,0.1)')
    };

    const withAlpha = (color, alphaHex = '33') => `${color}${alphaHex}`;
    const gridColor = palette.border;
    const tickColor = palette.muted;
    const formatPercent = (value) => `${value}%`;
    const chartDefaults = (formatter = formatPercent) => ({
      responsive: true,
      animation: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: palette.panel,
          borderColor: palette.border,
          borderWidth: 1,
          titleColor: palette.text,
          bodyColor: palette.text,
          padding: 10,
          callbacks: {
            label: (context) => `${context.dataset.label || 'Valore'}: ${formatter(context.parsed.y)}`
          }
        }
      },
      scales: {
        x: { display: false },
        y: {
          beginAtZero: true,
          ticks: { color: tickColor, callback: (v) => formatter(v) },
          grid: { color: gridColor }
        }
      }
    });

    function formatRate(bytesPerSec) {
      const units = ['B/s', 'KB/s', 'MB/s', 'GB/s', 'TB/s'];
      let value = bytesPerSec;
      let unitIndex = 0;
      while (value >= 1024 && unitIndex < units.length - 1) {
        value /= 1024;
        unitIndex += 1;
      }
      return `${value.toFixed(value >= 10 || value === 0 ? 0 : 1)} ${units[unitIndex]}`;
    }

    function slugify(name) {
      const slug = (name || 'stack').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
      return slug || 'stack';
    }

    function buildLineChart(ctx, color, label) {
      const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 120);
      gradient.addColorStop(0, withAlpha(color));
      gradient.addColorStop(1, 'transparent');
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            data: [],
            label: label,
            borderColor: color,
            backgroundColor: gradient,
            tension: 0.35,
            fill: true,
            pointRadius: 0,
            borderWidth: 2,
            borderCapStyle: 'round',
          }]
        },
        options: chartDefaults(),
      });
    }

    function buildNetChart(ctx) {
      const gradientRx = ctx.getContext('2d').createLinearGradient(0, 0, 0, 120);
      gradientRx.addColorStop(0, withAlpha(palette.accent));
      gradientRx.addColorStop(1, 'transparent');
      const gradientTx = ctx.getContext('2d').createLinearGradient(0, 0, 0, 120);
      gradientTx.addColorStop(0, withAlpha(palette.error));
      gradientTx.addColorStop(1, 'transparent');

      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              data: [],
              label: 'Ingress',
              borderColor: palette.accent,
              backgroundColor: gradientRx,
              tension: 0.35,
              fill: true,
              pointRadius: 0,
              borderWidth: 2,
              borderCapStyle: 'round',
            },
            {
              data: [],
              label: 'Uscita',
              borderColor: palette.error,
              backgroundColor: gradientTx,
              tension: 0.35,
              fill: true,
              pointRadius: 0,
              borderWidth: 2,
              borderCapStyle: 'round',
            }
          ]
        },
        options: chartDefaults(formatRate),
      });
    }

    const centerLabel = {
      id: 'centerLabel',
      afterDraw(chart, args, opts) {
        if (!opts.text || !chart.chartArea) return;
        const { ctx, chartArea: { width, height, left, top } } = chart;
        ctx.save();
        ctx.fillStyle = palette.text;
        ctx.font = '600 14px "Inter"';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(opts.text, left + width / 2, top + height / 2);
        ctx.restore();
      }
    };

    function buildPieChart(ctx, colors, centerText) {
      return new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: [],
          datasets: [{ data: [], backgroundColor: colors, borderColor: 'transparent' }]
        },
        options: {
          responsive: true,
          animation: false,
          plugins: { legend: { display: false }, centerLabel: { text: centerText || '' } },
          cutout: '60%'
        },
        plugins: [centerLabel]
      });
    }

    const charts = {
      cpu: buildLineChart(document.getElementById('cpuChart'), palette.accent, 'CPU'),
      ram: buildLineChart(document.getElementById('ramChart'), palette.accent2, 'RAM'),
      containers: buildPieChart(document.getElementById('containersChart'), [palette.accent2, palette.warn, palette.error], ''),
      images: buildPieChart(document.getElementById('imagesChart'), [palette.accent, palette.panel], '')
    };

    const stackCharts = {};
    const stackNetState = {};
    initialData.stacks.forEach((stack) => {
      const slug = slugify(stack.name);
      const cpuCanvas = document.getElementById(`stack-${slug}-cpu`);
      const memCanvas = document.getElementById(`stack-${slug}-mem`);
      const netCanvas = document.getElementById(`stack-${slug}-net`);
      if (!cpuCanvas || !memCanvas || !netCanvas) return;
      stackCharts[slug] = {
        cpu: buildLineChart(cpuCanvas, palette.accent, 'CPU'),
        mem: buildLineChart(memCanvas, palette.accent2, 'RAM'),
        net: buildNetChart(netCanvas),
      };
    });

    function trimData(chart) {
      const maxSamples = Math.max(overviewMaxSamples, 5);
      while (chart.data.labels.length > maxSamples) {
        chart.data.labels.shift();
        chart.data.datasets.forEach((dataset) => dataset.data.shift());
      }
    }

    function updateLine(chart, value) {
      chart.data.labels.push(new Date().toLocaleTimeString());
      chart.data.datasets[0].data.push(value);
      trimData(chart);
      chart.update('none');
    }

    function updateDualLine(chart, values) {
      chart.data.labels.push(new Date().toLocaleTimeString());
      chart.data.datasets.forEach((dataset, idx) => {
        dataset.data.push(values[idx] || 0);
      });
      trimData(chart);
      chart.update('none');
    }

    function updatePie(chart, labels, data, centerText) {
      chart.data.labels = labels;
      chart.data.datasets[0].data = data;
      chart.options.plugins.centerLabel.text = centerText || '';
      chart.update('none');
    }

    function applySummary(summary) {
      document.getElementById('cpuValue').textContent = `${summary.total_cpu}% ${homeText.totalLabel}`;
      document.getElementById('cpuCores').textContent = `${summary.cpu_count} core`;

      document.getElementById('ramValue').textContent = `${summary.mem_percent}%`;
      document.getElementById('ramUsage').textContent = `${summary.mem_used_h} / ${summary.mem_total_h}`;
      document.getElementById('ramBar').style.width = `${summary.mem_percent}%`;

      document.getElementById('containerValue').textContent = `${summary.running}/${summary.total_containers}`;
      document.getElementById('containerStatus').textContent = `${summary.paused} ${homeText.paused} · ${summary.stopped} ${homeText.stopped}`;

      document.getElementById('imagesValue').textContent = `${summary.images}`;
      document.getElementById('imagesDetail').textContent = `Disk layers: ${summary.disk_layers_h}`;

      updateLine(charts.cpu, summary.total_cpu);
      updateLine(charts.ram, summary.mem_percent);
      const totalContainers = summary.running + summary.paused + summary.stopped || 1;
      const runningPercent = Math.round((summary.running / totalContainers) * 100);
      updatePie(
        charts.containers,
        [homeText.legendRunning, homeText.legendPaused, homeText.legendStopped],
        [summary.running, summary.paused, summary.stopped],
        `${runningPercent}% ${homeText.legendRunning.toLowerCase()}`
      );
      const totalImages = summary.images_used + summary.images_unused || 1;
      const usedPercent = Math.round((summary.images_used / totalImages) * 100);
      updatePie(
        charts.images,
        [homeText.legendInUse, homeText.legendNotInUse],
        [summary.images_used, summary.images_unused],
        `${usedPercent}% ${homeText.legendInUse.toLowerCase()}`
      );
    }

    function applyStacks(stacks) {
      stacks.forEach((stack) => {
        const slug = slugify(stack.name);
        const chartsForStack = stackCharts[slug];
        if (!chartsForStack) return;
        updateLine(chartsForStack.cpu, stack.total_cpu || 0);
        const memPercent = stack.total_mem_bytes && initialData.summary.mem_total
          ? (stack.total_mem_bytes / initialData.summary.mem_total) * 100
          : 0;
        updateLine(chartsForStack.mem, Math.round(memPercent * 10) / 10);

        const now = Date.now();
        const prev = stackNetState[slug];
        const rxBytes = stack.total_net_rx_bytes || 0;
        const txBytes = stack.total_net_tx_bytes || 0;
        let rxRate = 0;
        let txRate = 0;

        if (prev) {
          const deltaSec = Math.max((now - prev.ts) / 1000, 0.001);
          rxRate = Math.max(rxBytes - prev.rx, 0) / deltaSec;
          txRate = Math.max(txBytes - prev.tx, 0) / deltaSec;
        }

        stackNetState[slug] = { rx: rxBytes, tx: txBytes, ts: now };

        if (chartsForStack.net) {
          updateDualLine(chartsForStack.net, [rxRate, txRate]);
        }

        const netText = document.getElementById(`stack-${slug}-net-text`);
        if (netText) {
          netText.textContent = `Rete: ${formatRate(rxRate)} ↓ · ${formatRate(txRate)} ↑`;
        }
      });
    }

    const startOverviewPolling = () => {
      clearInterval(overviewInterval);
      overviewInterval = setInterval(refreshOverview, overviewIntervalMs);
    };

    async function refreshOverview() {
      try {
        const res = await fetch('/api/overview');
        if (!res.ok) return;
        const data = await res.json();
        applySummary(data.summary);
        applyStacks(data.stacks);
      } catch (err) {
        console.error('Failed to refresh overview', err);
      }
    }

    applySummary(initialData.summary);
    applyStacks(initialData.stacks);
    startOverviewPolling();
    window.registerPerformanceHandler?.((enabled) => {
      overviewIntervalMs = enabled ? overviewPerformance.overviewIntervalMs : overviewDefaults.overviewIntervalMs;
      overviewMaxSamples = enabled ? overviewPerformance.maxSamples : overviewDefaults.maxSamples;
      homeLogIntervalMs = enabled ? overviewPerformance.homeLogIntervalMs : overviewDefaults.homeLogIntervalMs;
      if (homeLogInterval) {
        startHomeLogLoop();
      }
      startOverviewPolling();
    });
  </script>
{% endblock %}
