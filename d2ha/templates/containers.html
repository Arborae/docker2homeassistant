<!DOCTYPE html>
<html lang="{{ get_current_lang() }}">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D2HA – Container</title>
  <style>
    :root {
      --bg-base: #0b1020;
      --bg-primary: radial-gradient(circle at 12% 18%, rgba(0,255,255,0.05), transparent 26%),
                    radial-gradient(circle at 84% 18%, rgba(124,255,195,0.06), transparent 24%),
                    linear-gradient(135deg, #0b1020, #10162c 60%, #0f1b3f 100%);
      --bg-card: linear-gradient(150deg, rgba(49, 196, 255, 0.12), rgba(124, 255, 195, 0.08)),
                  linear-gradient(120deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)),
                  rgba(17, 22, 36, 0.92);
      --bg-card-alt: linear-gradient(160deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015)),
                     rgba(26, 34, 52, 0.86);
      --accent-primary: #31c4ff;
      --accent: var(--accent-primary);
      --accent-2: #7cffc3;
      --accent-gradient: linear-gradient(135deg, var(--accent), var(--accent-2));
      --accent-glow: rgba(49,196,255,0.35);
      --accent-glow-soft: rgba(49,196,255,0.25);
      --accent-border-strong: rgba(49,196,255,0.55);
      --accent-border: rgba(49,196,255,0.45);
      --accent-border-soft: rgba(49,196,255,0.3);
      --accent-surface: rgba(49,196,255,0.08);
      --text: #e7ecf4;
      --muted: #9aa7bd;
      --border: rgba(255,255,255,0.08);
      --shadow: 0 10px 30px rgba(0,0,0,0.45);
      --header-bg: linear-gradient(90deg, #0d111c, #12182a);
      --stack-header-bg: linear-gradient(135deg, #141927, #0f131d);
      --control-surface: #0f141f;
      --bg: var(--bg-base);
      --panel: var(--bg-card);
      --panel-2: var(--bg-card-alt);
    }

    body.theme-light {
      --bg-base: linear-gradient(135deg, #fff3e0, #ffe0c2);
      --bg-primary: radial-gradient(circle at 12% 18%, rgba(255, 184, 94, 0.18), transparent 26%),
                    radial-gradient(circle at 84% 18%, rgba(255, 129, 73, 0.16), transparent 24%),
                    var(--bg-base);
      --bg-card: linear-gradient(150deg, rgba(255, 255, 255, 0.86), rgba(255, 255, 255, 0.78)),
                  linear-gradient(180deg, rgba(255, 138, 61, 0.12), rgba(255, 206, 115, 0.06)),
                  #ffffff;
      --bg-card-alt: linear-gradient(160deg, rgba(255, 255, 255, 0.92), rgba(255, 255, 255, 0.84)),
                     #fff7ed;
      --accent-primary: #f97316;
      --accent: var(--accent-primary);
      --accent-2: #fb923c;
      --accent-gradient: linear-gradient(135deg, var(--accent), var(--accent-2));
      --accent-glow: rgba(249,115,22,0.28);
      --accent-glow-soft: rgba(249,115,22,0.18);
      --accent-border-strong: rgba(249,115,22,0.55);
      --accent-border: rgba(249,115,22,0.42);
      --accent-border-soft: rgba(249,115,22,0.26);
      --accent-surface: rgba(249,115,22,0.08);
      --text: #1f2937;
      --muted: #4b5563;
      --border: rgba(0,0,0,0.08);
      --shadow: 0 8px 24px rgba(0,0,0,0.1);
      --header-bg: linear-gradient(90deg, #fff0e0, #ffe1bf);
      --stack-header-bg: linear-gradient(135deg, #ffe8cc, #ffd6a5);
      --control-surface: #fffaf3;
      --auth-bg-1: #ffe9d6;
      --auth-bg-2: #ffd0a1;
      --bg: #fff7ed;
      --panel: var(--bg-card);
      --panel-2: var(--bg-card-alt);
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family:"Inter", system-ui, -apple-system, "Segoe UI", sans-serif; background: var(--bg-primary); color: var(--text); }
    a { color: inherit; text-decoration: none; }
    :root {
      --radius-lg: 20px;
      --radius-md: 14px;
      --shadow-strong: 0 16px 40px rgba(0,0,0,0.45);
      --shadow-soft: 0 10px 28px rgba(0,0,0,0.32);
    }

    .section-summary-bar {
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0)),
        linear-gradient(120deg, var(--accent-surface), rgba(124, 255, 195, 0.06)),
        var(--panel);
      border: 1px solid var(--accent-border-soft);
      box-shadow: var(--shadow-strong);
      border-radius: var(--radius-lg);
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .section-summary-bar h3 {
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 1rem;
    }

    .section-summary-bar .meta { color: var(--muted); font-weight: 700; letter-spacing: 0.01em; }

    .section-card {
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0)),
        linear-gradient(140deg, var(--accent-surface), rgba(124, 255, 195, 0.04)),
        var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-strong);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    .section-card + .section-card { margin-top: 12px; }

    .section-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      background: var(--stack-header-bg);
      border-bottom: 1px solid var(--border);
    }

    .section-card-header .title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .section-card-body { padding: 12px 14px 16px; background: var(--panel-2); }

    .section-card-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .section-card-badge {
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--accent-surface);
      color: var(--accent);
      border: 1px solid var(--accent-border);
      font-weight: 800;
      letter-spacing: 0.04em;
    }

    .section-toggle { cursor: pointer; }
    .section-toggle-btn {
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      border-radius: 12px;
      padding: 6px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-height: 32px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
    }
    .section-toggle-btn:hover { border-color: var(--accent-border); color: var(--accent); }
    .section-toggle-btn .chevron { display: inline-block; width: 10px; text-align: center; }
    .section-card-body.collapsed { display: none; }

    .btn-primary-glow {
      background: var(--accent-gradient);
      border: 1px solid var(--accent-border-strong);
      color: #0b111c;
      border-radius: 14px;
      padding: 10px 16px;
      font-weight: 800;
      letter-spacing: 0.03em;
      cursor: pointer;
      box-shadow: 0 10px 26px var(--accent-glow), inset 0 1px 0 rgba(255,255,255,0.18);
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }
    .btn-primary-glow:hover { transform: translateY(-1px); box-shadow: 0 12px 30px var(--accent-glow); }

    .btn {
      border: 1px solid var(--border);
      background: var(--control-surface);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      cursor: pointer;
      min-width: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      box-shadow: var(--shadow-soft);
    }
    .btn:hover { border-color: var(--accent-border); color: var(--accent); }
    .btn.loading { opacity: 0.6; cursor: wait; }
    .btn.hidden { display: none; }

    .btn-chip {
      border: 1px solid var(--accent-border);
      background: rgba(255,255,255,0.04);
      color: var(--accent);
      border-radius: 999px;
      padding: 6px 12px;
      font-weight: 700;
      letter-spacing: 0.02em;
      cursor: pointer;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), 0 4px 12px var(--accent-glow-soft);
      transition: all 0.15s ease;
    }
    .btn-chip:hover { background: var(--accent-surface); color: var(--text); }
    header {
      background: var(--bg-primary);
      border-bottom:1px solid var(--border);
      padding:16px 18px;
      box-shadow: var(--shadow);
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(6px);
    }
    .header-shell {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 12px 14px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    nav {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 4px 2px 0;
      align-items: center;
    }
    .tab { padding:9px 14px; border-radius:10px; background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); color: var(--muted); font-weight:700; border:1px solid rgba(255,255,255,0.08); transition: all 0.15s ease; box-shadow:0 6px 18px rgba(0,0,0,0.28); }
    .tab:hover { color: var(--text); border-color: var(--accent-border-soft); background: rgba(255,255,255,0.06); }
    .tab.active { background: var(--accent-gradient); color:#0c121e; box-shadow:0 10px 26px var(--accent-glow); border-color: var(--accent-border); }
    .logout-link { margin-left:auto; background: linear-gradient(145deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06)); color: var(--text); box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), 0 8px 20px rgba(0,0,0,0.35); border-color: var(--border); }
    main { padding: 18px; display: flex; flex-direction: column; gap: 16px; }
    .card { background: var(--bg-card); border:1px solid var(--border); border-radius:18px; padding:14px 16px; box-shadow: var(--shadow); }
    .stack-card { display:flex; flex-direction:column; gap:12px; }
    .stack-header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:2px; padding:12px 14px; border:1px solid var(--border); border-radius:14px; background: var(--bg-card-alt); box-shadow: var(--shadow); }
    .stack-toggle { margin-bottom:0; cursor:pointer; }
    .stack-title { font-size:1rem; font-weight:800; display:flex; align-items:center; gap:10px; letter-spacing:0.02em; }
    .stack-name { text-transform: uppercase; letter-spacing:0.08em; }
    .stack-chip { padding:4px 10px; border-radius:999px; background: rgba(255,255,255,0.05); color: var(--muted); font-size:0.85rem; font-weight:700; }
    .stack-toggle-btn { border:1px solid var(--border); background: rgba(255,255,255,0.04); color: var(--text); border-radius:10px; padding:6px 10px; cursor:pointer; display:inline-flex; align-items:center; gap:6px; min-height:32px; }
    .stack-toggle-btn:hover { border-color: var(--accent-border); color: var(--accent); }
    .stack-toggle-btn .chevron { display:inline-block; width:10px; text-align:center; }
    .stack-content.collapsed { display:none; }
    table { width:100%; border-collapse: collapse; background: var(--bg-card-alt); border-radius:14px; overflow:hidden; table-layout: fixed; }
    body.theme-dark .section-card-body > table { background: transparent; border-radius: 0; overflow: visible; }
    th, td { padding:10px 12px; font-size:0.85rem; text-align:left; border-bottom:1px solid var(--border); vertical-align: middle; }
    th { background: rgba(255,255,255,0.03); color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; font-size:0.8rem; }
    tr:last-child td { border-bottom: none; }
    tr:hover { background: rgba(255,255,255,0.03); }
    .status-pill { padding:4px 10px; border-radius:999px; font-size:0.75rem; font-weight:700; text-transform: uppercase; display:inline-block; }
    .status-running { background: rgba(124,255,195,0.15); color: #7cffc3; }
    .status-exited, .status-stopped { background: rgba(255,99,71,0.15); color: #ff8a7a; }
    .status-paused { background: rgba(255,193,7,0.15); color: #ffd54f; }
    .status-restarting { background: rgba(49,196,255,0.15); color: #31c4ff; }
    .status-pending { background: rgba(49,196,255,0.15); color: #31c4ff; display:inline-flex; align-items:center; gap:6px; }
    .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.18); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.9s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .actions { display:flex; flex-wrap: wrap; gap:6px; justify-content:flex-end; }
    .actions .btn { white-space:nowrap; }
    .actions-cell { text-align:right; }
    .col-select { width: 48px; }
    .col-name { width: 220px; }
    .col-status { width: 120px; }
    .col-uptime, .col-cpu, .col-ram, .col-restart { width: 110px; }
    .col-networks, .col-ports { width: 170px; }
    .col-actions { width: 200px; }
      .btn-strong { background: var(--accent-gradient); color:#0b111c; box-shadow:0 8px 18px var(--accent-glow); font-weight:800; }
      .btn-ghost { background: var(--accent-surface); color: var(--accent); border-color: var(--accent-border); font-weight:800; }
      .btn-ghost:hover { background: rgba(49,196,255,0.18); }
    .btn-play { background:#2ecc71; color:#07130c; }
    .btn-stop { background:#e74c3c; }
    .btn-delete { background:#b71c1c; }
    .btn-pause { background:#f1c40f; color:#0d0f14; }
    .btn-restart { background:#3498db; }
    .meta { color: var(--muted); font-size:0.85rem; }
    .row-clickable { cursor:pointer; }
    .select-col { width: 48px; text-align:center; }
    .checkbox { position:relative; display:inline-flex; align-items:center; justify-content:center; width:20px; height:20px; }
    .checkbox input { position:absolute; inset:0; margin:0; opacity:0; cursor:pointer; z-index:2; }
    .checkmark { width:100%; height:100%; border-radius:6px; border:1px solid var(--border); display:inline-flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.04); transition: all 0.15s ease; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04); }
    .checkbox input:checked + .checkmark { background: var(--accent-gradient); border-color: rgba(49,196,255,0.8); box-shadow: 0 0 0 4px rgba(49,196,255,0.18); }
    .checkbox input:checked + .checkmark::after { content:'✓'; color:#0b111c; font-weight:900; font-size:0.85rem; }
    .bulk-bar { position:fixed; left:0; right:0; bottom:0; background: var(--bg-card); border-top:1px solid var(--border); padding:12px 18px; display:none; align-items:center; justify-content:space-between; gap:12px; box-shadow: 0 -8px 20px rgba(0,0,0,0.25); z-index:30; color: var(--text); }
    .bulk-bar.visible { display:flex; }
    .bulk-summary { color: var(--muted); font-weight:700; letter-spacing:0.02em; }
    .bulk-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .modal-backdrop { position: fixed; inset:0; background: rgba(0,0,0,0.65); display:none; align-items:center; justify-content:center; z-index: 50; padding:20px; }
    .modal-backdrop.visible { display:flex; }
    .modal { background: var(--panel-2); border:1px solid var(--border); border-radius:16px; width:min(1100px, 100%); height:82vh; max-height:82vh; overflow:hidden; box-shadow: var(--shadow); display:flex; flex-direction:column; }
    .modal-header { display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--border); background: var(--stack-header-bg); }
    .modal-title { font-weight:800; font-size:1rem; letter-spacing:0.02em; }
    .modal-close { background:none; border:none; color:var(--muted); font-size:1.2rem; cursor:pointer; }
    .modal-tabs { display:flex; gap:8px; padding:12px 16px 0; border-bottom:1px solid var(--border); }
    .modal-tab { padding:8px 12px; border-radius:10px 10px 0 0; background: rgba(255,255,255,0.03); border:1px solid transparent; color:var(--muted); font-weight:700; cursor:pointer; }
    .modal-tab.active { background: var(--panel); color: var(--text); border-color: var(--border); box-shadow: inset 0 -3px 0 var(--accent); }
    .modal-body { padding:16px; overflow-y:auto; flex:1; display:flex; flex-direction:column; gap:12px; min-height:0; }
    .debug-overlay { position:fixed; inset:0; padding:18px; display:none; align-items:center; justify-content:center; background:rgba(5,8,15,0.78); z-index:70; backdrop-filter: blur(4px); }
    .debug-overlay.visible { display:flex; }
    .debug-panel { width:min(1100px, 100%); background: var(--panel); border:1px solid var(--accent-border-soft); border-radius: 18px; box-shadow: var(--shadow-strong); overflow:hidden; display:flex; flex-direction:column; gap:0; }
    .debug-header { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px; background: var(--stack-header-bg); border-bottom: 1px solid var(--border); }
    .debug-eyebrow { text-transform: uppercase; letter-spacing: 0.1em; font-size: 0.75rem; color: var(--muted); }
    .debug-title { font-weight: 800; font-size: 1.05rem; letter-spacing: 0.02em; }
    .debug-actions { display:flex; gap:8px; align-items:center; }
    .debug-body { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:12px; padding:14px 16px 18px; background: var(--panel-2); }
    .debug-column { background: rgba(255,255,255,0.02); border:1px solid var(--border); border-radius: 14px; padding:12px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.04); display:flex; flex-direction:column; gap:10px; min-height: 260px; }
    .debug-subtitle { font-weight: 800; letter-spacing: 0.02em; text-transform: uppercase; font-size: 0.8rem; color: var(--muted); }
    .debug-list, .debug-log { flex:1; overflow-y:auto; background: var(--control-surface); border-radius: 10px; padding:10px; border:1px dashed var(--accent-border-soft); font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 0.9rem; }
    .debug-log-line { padding:6px 8px; border-bottom: 1px solid rgba(255,255,255,0.04); display:flex; gap:8px; align-items:flex-start; }
    .debug-log-line:last-child { border-bottom:none; }
    .debug-log-line .tag { padding:2px 6px; border-radius:8px; font-size:0.75rem; background: var(--accent-surface); color: var(--accent); border:1px solid var(--accent-border-soft); }
    .debug-log-line .text { flex:1; word-break: break-word; }
    .debug-list .command { padding:6px 8px; border-bottom:1px solid rgba(255,255,255,0.06); color: var(--text); }
    .debug-list .command:last-child { border-bottom:none; }
    .debug-overlay [class*='inline-btn'] { background: var(--accent-surface); border-color: var(--accent-border); color: var(--accent); }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px; }
    .pill { padding:6px 10px; border-radius:999px; background: rgba(255,255,255,0.05); border:1px solid var(--border); font-size:0.8rem; display:inline-block; }
    .field { background: var(--panel); border:1px solid var(--border); border-radius:12px; padding:10px 12px; }
    .field h4 { margin:0 0 6px 0; color:var(--muted); font-size:0.85rem; letter-spacing:0.01em; }
    .kv { display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px solid var(--border); font-size:0.85rem; }
    .kv:last-child { border-bottom:none; }
    .badge { display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; background: var(--accent-surface); color: var(--accent); font-size:0.8rem; }
    .muted { color: var(--muted); font-size:0.85rem; }
    .stats-row { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; }
    .stat-box { background: var(--panel); border:1px solid var(--border); border-radius:12px; padding:10px 12px; display:flex; flex-direction:column; gap:6px; }
    canvas { width:100%; height:160px; background: radial-gradient(circle at 20% 20%, rgba(49,196,255,0.05), transparent 35%); border-radius:10px; }
    .logs-area { background: var(--control-surface); color: var(--text); border:1px solid var(--border); border-radius:12px; padding:10px; font-family:"JetBrains Mono", monospace; font-size:0.8rem; max-height:380px; overflow:auto; white-space:pre-wrap; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.02); }
    .logs-panel .logs-area { flex:1; max-height:unset; min-height:0; }
    .logs-area .log-line { padding:4px 8px; border-left:3px solid transparent; margin-bottom:2px; border-radius:8px; display:flex; gap:8px; align-items:flex-start; }
    .logs-area .log-line:last-child { margin-bottom:0; }
    .logs-area .log-bullet { opacity:0.4; }
    .logs-area .log-info { border-color: var(--accent); background:rgba(49,196,255,0.06); }
    .logs-area .log-warn { border-color:#ffd54f; background:rgba(255,213,79,0.07); }
    .logs-area .log-error { border-color:#ff8a7a; background:rgba(255,138,122,0.08); }
    .logs-area .log-debug { border-color:#9aa7bd; background:rgba(154,167,189,0.08); color: var(--text); }
    .logs-area .log-other { border-color:rgba(255,255,255,0.08); }
    .controls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .select, .input { background: var(--control-surface); color: var(--text); border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:0.9rem; }
    .inline-btn { padding:8px 12px; border-radius:10px; border:1px solid var(--border); background: var(--control-surface); color: var(--text); cursor:pointer; }
    .inline-btn:hover { border-color: var(--accent-border); color: var(--accent); box-shadow: 0 6px 18px var(--accent-glow-soft); }
    .chip { background: rgba(255,255,255,0.05); border:1px solid var(--border); padding:4px 8px; border-radius:8px; font-size:0.8rem; }
    .small { font-size:0.8rem; color:var(--muted); }
    .table-kv { width:100%; border-collapse:collapse; }
    .table-kv td { padding:6px 4px; border-bottom:1px solid var(--border); font-size:0.85rem; }
    .table-kv tr:last-child td { border-bottom:none; }
    .tab-panel { display:none; }
    .tab-panel.active { display:block; }
    .tab-panel.logs-panel.active { display:flex; flex-direction:column; flex:1; min-height:0; }
    .toast-container { position:fixed; top:14px; left:0; right:0; display:flex; justify-content:center; gap:10px; pointer-events:none; z-index:60; }
    .toast { background: linear-gradient(145deg, var(--control-surface), var(--panel)); color: var(--text); border:1px solid var(--border); border-radius:12px; padding:12px 14px; min-width:260px; box-shadow: var(--shadow); opacity:0; transform: translateY(-12px); transition: all 0.2s ease; pointer-events:auto; display:flex; flex-direction:column; gap:8px; }
    .toast.visible { opacity:1; transform: translateY(0); }
    .toast-message { font-weight:700; font-size:0.9rem; }
    .toast-actions { display:flex; gap:8px; }
    .toast-actions button { border:1px solid var(--border); border-radius:999px; padding:6px 12px; background: var(--control-surface); color: var(--text); cursor:pointer; font-weight:700; box-shadow: var(--shadow-soft); }
    .toast-info { border-color: var(--accent-glow-soft); }
    .toast-success { border-color: rgba(124,255,195,0.25); }
    .toast-error { border-color: rgba(255,138,122,0.25); }
    .toast-warning { border-color: rgba(255,213,79,0.35); }
  </style>
  {% include 'partials/notifications_styles.html' %}
</head>
<body class="theme-{{ get_current_theme() }}" data-safe-mode="{{ '1' if safe_mode_enabled else '0' }}" data-performance-mode="{{ '1' if performance_mode_enabled else '0' }}" data-debug-mode="{{ '1' if debug_mode_enabled else '0' }}">
  <header>
    <div class="header-shell">
      {% include 'partials/notifications_panel.html' %}
      <nav id="primaryNav" role="navigation">
        <a href="{{ url_for('index') }}" class="tab {{ 'active' if active_page == 'home' else '' }}">Home</a>
        <a href="{{ url_for('containers_view') }}" class="tab {{ 'active' if active_page == 'containers' else '' }}">{{ t("nav.containers") }}</a>
        <a href="{{ url_for('images_view') }}" class="tab {{ 'active' if active_page == 'images' else '' }}">{{ t("nav.images") }}</a>
        <a href="{{ url_for('volumes_view') }}" class="tab {{ 'active' if active_page == 'volumes' else '' }}">{{ t("nav.volumes") }}</a>
        <a href="{{ url_for('networks_view') }}" class="tab {{ 'active' if active_page == 'networks' else '' }}">{{ t("nav.networks") }}</a>
        <a href="{{ url_for('updates') }}" class="tab {{ 'active' if active_page == 'updates' else '' }}">{{ t("nav.updates") }}</a>
        <a href="{{ url_for('events_view') }}" class="tab {{ 'active' if active_page == 'events' else '' }}">{{ t("nav.events") }}</a>
        <a href="{{ url_for('autodiscovery_view') }}" class="tab {{ 'active' if active_page == 'autodiscovery' else '' }}">{{ t("nav.autodiscovery") }}</a>
        <a href="{{ url_for('logout') }}" class="tab logout-link">{{ t("nav.logout") }}</a>
      </nav>
    </div>
  </header>

  {% include 'partials/flash_messages.html' %}

  <main>
    <section class="section-summary-bar">
      <div>
        <h3>Stato container</h3>
        <div class="meta">{{ summary.running }} container attivi · {{ summary.total_containers }} totali · {{ summary.images }} immagini installate</div>
      </div>
    </section>

    {% for stack in stacks %}
      <section class="section-card">
        <div class="section-card-header section-toggle" data-stack-toggle>
          <div class="title">
            <button class="section-toggle-btn" type="button" aria-expanded="true" aria-label="Mostra o nascondi sezione">
              <span class="chevron">▾</span>
            </button>
            <span class="stack-name">{{ 'Senza stack' if stack.name == '_no_stack' else stack.name }}</span>
          </div>
          <div class="section-card-actions">
            <div class="section-card-badge">{{ stack.containers|length }} container</div>
          </div>
        </div>
        <div class="section-card-body stack-content">
          <table class="responsive-table">
            <colgroup>
              <col class="col-select">
              <col class="col-name">
              <col class="col-status">
              <col class="col-uptime">
              <col class="col-cpu">
              <col class="col-ram">
              <col class="col-restart">
              <col class="col-networks">
              <col class="col-ports">
              <col class="col-actions">
            </colgroup>
            <thead>
              <tr>
                <th class="select-col" aria-label="Seleziona"></th>
                <th>Nome</th>
                <th>Stato</th>
                <th>Uptime</th>
                <th>CPU</th>
                <th>RAM</th>
                <th>Restart</th>
                <th>Reti</th>
                <th>Porte</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody>
              {% for c in stack.containers %}
                <tr class="row-clickable" data-container-id="{{ c.id }}" data-container-name="{{ c.name }}" data-container-status="{{ c.status.lower() }}">
                  <td class="select-col" data-label="Seleziona">
                    <label class="checkbox">
                      <input type="checkbox" class="container-select" value="{{ c.id }}" data-container-name="{{ c.name }}" aria-label="Seleziona {{ c.name }}">
                      <span class="checkmark"></span>
                    </label>
                  </td>
                  <td data-label="Nome">
                    <div><strong>{{ c.name }}</strong></div>
                    <div class="meta">{{ c.image }}</div>
                    <div class="meta">{{ c.short_id }}</div>
                  </td>
                  <td data-label="Stato" data-field="status">
                    {% set status = c.status.lower() %}
                    {% set css = "status-pill " %}
                    {% if status == "running" %}
                      {% set css = css + "status-running" %}
                    {% elif status in ["exited", "stopped"] %}
                      {% set css = css + "status-exited" %}
                    {% elif status == "paused" %}
                      {% set css = css + "status-paused" %}
                    {% elif status == "restarting" %}
                      {% set css = css + "status-restarting" %}
                    {% else %}
                      {% set css = css + "status-paused" %}
                    {% endif %}
                    <span class="{{ css }}">{{ c.status }}</span>
                  </td>
                  <td data-label="Uptime" data-field="uptime">{{ c.uptime }}</td>
                  <td data-label="CPU" data-field="cpu">{{ c.cpu_percent }}%</td>
                  <td data-label="RAM" data-field="ram">{{ c.mem_usage }} ({{ c.mem_percent }}%)</td>
                  <td data-label="Restart" data-field="restart">{{ c.restarts }}</td>
                  <td data-label="Reti" data-field="networks">
                    {% if c.networks %}
                      <div class="meta">
                        {% for net in c.networks %}
                          <div>{{ net.name }}{% if net.ip %} – {{ net.ip }}{% endif %}</div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <span class="meta">Nessuna rete</span>
                    {% endif %}
                  </td>
                  <td data-label="Porte" data-field="ports">
                    {% if c.ports.mode == 'host' %}
                      <div class="meta">Modalità host</div>
                    {% elif c.ports.bindings %}
                      <div class="meta">
                        {% for port in c.ports.bindings %}
                          <div>{{ port }}</div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <span class="meta">Nessuna porta esposta</span>
                    {% endif %}
                  </td>
                  <td class="actions-cell" data-label="Azioni">
                    <div class="actions">
                      <button class="btn-primary-glow" type="button" data-open-modal data-container-id="{{ c.id }}" data-container-name="{{ c.name }}">Dettagli</button>
                      <button class="btn-primary-glow" type="button" data-open-modal data-tab="logs" data-container-id="{{ c.id }}" data-container-name="{{ c.name }}">Logs</button>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    {% endfor %}
  </main>

  <div class="bulk-bar" id="bulk-bar" aria-hidden="true">
    <div class="bulk-summary"><span id="bulk-count">0</span> container selezionati</div>
    <div class="bulk-actions">
      <button class="btn-chip" type="button" data-bulk-action="start">Avvia</button>
      <button class="btn-chip" type="button" data-bulk-action="stop">Ferma</button>
      <button class="btn-chip" type="button" data-bulk-action="pause">Pausa</button>
      <button class="btn-chip" type="button" data-bulk-action="unpause">Riprendi</button>
      <button class="btn-chip" type="button" data-bulk-action="restart">Riavvia</button>
      <button class="btn-chip" type="button" data-bulk-action="delete">Elimina</button>
    </div>
  </div>

  <div class="modal-backdrop" id="container-modal" aria-hidden="true">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="modal-title">Dettagli container</div>
          <div class="small" id="modal-subtitle"></div>
        </div>
        <button class="modal-close" id="modal-close" aria-label="Chiudi">✕</button>
      </div>
      <div class="modal-tabs">
        <button class="modal-tab active" data-tab="info">Info</button>
        <button class="modal-tab" data-tab="logs">Logs</button>
        <button class="modal-tab" data-tab="updates">{{ t("nav.updates") }}</button>
      </div>
      <div class="modal-body">
        <div class="tab-panel active" data-panel="info">
          <div class="grid">
            <div class="field">
              <h4>Stato</h4>
              <div id="info-status" class="badge">-</div>
            </div>
            <div class="field">
              <h4>Uptime</h4>
              <div id="info-uptime">-</div>
            </div>
            <div class="field">
              <h4>Riavvio</h4>
              <div id="info-restart">-</div>
            </div>
            <div class="field">
              <h4>Immagine</h4>
              <div id="info-image">-</div>
              <div class="muted" id="info-short-id"></div>
            </div>
          </div>

          <div class="stats-row">
            <div class="stat-box">
              <div class="kv"><span>CPU</span><strong id="stat-cpu">-</strong></div>
              <canvas id="chart-cpu"></canvas>
            </div>
            <div class="stat-box">
              <div class="kv"><span>RAM</span><strong id="stat-ram">-</strong></div>
              <canvas id="chart-ram"></canvas>
            </div>
            <div class="stat-box">
              <div class="kv"><span>Network</span><strong id="stat-net">-</strong></div>
              <canvas id="chart-net"></canvas>
            </div>
          </div>

          <div class="grid">
            <div class="field">
              <h4>Reti</h4>
              <div id="info-networks" class="muted">-</div>
            </div>
            <div class="field">
              <h4>Porte</h4>
              <div id="info-ports" class="muted">-</div>
            </div>
            <div class="field">
              <h4>Volumi</h4>
              <div id="info-volumes" class="muted">-</div>
            </div>
            <div class="field">
              <h4>Command</h4>
              <div id="info-command" class="muted">-</div>
            </div>
          </div>

          <div class="grid">
            <div class="field">
              <h4>Environment</h4>
              <table class="table-kv" id="info-env"></table>
            </div>
            <div class="field">
              <h4>Label</h4>
              <table class="table-kv" id="info-labels"></table>
            </div>
          </div>
        </div>

        <div class="tab-panel logs-panel" data-panel="logs">
          <div class="controls">
            <label class="muted"><input type="checkbox" id="logs-auto" checked> Auto-refresh</label>
          <label class="muted">Linee
            <select id="logs-tail" class="select">
              <option value="10">10</option>
              <option value="50">50</option>
              <option value="100" selected>100</option>
              <option value="150">150</option>
              <option value="500">500</option>
              <option value="all">Senza limiti</option>
            </select>
          </label>
          <label class="muted">Severità
            <select id="logs-severity" class="select">
              <option value="all" selected>Tutte</option>
              <option value="error">Errori</option>
              <option value="warn">Warning</option>
              <option value="info">Info</option>
              <option value="debug">Debug</option>
              <option value="other">Altro</option>
            </select>
          </label>
          <button class="inline-btn" id="logs-refresh">Aggiorna ora</button>
        </div>
          <pre class="logs-area" id="logs-output">Seleziona un container...</pre>
        </div>

        <div class="tab-panel" data-panel="updates">
          <div class="grid">
            <div class="field">
              <h4>Immagine</h4>
              <div id="updates-image">-</div>
              <a href="#" id="updates-repo" class="small" target="_blank" rel="noreferrer">Repository</a>
            </div>
            <div class="field">
              <h4>Versioni</h4>
              <div class="kv"><span>Installata</span><span id="updates-installed">-</span></div>
              <div class="kv"><span>Remota</span><span id="updates-remote">-</span></div>
            </div>
            <div class="field">
              <h4>Stato</h4>
              <div id="updates-state" class="badge">-</div>
            </div>
          </div>
          <div class="controls">
            <label class="muted">Frequenza controllo
              <select id="updates-frequency" class="select">
                <option value="15">15 min</option>
                <option value="30">30 min</option>
                <option value="60" selected>1 ora</option>
                <option value="180">3 ore</option>
                <option value="720">12 ore</option>
                <option value="1440">Ogni giorno</option>
              </select>
            </label>
            <button class="inline-btn" id="updates-save">Salva</button>
            <button class="inline-btn" id="updates-check">Check now</button>
          </div>
          <div id="updates-feedback" class="small"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="toast-container" id="toast-container"></div>
  <div class="debug-overlay" id="debug-overlay" aria-hidden="true">
    <div class="debug-panel">
      <div class="debug-header">
        <div>
          <div class="debug-eyebrow">Debug live</div>
          <div class="debug-title" id="debug-title">Stream azione</div>
        </div>
        <div class="debug-actions">
          <button class="inline-btn" type="button" id="debug-clear">Pulisci</button>
          <button class="inline-btn" type="button" id="debug-close">Chiudi</button>
        </div>
      </div>
      <div class="debug-body">
        <div class="debug-column">
          <div class="debug-subtitle">Comandi</div>
          <div class="debug-list" id="debug-commands"></div>
        </div>
        <div class="debug-column">
          <div class="debug-subtitle">Log live</div>
          <div class="debug-log" id="debug-logs"></div>
        </div>
      </div>
    </div>
  </div>
  {% include 'partials/notifications_script.html' %}
  <script>
    const stackToggles = Array.from(document.querySelectorAll('[data-stack-toggle]'));
    stackToggles.forEach((header) => {
      const btn = header.querySelector('.section-toggle-btn, .stack-toggle-btn');
      const content = header.nextElementSibling;
      const card = header.closest('.section-card');
      const chevron = btn ? btn.querySelector('.chevron') : null;
      if (!btn || !content) return;

      const setExpanded = (expanded) => {
        content.classList.toggle('collapsed', !expanded);
        if (card) card.classList.toggle('collapsed', !expanded);
        btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        if (chevron) chevron.textContent = expanded ? '▾' : '▸';
      };

      setExpanded(true);

      const toggle = () => {
        const isExpanded = btn.getAttribute('aria-expanded') === 'true';
        setExpanded(!isExpanded);
      };

      btn.addEventListener('click', (event) => {
        event.stopPropagation();
        toggle();
      });

      header.addEventListener('click', (event) => {
        if (event.target === btn || btn.contains(event.target)) return;
        toggle();
      });
    });

    const modalEl = document.getElementById('container-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalSubtitle = document.getElementById('modal-subtitle');
    const tabButtons = Array.from(document.querySelectorAll('.modal-tab'));
    const tabPanels = Array.from(document.querySelectorAll('.tab-panel'));
    const logOutput = document.getElementById('logs-output');
    const logAuto = document.getElementById('logs-auto');
    const logTail = document.getElementById('logs-tail');
    const logSeverity = document.getElementById('logs-severity');
    const logRefreshBtn = document.getElementById('logs-refresh');
    const updatesFrequency = document.getElementById('updates-frequency');
    const updatesSave = document.getElementById('updates-save');
    const updatesCheck = document.getElementById('updates-check');
    const updatesFeedback = document.getElementById('updates-feedback');
    const toastContainer = document.getElementById('toast-container');
    const bulkBar = document.getElementById('bulk-bar');
    const bulkCount = document.getElementById('bulk-count');
    const bulkButtons = Array.from(document.querySelectorAll('[data-bulk-action]'));
    const selectionInputs = Array.from(document.querySelectorAll('.container-select'));
    const actionButtons = Array.from(document.querySelectorAll('[data-action-btn]'));
    const debugOverlay = document.getElementById('debug-overlay');
    const debugTitle = document.getElementById('debug-title');
    const debugCommands = document.getElementById('debug-commands');
    const debugLogs = document.getElementById('debug-logs');
    const debugClose = document.getElementById('debug-close');
    const debugClear = document.getElementById('debug-clear');

    const rowIndex = new Map();
    Array.from(document.querySelectorAll('tr[data-container-id]')).forEach((row) => {
      rowIndex.set(row.dataset.containerId, row);
    });

    const actionPendingLabels = {
      start: 'Avvio...',
      stop: 'Arresto...',
      restart: 'Riavvio...',
      pause: 'Pausa...',
      unpause: 'Ripresa...',
      delete: 'Eliminazione...'
    };

    const actionSuccessLabels = {
      start: 'avviato',
      stop: 'fermato',
      restart: 'riavviato',
      pause: 'messo in pausa',
      unpause: 'ripreso',
      delete: 'eliminato'
    };

    let currentContainerId = null;
    let statsInterval = null;
    let logsInterval = null;
    let lastLogs = '';
    let statsHistory = { cpu: [], ram: [], net: [] };
    let lastNet = null;
    const selectedContainers = new Map();
    const pollingDefaults = { statsIntervalMs: 3000, logsIntervalMs: 4000, historyLimit: 40 };
    const pollingPerformance = { statsIntervalMs: 5000, logsIntervalMs: 7000, historyLimit: 20 };
    let statsIntervalMs = pollingDefaults.statsIntervalMs;
    let logsIntervalMs = pollingDefaults.logsIntervalMs;
    let statsSampleLimit = pollingDefaults.historyLimit;
    let activeTab = 'info';
    const debugEnabled = document.body.dataset.debugMode === '1';
    const debugStreamSupported = debugEnabled && typeof EventSource !== 'undefined';
    let activeDebugStream = null;

    const safeParseEvent = (evt) => {
      try { return JSON.parse(evt.data); }
      catch (e) { return {}; }
    };

    const clearDebugOverlay = () => {
      if (!debugOverlay) return;
      debugCommands.innerHTML = '';
      debugLogs.innerHTML = '';
    };

    const openDebugOverlay = (title) => {
      if (!debugStreamSupported) return;
      clearDebugOverlay();
      debugTitle.textContent = title;
      debugOverlay.classList.add('visible');
      debugOverlay.setAttribute('aria-hidden', 'false');
    };

    const closeDebugOverlay = () => {
      if (activeDebugStream) {
        activeDebugStream.close();
        activeDebugStream = null;
      }
      if (!debugOverlay) return;
      debugOverlay.classList.remove('visible');
      debugOverlay.setAttribute('aria-hidden', 'true');
    };

    const pushCommand = (text) => {
      if (!debugEnabled || !debugCommands) return;
      const row = document.createElement('div');
      row.className = 'command';
      row.textContent = text;
      debugCommands.appendChild(row);
      debugCommands.scrollTop = debugCommands.scrollHeight;
    };

    const pushLog = (text, tag = 'LOG') => {
      if (!debugEnabled || !debugLogs) return;
      const row = document.createElement('div');
      row.className = 'debug-log-line';
      const badge = document.createElement('span');
      badge.className = 'tag';
      badge.textContent = tag;
      const body = document.createElement('span');
      body.className = 'text';
      body.textContent = text;
      row.appendChild(badge);
      row.appendChild(body);
      debugLogs.appendChild(row);
      debugLogs.scrollTop = debugLogs.scrollHeight;
    };

    const statusClassFor = (status) => {
      const s = (status || '').toLowerCase();
      if (s === 'running') return 'status-running';
      if (s === 'restarting') return 'status-restarting';
      if (s === 'paused') return 'status-paused';
      if (s === 'exited' || s === 'stopped') return 'status-exited';
      return 'status-paused';
    };

    const syncActionButtons = (row) => {
      const status = (row?.dataset.containerStatus || '').toLowerCase();
      const isRunning = status === 'running' || status === 'restarting';
      const isPaused = status === 'paused';

      const startBtn = row?.querySelector('[data-action="start"]');
      const stopBtn = row?.querySelector('[data-action="stop"]');
      const pauseBtn = row?.querySelector('[data-action="pause"]');
      const unpauseBtn = row?.querySelector('[data-action="unpause"]');

      if (startBtn) startBtn.classList.toggle('hidden', isRunning || isPaused);
      if (stopBtn) stopBtn.classList.toggle('hidden', !isRunning && !isPaused);
      if (pauseBtn) pauseBtn.classList.toggle('hidden', !isRunning || isPaused);
      if (unpauseBtn) unpauseBtn.classList.toggle('hidden', !isPaused);
    };

    const renderNetworks = (networks = []) => {
      if (!networks.length) return '<span class="meta">Nessuna rete</span>';
      return '<div class="meta">' + networks.map((net) => `<div>${net.name}${net.ip ? ' – ' + net.ip : ''}</div>`).join('') + '</div>';
    };

    const renderPorts = (ports = {}) => {
      if (ports.mode === 'host') return '<div class="meta">Modalità host</div>';
      if (ports.bindings && ports.bindings.length) {
        return `<div class="meta">${ports.bindings.map((p) => `<div>${p}</div>`).join('')}</div>`;
      }
      return '<span class="meta">Nessuna porta esposta</span>';
    };

    const setRowFromOverview = (row, info) => {
      if (!row || !info) return;

      clearRowPending(row, false);

      row.dataset.containerStatus = (info.status || '').toLowerCase();
      const statusCell = row.querySelector('[data-field="status"] .status-pill');
      if (statusCell) {
        statusCell.className = `status-pill ${statusClassFor(info.status)}`;
        statusCell.textContent = info.status;
      }

      const uptimeCell = row.querySelector('[data-field="uptime"]');
      if (uptimeCell) uptimeCell.textContent = info.uptime || '-';

      const cpuCell = row.querySelector('[data-field="cpu"]');
      if (cpuCell) cpuCell.textContent = `${info.cpu_percent ?? '-'}%`;

      const ramCell = row.querySelector('[data-field="ram"]');
      if (ramCell) ramCell.textContent = `${info.mem_usage || '-'} (${info.mem_percent ?? '-'}%)`;

      const restartCell = row.querySelector('[data-field="restart"]');
      if (restartCell) restartCell.textContent = info.restarts ?? '-';

      const networksCell = row.querySelector('[data-field="networks"]');
      if (networksCell) networksCell.innerHTML = renderNetworks(info.networks);

      const portsCell = row.querySelector('[data-field="ports"]');
      if (portsCell) portsCell.innerHTML = renderPorts(info.ports);

      syncActionButtons(row);
    };

    const setRowPending = (row, label = 'In corso...') => {
      if (!row) return;
      row.dataset.pending = '1';
      row.querySelectorAll('[data-action-btn]').forEach((btn) => {
        btn.disabled = true;
        btn.classList.add('loading');
      });

      const statusCell = row.querySelector('[data-field="status"] .status-pill');
      if (!statusCell) return;
      statusCell.dataset.prevText = statusCell.textContent;
      statusCell.dataset.prevClass = statusCell.className;
      statusCell.className = 'status-pill status-pending';
      statusCell.textContent = label;
      const spin = document.createElement('span');
      spin.className = 'spinner';
      statusCell.prepend(spin);
    };

    const clearRowPending = (row, restoreStatus = false) => {
      if (!row) return;
      row.dataset.pending = '';
      row.querySelectorAll('[data-action-btn]').forEach((btn) => {
        btn.disabled = false;
        btn.classList.remove('loading');
      });

      const statusCell = row.querySelector('[data-field="status"] .status-pill');
      if (!statusCell) return;
      const prevText = statusCell.dataset.prevText;
      const prevClass = statusCell.dataset.prevClass;
      const spinner = statusCell.querySelector('.spinner');
      if (spinner) spinner.remove();
      if (restoreStatus && prevText) {
        statusCell.textContent = prevText;
        statusCell.className = prevClass || 'status-pill';
      }
      delete statusCell.dataset.prevText;
      delete statusCell.dataset.prevClass;
    };

    const removeRow = (row) => {
      if (!row) return;
      const id = row.dataset.containerId;
      selectedContainers.delete(id);
      rowIndex.delete(id);
      row.remove();
      updateBulkBar();
    };

    const fetchContainerAction = async (id, action) => {
      const res = await fetch(`/containers/${id}/${action}`, { method: 'POST', headers: { Accept: 'application/json' } });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || 'Request failed');
      }
      return res.json();
    };

    const startActionDebugStream = (containerId, action, row) => {
      if (!debugStreamSupported) return Promise.reject(new Error('Debug non attivo'));

      return new Promise((resolve, reject) => {
        const name = row?.dataset.containerName || 'Container';
        openDebugOverlay(`${action.toUpperCase()} – ${name}`);
        pushCommand(`Richiesta ${action} per ${name}`);

        const source = new EventSource(`/api/containers/${containerId}/actions/${action}/stream`);
        activeDebugStream = source;
        let lastResult = null;
        let ended = false;

        source.addEventListener('command', (evt) => {
          const data = safeParseEvent(evt);
          if (data?.message) pushCommand(data.message);
        });

        source.addEventListener('status', (evt) => {
          const data = safeParseEvent(evt);
          if (data?.state) pushLog(`Stato: ${data.state}`, 'STAT');
        });

        source.addEventListener('log', (evt) => {
          const data = safeParseEvent(evt);
          if (data?.line) pushLog(data.line, 'LOG');
        });

        source.addEventListener('result', (evt) => {
          const data = safeParseEvent(evt);
          lastResult = data;
          applyActionResult(row, data);
        });

        source.addEventListener('end', (evt) => {
          ended = true;
          const data = safeParseEvent(evt);
          pushLog('Stream concluso', 'DONE');
          source.close();
          activeDebugStream = null;
          resolve(lastResult || data);
        });

        source.addEventListener('error', () => {
          pushLog('Stream interrotto', 'ERR');
          source.close();
          activeDebugStream = null;
          if (!ended) reject(new Error('Stream interrotto'));
        });
      });
    };

    const applyActionResult = (row, data) => {
      if (!row) return;
      if (data?.removed) {
        removeRow(row);
        return;
      }
      if (data?.container) {
        setRowFromOverview(row, data.container);
      } else {
        clearRowPending(row, true);
      }
    };

    const handleContainerAction = async (containerId, action) => {
      const row = rowIndex.get(containerId);
      setRowPending(row, actionPendingLabels[action] || 'In corso...');

      if (debugStreamSupported) {
        try {
          await startActionDebugStream(containerId, action, row);
          const success = actionSuccessLabels[action] || action;
          showToast(`Container ${success}`, { type: 'success' });
          return;
        } catch (err) {
          console.warn('Debug stream non disponibile, fallback', err);
        }
      }

      try {
        const data = await fetchContainerAction(containerId, action);
        applyActionResult(row, data);
        const success = actionSuccessLabels[action] || action;
        showToast(`Container ${success}`, { type: 'success' });
      } catch (err) {
        console.error(err);
        clearRowPending(row, true);
        showToast("Errore nell'eseguire l'azione", { type: 'error' });
      }
    };

    const showToast = (message, { type = 'info', actions = [] } = {}) => {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `<div class="toast-message">${message}</div>`;

      if (actions.length) {
        const actionBar = document.createElement('div');
        actionBar.className = 'toast-actions';
        actions.forEach(({ label, onClick }) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = label;
          btn.addEventListener('click', () => {
            onClick?.();
            toast.remove();
          });
          actionBar.appendChild(btn);
        });
        toast.appendChild(actionBar);
      }

      toastContainer.appendChild(toast);
      requestAnimationFrame(() => toast.classList.add('visible'));

      const lifetime = actions.length ? 6500 : 4200;
      setTimeout(() => {
        toast.classList.remove('visible');
        setTimeout(() => toast.remove(), 350);
      }, lifetime);
    };

    const updateBulkBar = () => {
      const count = selectedContainers.size;
      bulkCount.textContent = count;
      const visible = count > 0;
      bulkBar.classList.toggle('visible', visible);
      bulkBar.setAttribute('aria-hidden', visible ? 'false' : 'true');
    };

    const toggleSelection = (input) => {
      const id = input.value;
      if (!id) return;
      if (input.checked) {
        selectedContainers.set(id, input.dataset.containerName || 'Container');
      } else {
        selectedContainers.delete(id);
      }
      updateBulkBar();
    };

    selectionInputs.forEach((input) => {
      input.addEventListener('change', (e) => {
        toggleSelection(e.target);
        e.stopPropagation();
      });
      input.addEventListener('click', (e) => e.stopPropagation());
    });

    const performBulkAction = async (action) => {
      const ids = Array.from(selectedContainers.keys());
      if (!ids.length) return;

      const rows = ids.map((id) => rowIndex.get(id)).filter(Boolean);
      rows.forEach((row) => setRowPending(row, actionPendingLabels[action] || 'In corso...'));

      const labelMap = {
        start: 'avvio',
        stop: 'stop',
        restart: 'riavvio',
        delete: 'eliminazione',
        pause: 'pausa',
        unpause: 'ripresa',
      };

      try {
        if (debugStreamSupported) {
          for (const id of ids) {
            const row = rowIndex.get(id);
            await startActionDebugStream(id, action, row);
          }
          showToast(`Azione di ${labelMap[action] || action} completata`, { type: 'success' });
        } else {
          const results = await Promise.all(ids.map((id) => fetchContainerAction(id, action)));
          results.forEach((data, idx) => applyActionResult(rows[idx], data));
          showToast(`Azione di ${labelMap[action] || action} completata`, { type: 'success' });
        }
      } catch (err) {
        console.error(err);
        rows.forEach((row) => clearRowPending(row, true));
        showToast("Errore nell'eseguire l'azione selezionata", { type: 'error' });
      }

      selectedContainers.clear();
      selectionInputs.forEach((input) => {
        input.checked = false;
      });
      updateBulkBar();
    };

    const formatBytes = (bytes) => {
      if (bytes === 0) return '0B';
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return `${(bytes / Math.pow(1024, i)).toFixed(1)}${sizes[i]}`;
    };

    const drawSpark = (canvas, data, color, maxValue = null) => {
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0, 0, w, h);
      if (!data.length) return;
      const maxVal = maxValue || Math.max(...data, 1);
      const step = w / Math.max(data.length - 1, 1);
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      data.forEach((val, idx) => {
        const x = idx * step;
        const y = h - (val / maxVal) * (h - 10);
        if (idx === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
    };

    const setPanel = (name) => {
      tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === name));
      tabPanels.forEach(panel => panel.classList.toggle('active', panel.dataset.panel === name));
    };

    const handleTabChange = (name) => {
      setPanel(name);
      activeTab = name;

      if (window.d2haSettings?.performanceMode) {
        stopPolling();
        if (name === 'stats') {
          updateStats();
          statsInterval = setInterval(updateStats, statsIntervalMs);
        }
        if (name === 'logs') {
          updateLogs();
          if (logAuto.checked) {
            logsInterval = setInterval(updateLogs, logsIntervalMs);
          }
        }
      }
    };

    const renderList = (target, items, formatter, emptyText = 'Nessun dato') => {
      if (!items || !items.length) {
        target.textContent = emptyText;
        return;
      }
      target.innerHTML = items.map(formatter).join('');
    };

    const renderTable = (table, items) => {
      table.innerHTML = '';
      if (!items || !items.length) {
        table.innerHTML = '<tr><td class="muted">Nessun dato</td></tr>';
        return;
      }
      items.forEach(item => {
        const row = document.createElement('tr');
        const k = document.createElement('td');
        k.textContent = item.key;
        const v = document.createElement('td');
        v.textContent = item.value;
        row.appendChild(k);
        row.appendChild(v);
        table.appendChild(row);
      });
    };

    const fetchJSON = async (url, options = {}) => {
      const res = await fetch(url, options);
      if (!res.ok) throw new Error('Request failed');
      return res.json();
    };

    const updateDetails = async () => {
      if (!currentContainerId) return;
      try {
        const data = await fetchJSON(`/api/containers/${currentContainerId}/details`);
        modalSubtitle.textContent = data.id;
        document.getElementById('info-status').textContent = data.status;
        document.getElementById('info-uptime').textContent = data.uptime || '-';
        document.getElementById('info-restart').textContent = data.restart_policy || '-';
        document.getElementById('info-image').textContent = data.image;
        document.getElementById('info-short-id').textContent = data.short_id;
        document.getElementById('info-command').textContent = data.command || '-';

        const networks = document.getElementById('info-networks');
        renderList(networks, data.networks, (n) => `<div class="chip">${n.name}${n.ip ? ' – ' + n.ip : ''}</div>`);

        const ports = document.getElementById('info-ports');
        const portVals = data.ports && data.ports.bindings ? data.ports.bindings : [];
        renderList(ports, portVals, (p) => `<div class="chip">${p}</div>`, 'Nessuna porta esposta');

        const volumes = document.getElementById('info-volumes');
        renderList(
          volumes,
          data.mounts,
          (m) => `<div class="chip">${m.source || '-'} → ${m.destination || '-'}</div>`,
          'Nessun volume'
        );

        renderTable(document.getElementById('info-env'), data.env);
        renderTable(document.getElementById('info-labels'), data.labels);
      } catch (err) {
        console.error(err);
      }
    };

    const updateStats = async () => {
      if (!currentContainerId) return;
      try {
        const data = await fetchJSON(`/api/containers/${currentContainerId}/stats`);
        const cpuText = `${data.cpu_percent}%`;
        const memText = `${formatBytes(data.mem_usage)} / ${formatBytes(data.mem_limit || 1)} (${data.mem_percent}%)`;
        const netDelta = lastNet
          ? { rx: Math.max(data.net_rx - lastNet.rx, 0), tx: Math.max(data.net_tx - lastNet.tx, 0) }
          : { rx: 0, tx: 0 };
        lastNet = { rx: data.net_rx, tx: data.net_tx };
        const netText = `↓ ${formatBytes(netDelta.rx)} · ↑ ${formatBytes(netDelta.tx)}`;

        document.getElementById('stat-cpu').textContent = cpuText;
        document.getElementById('stat-ram').textContent = memText;
        document.getElementById('stat-net').textContent = netText;

        statsHistory.cpu.push(data.cpu_percent);
        statsHistory.ram.push(data.mem_percent);
        statsHistory.net.push(netDelta.rx + netDelta.tx);
        statsHistory.cpu = statsHistory.cpu.slice(-statsSampleLimit);
        statsHistory.ram = statsHistory.ram.slice(-statsSampleLimit);
        statsHistory.net = statsHistory.net.slice(-statsSampleLimit);

        drawSpark(document.getElementById('chart-cpu'), statsHistory.cpu, '#31c4ff', 100);
        drawSpark(document.getElementById('chart-ram'), statsHistory.ram, '#8ef0c5', 100);
        drawSpark(document.getElementById('chart-net'), statsHistory.net, '#ffbf69');
      } catch (err) {
        console.error(err);
      }
    };

    const escapeHtml = (str) =>
      str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

    const getLogLevel = (line) => {
      const upper = line.toUpperCase();
      if (upper.includes('ERROR') || upper.includes('ERR')) return 'log-error';
      if (upper.includes('WARN')) return 'log-warn';
      if (upper.includes('DEBUG')) return 'log-debug';
      if (upper.includes('INFO')) return 'log-info';
      return 'log-other';
    };

    const matchesSeverity = (line, filter) => {
      if (filter === 'all') return true;
      const levelMap = {
        'log-error': 'error',
        'log-warn': 'warn',
        'log-info': 'info',
        'log-debug': 'debug',
        'log-other': 'other',
      };
      const levelClass = getLogLevel(line);
      return levelMap[levelClass] === filter;
    };

    const renderLogs = (logs, target = logOutput) => {
      if (!logs) {
        target.textContent = 'Nessun log disponibile';
        return;
      }

      const lines = logs.split(/\r?\n/);
      const filteredLines = lines
        .filter((line) => line !== '')
        .filter((line) => matchesSeverity(line, logSeverity.value));
      const html = filteredLines
        .map((line) => {
          const levelClass = getLogLevel(line);
          return `<div class="log-line ${levelClass}"><span class="log-bullet">•</span><span>${escapeHtml(line)}</span></div>`;
        })
        .join('');

      target.innerHTML = html || '<div class="muted">Nessun log per la severità selezionata</div>';
    };

    const updateLogs = async () => {
      if (!currentContainerId) return;
      try {
        const tail = logTail.value;
        const data = await fetchJSON(`/api/containers/${currentContainerId}/logs?tail=${tail}`);
        lastLogs = data.logs;
        renderLogs(lastLogs);
      } catch (err) {
        logOutput.textContent = 'Impossibile recuperare i log';
      }
    };

    const updateUpdates = async (force = false) => {
      if (!currentContainerId) return;
      try {
        const url = `/api/containers/${currentContainerId}/updates`;
        const data = await fetchJSON(url, force ? { method: 'POST' } : {});
        document.getElementById('updates-image').textContent = data.image_ref;
        document.getElementById('updates-repo').href = data.repo_link || '#';
        document.getElementById('updates-installed').textContent = data.installed_version || '-';
        document.getElementById('updates-remote').textContent = data.remote_version || '-';
        document.getElementById('updates-state').textContent = data.update_state;
        updatesFrequency.value = data.frequency_minutes?.toString() || '60';
        updatesFeedback.textContent = '';
        return data;
      } catch (err) {
        updatesFeedback.textContent = 'Impossibile recuperare le informazioni';
        return null;
      }
    };

    const installUpdates = async () => {
      if (!currentContainerId) return;
      showToast('Installazione aggiornamento in corso...', { type: 'info' });
      try {
        const res = await fetch(`/containers/${currentContainerId}/full_update`, { method: 'POST' });
        if (!res.ok) throw new Error('fail');
        showToast('Aggiornamento avviato', { type: 'success' });
        await updateUpdates(true);
      } catch (err) {
        showToast('Impossibile avviare l\'aggiornamento', { type: 'error' });
      }
    };

    const startPolling = () => {
      clearInterval(statsInterval);
      clearInterval(logsInterval);
      statsInterval = setInterval(updateStats, statsIntervalMs);
      if (logAuto.checked) {
        logsInterval = setInterval(updateLogs, logsIntervalMs);
      }
    };

    const stopPolling = () => {
      clearInterval(statsInterval);
      clearInterval(logsInterval);
    };

    const openModal = (id, name, initialTab = 'info') => {
      currentContainerId = id;
      modalTitle.textContent = name;
      statsHistory = { cpu: [], ram: [], net: [] };
      lastNet = null;
      modalEl.classList.add('visible');
      modalEl.setAttribute('aria-hidden', 'false');
      activeTab = initialTab;
      setPanel(initialTab);
      updateDetails();
      updateUpdates();
      if (window.d2haSettings?.performanceMode) {
        if (initialTab === 'stats') {
          updateStats();
          statsInterval = setInterval(updateStats, statsIntervalMs);
        }
        if (initialTab === 'logs') {
          updateLogs();
          if (logAuto.checked) {
            logsInterval = setInterval(updateLogs, logsIntervalMs);
          }
        }
      } else {
        updateStats();
        updateLogs();
        startPolling();
      }
    };

    const closeModal = () => {
      stopPolling();
      modalEl.classList.remove('visible');
      modalEl.setAttribute('aria-hidden', 'true');
      currentContainerId = null;
      lastLogs = '';
    };

    window.registerPerformanceHandler?.((enabled) => {
      statsIntervalMs = enabled ? pollingPerformance.statsIntervalMs : pollingDefaults.statsIntervalMs;
      logsIntervalMs = enabled ? pollingPerformance.logsIntervalMs : pollingDefaults.logsIntervalMs;
      statsSampleLimit = enabled ? pollingPerformance.historyLimit : pollingDefaults.historyLimit;
      statsHistory.cpu = statsHistory.cpu.slice(-statsSampleLimit);
      statsHistory.ram = statsHistory.ram.slice(-statsSampleLimit);
      statsHistory.net = statsHistory.net.slice(-statsSampleLimit);

      if (!modalEl.classList.contains('visible')) {
        stopPolling();
        return;
      }

      if (enabled) {
        stopPolling();
        if (activeTab === 'stats') {
          updateStats();
          statsInterval = setInterval(updateStats, statsIntervalMs);
        }
        if (activeTab === 'logs' && logAuto.checked) {
          updateLogs();
          logsInterval = setInterval(updateLogs, logsIntervalMs);
        }
      } else {
        updateStats();
        updateLogs();
        startPolling();
      }
    });

    document.getElementById('modal-close').addEventListener('click', closeModal);
    modalEl.addEventListener('click', (e) => {
      if (e.target === modalEl) closeModal();
    });

    debugClose?.addEventListener('click', closeDebugOverlay);
    debugClear?.addEventListener('click', clearDebugOverlay);
    debugOverlay?.addEventListener('click', (e) => {
      if (e.target === debugOverlay) closeDebugOverlay();
    });

    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => handleTabChange(btn.dataset.tab));
    });

    document.querySelectorAll('[data-open-modal]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const targetTab = btn.dataset.tab || 'info';
        openModal(btn.dataset.containerId, btn.dataset.containerName, targetTab);
      });
    });

    actionButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const row = btn.closest('tr[data-container-id]');
        const id = row?.dataset.containerId;
        if (!id) return;
        handleContainerAction(id, btn.dataset.action);
      });
    });

    rowIndex.forEach((row) => syncActionButtons(row));

    bulkButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        performBulkAction(btn.dataset.bulkAction);
      });
    });

    logRefreshBtn.addEventListener('click', () => {
      updateLogs();
    });

    logSeverity.addEventListener('change', () => renderLogs(lastLogs));

    logAuto.addEventListener('change', () => {
      if (logAuto.checked) {
        logsInterval = setInterval(updateLogs, logsIntervalMs);
      } else {
        clearInterval(logsInterval);
      }
    });

    updatesSave.addEventListener('click', async () => {
      if (!currentContainerId) return;
      try {
        const minutes = parseInt(updatesFrequency.value, 10) || 60;
        const data = await fetchJSON(`/api/containers/${currentContainerId}/updates/frequency`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ minutes })
        });
        updatesFeedback.textContent = `Frequenza salvata (${data.minutes} min)`;
      } catch (err) {
        updatesFeedback.textContent = 'Errore nel salvataggio';
      }
    });

    updatesCheck.addEventListener('click', async () => {
      updatesFeedback.textContent = 'Verifica in corso...';
      const data = await updateUpdates(true);
      updatesFeedback.textContent = 'Verifica completata';
      if (!data) return;

      if (data.update_state === 'up_to_date') {
        showToast('Il container è già aggiornato', { type: 'success' });
      } else if (data.update_state === 'update_available') {
        showToast('Aggiornamento disponibile. Vuoi installarlo?', {
          type: 'warning',
          actions: [
            { label: 'Installa', onClick: installUpdates },
            { label: 'Annulla' },
          ],
        });
      }
    });

  </script>
</body>
</html>
