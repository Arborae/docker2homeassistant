<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D2HA – Container</title>
  <style>
    :root {
      --bg: #0f1116;
      --panel: #151924;
      --panel-2: #1b2131;
      --accent: #31c4ff;
      --text: #e7ecf4;
      --muted: #9aa7bd;
      --border: rgba(255,255,255,0.08);
      --shadow: 0 10px 30px rgba(0,0,0,0.45);
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family:"Inter", system-ui, -apple-system, "Segoe UI", sans-serif; background: var(--bg); color: var(--text); }
    a { color: inherit; text-decoration: none; }
    header { background: linear-gradient(90deg, #0d111c, #12182a); border-bottom:1px solid var(--border); padding:16px 22px 12px; box-shadow: var(--shadow); position:sticky; top:0; z-index:10; }
    .brand-line { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .brand-line h1 { margin:0; font-size:1.1rem; letter-spacing:0.1em; text-transform:uppercase; }
    .brand-pill { padding:4px 10px; border-radius:999px; border:1px solid var(--border); background: rgba(49,196,255,0.1); color: var(--accent); font-size:0.8rem; letter-spacing:0.04em; }
    nav { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .tab { padding:8px 14px; border-radius:8px; background: rgba(255,255,255,0.04); color: var(--muted); font-weight:600; border:1px solid transparent; transition: all 0.15s ease; }
    .tab:hover { color: var(--text); border-color: var(--border); }
    .tab.active { background: linear-gradient(135deg, #1b87f1, #31c4ff); color:#0c121e; box-shadow:0 6px 18px rgba(49,196,255,0.35); }
    main { padding: 18px; display: flex; flex-direction: column; gap: 16px; }
    .card { background: var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px 16px; box-shadow: var(--shadow); }
    .stack-header { display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
    .stack-toggle { margin-bottom:0; cursor:pointer; }
    .stack-title { font-size:1rem; font-weight:700; display:flex; align-items:center; gap:8px; }
    .stack-chip { padding:4px 10px; border-radius:999px; background: rgba(255,255,255,0.05); color: var(--muted); font-size:0.8rem; }
    .stack-toggle-btn { border:1px solid var(--border); background: rgba(255,255,255,0.04); color: var(--text); border-radius:8px; padding:4px 8px; cursor:pointer; display:inline-flex; align-items:center; gap:6px; }
    .stack-toggle-btn:hover { border-color: rgba(49,196,255,0.45); color: var(--accent); }
    .stack-toggle-btn .chevron { display:inline-block; width:10px; text-align:center; }
    .stack-content.collapsed { display:none; }
    table { width:100%; border-collapse: collapse; background: var(--panel-2); border-radius:12px; overflow:hidden; }
    th, td { padding:10px 12px; font-size:0.85rem; text-align:left; border-bottom:1px solid var(--border); vertical-align: middle; }
    th { background: rgba(255,255,255,0.03); color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; font-size:0.8rem; }
    tr:last-child td { border-bottom: none; }
    tr:hover { background: rgba(255,255,255,0.03); }
    .status-pill { padding:4px 10px; border-radius:999px; font-size:0.75rem; font-weight:700; text-transform: uppercase; display:inline-block; }
    .status-running { background: rgba(124,255,195,0.15); color: #7cffc3; }
    .status-exited, .status-stopped { background: rgba(255,99,71,0.15); color: #ff8a7a; }
    .status-paused { background: rgba(255,193,7,0.15); color: #ffd54f; }
    .status-restarting { background: rgba(49,196,255,0.15); color: #31c4ff; }
    .actions { display:flex; flex-wrap: wrap; gap:6px; }
    .btn { border:none; border-radius:999px; padding:6px 12px; font-size:0.8rem; cursor:pointer; background:#262c3c; color: var(--text); transition: background 0.15s ease, transform 0.05s ease; }
    .btn:hover { background:#31394e; transform: translateY(-1px); }
    .btn-play { background:#2ecc71; color:#07130c; }
    .btn-stop { background:#e74c3c; }
    .btn-delete { background:#b71c1c; }
    .btn-pause { background:#f1c40f; color:#0d0f14; }
    .btn-restart { background:#3498db; }
    .meta { color: var(--muted); font-size:0.85rem; }
    .row-clickable { cursor:pointer; }
    .select-col { width: 48px; text-align:center; }
    .checkbox { display:inline-flex; align-items:center; justify-content:center; width:18px; height:18px; border:1px solid var(--border); border-radius:6px; background: rgba(255,255,255,0.04); }
    .checkbox input { width:100%; height:100%; margin:0; opacity:0; cursor:pointer; }
    .checkbox input:checked + .checkmark { background: var(--accent); border-color: var(--accent); }
    .checkmark { width:100%; height:100%; border-radius:5px; border:1px solid transparent; display:inline-block; }
    .bulk-bar { position:fixed; left:0; right:0; bottom:0; background: rgba(21,25,36,0.95); border-top:1px solid var(--border); padding:12px 18px; display:none; align-items:center; justify-content:space-between; gap:12px; box-shadow: 0 -8px 20px rgba(0,0,0,0.35); z-index:30; }
    .bulk-bar.visible { display:flex; }
    .bulk-summary { color: var(--muted); font-weight:700; letter-spacing:0.02em; }
    .bulk-actions { display:flex; gap:8px; flex-wrap:wrap; }
    .modal-backdrop { position: fixed; inset:0; background: rgba(0,0,0,0.65); display:none; align-items:center; justify-content:center; z-index: 50; padding:20px; }
    .modal-backdrop.visible { display:flex; }
    .modal { background: var(--panel-2); border:1px solid var(--border); border-radius:16px; width:min(1100px, 100%); height:82vh; max-height:82vh; overflow:hidden; box-shadow: var(--shadow); display:flex; flex-direction:column; }
    .modal-header { display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--border); background: linear-gradient(90deg, #171d2b, #111524); }
    .modal-title { font-weight:800; font-size:1rem; letter-spacing:0.02em; }
    .modal-close { background:none; border:none; color:var(--muted); font-size:1.2rem; cursor:pointer; }
    .modal-tabs { display:flex; gap:8px; padding:12px 16px 0; border-bottom:1px solid var(--border); }
    .modal-tab { padding:8px 12px; border-radius:10px 10px 0 0; background: rgba(255,255,255,0.03); border:1px solid transparent; color:var(--muted); font-weight:700; cursor:pointer; }
    .modal-tab.active { background: var(--panel); color: var(--text); border-color: var(--border); box-shadow: inset 0 -3px 0 var(--accent); }
    .modal-body { padding:16px; overflow-y:auto; flex:1; display:flex; flex-direction:column; gap:12px; min-height:0; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px; }
    .pill { padding:6px 10px; border-radius:999px; background: rgba(255,255,255,0.05); border:1px solid var(--border); font-size:0.8rem; display:inline-block; }
    .field { background: var(--panel); border:1px solid var(--border); border-radius:12px; padding:10px 12px; }
    .field h4 { margin:0 0 6px 0; color:var(--muted); font-size:0.85rem; letter-spacing:0.01em; }
    .kv { display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px solid var(--border); font-size:0.85rem; }
    .kv:last-child { border-bottom:none; }
    .badge { display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; background: rgba(49,196,255,0.12); color: var(--accent); font-size:0.8rem; }
    .muted { color: var(--muted); font-size:0.85rem; }
    .stats-row { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; }
    .stat-box { background: var(--panel); border:1px solid var(--border); border-radius:12px; padding:10px 12px; display:flex; flex-direction:column; gap:6px; }
    canvas { width:100%; height:160px; background: radial-gradient(circle at 20% 20%, rgba(49,196,255,0.05), transparent 35%); border-radius:10px; }
    .logs-area { background: #0d1018; border:1px solid var(--border); border-radius:12px; padding:10px; font-family:"JetBrains Mono", monospace; font-size:0.8rem; max-height:380px; overflow:auto; white-space:pre-wrap; }
    .logs-panel .logs-area { flex:1; max-height:unset; min-height:0; }
    .logs-area .log-line { padding:4px 8px; border-left:3px solid transparent; margin-bottom:2px; border-radius:8px; display:flex; gap:8px; align-items:flex-start; }
    .logs-area .log-line:last-child { margin-bottom:0; }
    .logs-area .log-bullet { opacity:0.4; }
    .logs-area .log-info { border-color:#31c4ff; background:rgba(49,196,255,0.06); }
    .logs-area .log-warn { border-color:#ffd54f; background:rgba(255,213,79,0.07); }
    .logs-area .log-error { border-color:#ff8a7a; background:rgba(255,138,122,0.08); }
    .logs-area .log-debug { border-color:#9aa7bd; background:rgba(154,167,189,0.06); color:#c5cee0; }
    .logs-area .log-other { border-color:rgba(255,255,255,0.08); }
    .controls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .select, .input { background: #0f141f; color: var(--text); border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:0.9rem; }
    .inline-btn { padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:#1d2535; color: var(--text); cursor:pointer; }
    .chip { background: rgba(255,255,255,0.05); border:1px solid var(--border); padding:4px 8px; border-radius:8px; font-size:0.8rem; }
    .small { font-size:0.8rem; color:var(--muted); }
    .table-kv { width:100%; border-collapse:collapse; }
    .table-kv td { padding:6px 4px; border-bottom:1px solid var(--border); font-size:0.85rem; }
    .table-kv tr:last-child td { border-bottom:none; }
    .tab-panel { display:none; }
    .tab-panel.active { display:block; }
    .tab-panel.logs-panel.active { display:flex; flex-direction:column; flex:1; min-height:0; }
    .toast-container { position:fixed; top:14px; left:0; right:0; display:flex; justify-content:center; gap:10px; pointer-events:none; z-index:60; }
    .toast { background: #1f2636; color: var(--text); border:1px solid var(--border); border-radius:12px; padding:10px 12px; min-width:240px; box-shadow: var(--shadow); opacity:0; transform: translateY(-12px); transition: all 0.2s ease; pointer-events:auto; display:flex; flex-direction:column; gap:8px; }
    .toast.visible { opacity:1; transform: translateY(0); }
    .toast-message { font-weight:700; font-size:0.9rem; }
    .toast-actions { display:flex; gap:8px; }
    .toast-actions button { border:none; border-radius:999px; padding:6px 10px; background: rgba(49,196,255,0.12); color: var(--text); cursor:pointer; font-weight:700; }
    .toast-info { border-color: rgba(49,196,255,0.25); }
    .toast-success { border-color: rgba(124,255,195,0.25); }
    .toast-error { border-color: rgba(255,138,122,0.25); }
    .toast-warning { border-color: rgba(255,213,79,0.35); }
    @media(max-width: 960px) {
      table, thead, tbody, th, td, tr { display:block; }
      thead { display:none; }
      tr { margin-bottom:10px; border:1px solid var(--border); border-radius:10px; overflow:hidden; }
      td { display:flex; justify-content: space-between; border-bottom:1px solid var(--border); }
      td::before { content: attr(data-label); font-weight:700; color: var(--muted); margin-right: 10px; }
    }
  </style>
  {% include 'partials/notifications_styles.html' %}
</head>
<body data-safe-mode="{{ '1' if safe_mode_enabled else '0' }}">
  <header>
    <div class="brand-line">
      <h1>D2HA <span class="brand-pill">Container</span></h1>
      {% include 'partials/notifications_panel.html' %}
    </div>
    <nav>
      <a href="{{ url_for('index') }}" class="tab {{ 'active' if active_page == 'home' else '' }}">Home</a>
      <a href="{{ url_for('containers_view') }}" class="tab {{ 'active' if active_page == 'containers' else '' }}">Container</a>
      <a href="{{ url_for('images_view') }}" class="tab {{ 'active' if active_page == 'images' else '' }}">Immagini</a>
      <a href="{{ url_for('updates') }}" class="tab {{ 'active' if active_page == 'updates' else '' }}">Aggiornamenti</a>
      <a href="{{ url_for('events_view') }}" class="tab {{ 'active' if active_page == 'events' else '' }}">Eventi</a>
      <a href="{{ url_for('autodiscovery_view') }}" class="tab {{ 'active' if active_page == 'autodiscovery' else '' }}">Autodiscovery</a>
    </nav>
  </header>

  <main>
    <div class="card">
      <div class="meta">{{ summary.running }} container attivi · {{ summary.total_containers }} totali · {{ summary.images }} immagini installate</div>
    </div>

    {% for stack in stacks %}
      <section class="card">
        <div class="stack-header stack-toggle" data-stack-toggle>
          <div class="stack-title">
            <button class="stack-toggle-btn" type="button" aria-expanded="true" aria-label="Mostra o nascondi sezione">
              <span class="chevron">▾</span>
            </button>
            <span>{{ 'Senza stack' if stack.name == '_no_stack' else stack.name }}</span>
          </div>
          <div class="stack-chip">{{ stack.containers|length }} container</div>
        </div>
        <div class="stack-content">
          <table>
            <thead>
              <tr>
                <th class="select-col" aria-label="Seleziona"></th>
                <th>Nome</th>
                <th>Stato</th>
                <th>Uptime</th>
                <th>CPU</th>
                <th>RAM</th>
                <th>Restart</th>
                <th>Reti</th>
                <th>Porte</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody>
              {% for c in stack.containers %}
                <tr class="row-clickable" data-container-id="{{ c.id }}" data-container-name="{{ c.name }}">
                  <td class="select-col" data-label="Seleziona">
                    <label class="checkbox">
                      <input type="checkbox" class="container-select" value="{{ c.id }}" data-container-name="{{ c.name }}" aria-label="Seleziona {{ c.name }}">
                      <span class="checkmark"></span>
                    </label>
                  </td>
                  <td data-label="Nome">
                    <div><strong>{{ c.name }}</strong></div>
                    <div class="meta">{{ c.image }}</div>
                    <div class="meta">{{ c.short_id }}</div>
                  </td>
                  <td data-label="Stato">
                    {% set status = c.status.lower() %}
                    {% set css = "status-pill " %}
                    {% if status == "running" %}
                      {% set css = css + "status-running" %}
                    {% elif status in ["exited", "stopped"] %}
                      {% set css = css + "status-exited" %}
                    {% elif status == "paused" %}
                      {% set css = css + "status-paused" %}
                    {% elif status == "restarting" %}
                      {% set css = css + "status-restarting" %}
                    {% else %}
                      {% set css = css + "status-paused" %}
                    {% endif %}
                    <span class="{{ css }}">{{ c.status }}</span>
                  </td>
                  <td data-label="Uptime">{{ c.uptime }}</td>
                  <td data-label="CPU">{{ c.cpu_percent }}%</td>
                  <td data-label="RAM">{{ c.mem_usage }} ({{ c.mem_percent }}%)</td>
                  <td data-label="Restart">{{ c.restarts }}</td>
                  <td data-label="Reti">
                    {% if c.networks %}
                      <div class="meta">
                        {% for net in c.networks %}
                          <div>{{ net.name }}{% if net.ip %} – {{ net.ip }}{% endif %}</div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <span class="meta">Nessuna rete</span>
                    {% endif %}
                  </td>
                  <td data-label="Porte">
                    {% if c.ports.mode == 'host' %}
                      <div class="meta">Modalità host</div>
                    {% elif c.ports.bindings %}
                      <div class="meta">
                        {% for port in c.ports.bindings %}
                          <div>{{ port }}</div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <span class="meta">Nessuna porta esposta</span>
                    {% endif %}
                  </td>
                  <td data-label="Azioni">
                    <div class="actions">
                      <button class="btn" type="button" data-open-modal data-container-id="{{ c.id }}" data-container-name="{{ c.name }}">Dettagli</button>
                      <button class="btn" type="button" data-open-logs data-container-id="{{ c.id }}" data-container-name="{{ c.name }}">Logs</button>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    {% endfor %}
  </main>

  <div class="bulk-bar" id="bulk-bar" aria-hidden="true">
    <div class="bulk-summary"><span id="bulk-count">0</span> container selezionati</div>
    <div class="bulk-actions">
      <button class="btn btn-play" type="button" data-bulk-action="start">Avvia</button>
      <button class="btn btn-stop" type="button" data-bulk-action="stop">Ferma</button>
      <button class="btn btn-restart" type="button" data-bulk-action="restart">Riavvia</button>
      <button class="btn btn-delete" type="button" data-bulk-action="delete">Elimina</button>
    </div>
  </div>

  <div class="modal-backdrop" id="container-modal" aria-hidden="true">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="modal-title">Dettagli container</div>
          <div class="small" id="modal-subtitle"></div>
        </div>
        <button class="modal-close" id="modal-close" aria-label="Chiudi">✕</button>
      </div>
      <div class="modal-tabs">
        <button class="modal-tab active" data-tab="info">Info</button>
        <button class="modal-tab" data-tab="logs">Logs</button>
        <button class="modal-tab" data-tab="updates">Aggiornamenti</button>
      </div>
      <div class="modal-body">
        <div class="tab-panel active" data-panel="info">
          <div class="grid">
            <div class="field">
              <h4>Stato</h4>
              <div id="info-status" class="badge">-</div>
            </div>
            <div class="field">
              <h4>Uptime</h4>
              <div id="info-uptime">-</div>
            </div>
            <div class="field">
              <h4>Riavvio</h4>
              <div id="info-restart">-</div>
            </div>
            <div class="field">
              <h4>Immagine</h4>
              <div id="info-image">-</div>
              <div class="muted" id="info-short-id"></div>
            </div>
          </div>

          <div class="stats-row">
            <div class="stat-box">
              <div class="kv"><span>CPU</span><strong id="stat-cpu">-</strong></div>
              <canvas id="chart-cpu"></canvas>
            </div>
            <div class="stat-box">
              <div class="kv"><span>RAM</span><strong id="stat-ram">-</strong></div>
              <canvas id="chart-ram"></canvas>
            </div>
            <div class="stat-box">
              <div class="kv"><span>Network</span><strong id="stat-net">-</strong></div>
              <canvas id="chart-net"></canvas>
            </div>
          </div>

          <div class="grid">
            <div class="field">
              <h4>Reti</h4>
              <div id="info-networks" class="muted">-</div>
            </div>
            <div class="field">
              <h4>Porte</h4>
              <div id="info-ports" class="muted">-</div>
            </div>
            <div class="field">
              <h4>Volumi</h4>
              <div id="info-volumes" class="muted">-</div>
            </div>
            <div class="field">
              <h4>Command</h4>
              <div id="info-command" class="muted">-</div>
            </div>
          </div>

          <div class="grid">
            <div class="field">
              <h4>Environment</h4>
              <table class="table-kv" id="info-env"></table>
            </div>
            <div class="field">
              <h4>Label</h4>
              <table class="table-kv" id="info-labels"></table>
            </div>
          </div>
        </div>

        <div class="tab-panel logs-panel" data-panel="logs">
          <div class="controls">
            <label class="muted"><input type="checkbox" id="logs-auto" checked> Auto-refresh</label>
            <label class="muted">Linee
              <select id="logs-tail" class="select">
                <option value="10">10</option>
                <option value="50">50</option>
                <option value="100" selected>100</option>
                <option value="150">150</option>
                <option value="500">500</option>
                <option value="all">Senza limiti</option>
              </select>
            </label>
            <button class="inline-btn" id="logs-refresh">Aggiorna ora</button>
          </div>
          <pre class="logs-area" id="logs-output">Seleziona un container...</pre>
        </div>

        <div class="tab-panel" data-panel="updates">
          <div class="grid">
            <div class="field">
              <h4>Immagine</h4>
              <div id="updates-image">-</div>
              <a href="#" id="updates-repo" class="small" target="_blank" rel="noreferrer">Repository</a>
            </div>
            <div class="field">
              <h4>Versioni</h4>
              <div class="kv"><span>Installata</span><span id="updates-installed">-</span></div>
              <div class="kv"><span>Remota</span><span id="updates-remote">-</span></div>
            </div>
            <div class="field">
              <h4>Stato</h4>
              <div id="updates-state" class="badge">-</div>
            </div>
          </div>
          <div class="controls">
            <label class="muted">Frequenza controllo
              <select id="updates-frequency" class="select">
                <option value="15">15 min</option>
                <option value="30">30 min</option>
                <option value="60" selected>1 ora</option>
                <option value="180">3 ore</option>
                <option value="720">12 ore</option>
                <option value="1440">Ogni giorno</option>
              </select>
            </label>
            <button class="inline-btn" id="updates-save">Salva</button>
            <button class="inline-btn" id="updates-check">Check now</button>
          </div>
          <div id="updates-feedback" class="small"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="toast-container" id="toast-container"></div>
  {% include 'partials/notifications_script.html' %}
  <script>
    const stackToggles = Array.from(document.querySelectorAll('[data-stack-toggle]'));
    stackToggles.forEach((header) => {
      const btn = header.querySelector('.stack-toggle-btn');
      const content = header.nextElementSibling;
      const chevron = btn ? btn.querySelector('.chevron') : null;
      if (!btn || !content) return;

      const setExpanded = (expanded) => {
        content.classList.toggle('collapsed', !expanded);
        btn.setAttribute('aria-expanded', expanded);
        if (chevron) chevron.textContent = expanded ? '▾' : '▸';
      };

      setExpanded(true);

      const toggle = () => {
        const isExpanded = btn.getAttribute('aria-expanded') === 'true';
        setExpanded(!isExpanded);
      };

      btn.addEventListener('click', (event) => {
        event.stopPropagation();
        toggle();
      });

      header.addEventListener('click', (event) => {
        if (event.target === btn || btn.contains(event.target)) return;
        toggle();
      });
    });

    const modalEl = document.getElementById('container-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalSubtitle = document.getElementById('modal-subtitle');
    const tabButtons = Array.from(document.querySelectorAll('.modal-tab'));
    const tabPanels = Array.from(document.querySelectorAll('.tab-panel'));
    const logOutput = document.getElementById('logs-output');
    const logAuto = document.getElementById('logs-auto');
    const logTail = document.getElementById('logs-tail');
    const logRefreshBtn = document.getElementById('logs-refresh');
    const updatesFrequency = document.getElementById('updates-frequency');
    const updatesSave = document.getElementById('updates-save');
    const updatesCheck = document.getElementById('updates-check');
    const updatesFeedback = document.getElementById('updates-feedback');
    const toastContainer = document.getElementById('toast-container');
    const bulkBar = document.getElementById('bulk-bar');
    const bulkCount = document.getElementById('bulk-count');
    const bulkButtons = Array.from(document.querySelectorAll('[data-bulk-action]'));
    const selectionInputs = Array.from(document.querySelectorAll('.container-select'));

    let currentContainerId = null;
    let statsInterval = null;
    let logsInterval = null;
    let statsHistory = { cpu: [], ram: [], net: [] };
    let lastNet = null;
    const selectedContainers = new Map();

    const showToast = (message, { type = 'info', actions = [] } = {}) => {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `<div class="toast-message">${message}</div>`;

      if (actions.length) {
        const actionBar = document.createElement('div');
        actionBar.className = 'toast-actions';
        actions.forEach(({ label, onClick }) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = label;
          btn.addEventListener('click', () => {
            onClick?.();
            toast.remove();
          });
          actionBar.appendChild(btn);
        });
        toast.appendChild(actionBar);
      }

      toastContainer.appendChild(toast);
      requestAnimationFrame(() => toast.classList.add('visible'));

      const lifetime = actions.length ? 6500 : 4200;
      setTimeout(() => {
        toast.classList.remove('visible');
        setTimeout(() => toast.remove(), 350);
      }, lifetime);
    };

    const updateBulkBar = () => {
      const count = selectedContainers.size;
      bulkCount.textContent = count;
      const visible = count > 0;
      bulkBar.classList.toggle('visible', visible);
      bulkBar.setAttribute('aria-hidden', visible ? 'false' : 'true');
    };

    const toggleSelection = (input) => {
      const id = input.value;
      if (!id) return;
      if (input.checked) {
        selectedContainers.set(id, input.dataset.containerName || 'Container');
      } else {
        selectedContainers.delete(id);
      }
      updateBulkBar();
    };

    selectionInputs.forEach((input) => {
      input.addEventListener('change', (e) => {
        toggleSelection(e.target);
        e.stopPropagation();
      });
      input.addEventListener('click', (e) => e.stopPropagation());
    });

    const performBulkAction = async (action) => {
      const ids = Array.from(selectedContainers.keys());
      if (!ids.length) return;

      const labelMap = {
        start: 'avvio',
        stop: 'stop',
        restart: 'riavvio',
        delete: 'eliminazione',
      };

      try {
        await Promise.all(ids.map((id) => fetch(`/containers/${id}/${action}`, { method: 'POST' })));
        showToast(`Azione di ${labelMap[action] || action} inviata a ${ids.length} container`, { type: 'success' });
        setTimeout(() => window.location.reload(), 500);
      } catch (err) {
        console.error(err);
        showToast("Errore nell'eseguire l'azione selezionata", { type: 'error' });
      }
    };

    const formatBytes = (bytes) => {
      if (bytes === 0) return '0B';
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return `${(bytes / Math.pow(1024, i)).toFixed(1)}${sizes[i]}`;
    };

    const drawSpark = (canvas, data, color, maxValue = null) => {
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0, 0, w, h);
      if (!data.length) return;
      const maxVal = maxValue || Math.max(...data, 1);
      const step = w / Math.max(data.length - 1, 1);
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      data.forEach((val, idx) => {
        const x = idx * step;
        const y = h - (val / maxVal) * (h - 10);
        if (idx === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
    };

    const setPanel = (name) => {
      tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === name));
      tabPanels.forEach(panel => panel.classList.toggle('active', panel.dataset.panel === name));
    };

    const renderList = (target, items, formatter, emptyText = 'Nessun dato') => {
      if (!items || !items.length) {
        target.textContent = emptyText;
        return;
      }
      target.innerHTML = items.map(formatter).join('');
    };

    const renderTable = (table, items) => {
      table.innerHTML = '';
      if (!items || !items.length) {
        table.innerHTML = '<tr><td class="muted">Nessun dato</td></tr>';
        return;
      }
      items.forEach(item => {
        const row = document.createElement('tr');
        const k = document.createElement('td');
        k.textContent = item.key;
        const v = document.createElement('td');
        v.textContent = item.value;
        row.appendChild(k);
        row.appendChild(v);
        table.appendChild(row);
      });
    };

    const fetchJSON = async (url, options = {}) => {
      const res = await fetch(url, options);
      if (!res.ok) throw new Error('Request failed');
      return res.json();
    };

    const updateDetails = async () => {
      if (!currentContainerId) return;
      try {
        const data = await fetchJSON(`/api/containers/${currentContainerId}/details`);
        modalSubtitle.textContent = data.id;
        document.getElementById('info-status').textContent = data.status;
        document.getElementById('info-uptime').textContent = data.uptime || '-';
        document.getElementById('info-restart').textContent = data.restart_policy || '-';
        document.getElementById('info-image').textContent = data.image;
        document.getElementById('info-short-id').textContent = data.short_id;
        document.getElementById('info-command').textContent = data.command || '-';

        const networks = document.getElementById('info-networks');
        renderList(networks, data.networks, (n) => `<div class="chip">${n.name}${n.ip ? ' – ' + n.ip : ''}</div>`);

        const ports = document.getElementById('info-ports');
        const portVals = data.ports && data.ports.bindings ? data.ports.bindings : [];
        renderList(ports, portVals, (p) => `<div class="chip">${p}</div>`, 'Nessuna porta esposta');

        const volumes = document.getElementById('info-volumes');
        renderList(
          volumes,
          data.mounts,
          (m) => `<div class="chip">${m.source || '-'} → ${m.destination || '-'}</div>`,
          'Nessun volume'
        );

        renderTable(document.getElementById('info-env'), data.env);
        renderTable(document.getElementById('info-labels'), data.labels);
      } catch (err) {
        console.error(err);
      }
    };

    const updateStats = async () => {
      if (!currentContainerId) return;
      try {
        const data = await fetchJSON(`/api/containers/${currentContainerId}/stats`);
        const cpuText = `${data.cpu_percent}%`;
        const memText = `${formatBytes(data.mem_usage)} / ${formatBytes(data.mem_limit || 1)} (${data.mem_percent}%)`;
        const netDelta = lastNet
          ? { rx: Math.max(data.net_rx - lastNet.rx, 0), tx: Math.max(data.net_tx - lastNet.tx, 0) }
          : { rx: 0, tx: 0 };
        lastNet = { rx: data.net_rx, tx: data.net_tx };
        const netText = `↓ ${formatBytes(netDelta.rx)} · ↑ ${formatBytes(netDelta.tx)}`;

        document.getElementById('stat-cpu').textContent = cpuText;
        document.getElementById('stat-ram').textContent = memText;
        document.getElementById('stat-net').textContent = netText;

        statsHistory.cpu.push(data.cpu_percent);
        statsHistory.ram.push(data.mem_percent);
        statsHistory.net.push(netDelta.rx + netDelta.tx);
        statsHistory.cpu = statsHistory.cpu.slice(-40);
        statsHistory.ram = statsHistory.ram.slice(-40);
        statsHistory.net = statsHistory.net.slice(-40);

        drawSpark(document.getElementById('chart-cpu'), statsHistory.cpu, '#31c4ff', 100);
        drawSpark(document.getElementById('chart-ram'), statsHistory.ram, '#8ef0c5', 100);
        drawSpark(document.getElementById('chart-net'), statsHistory.net, '#ffbf69');
      } catch (err) {
        console.error(err);
      }
    };

    const escapeHtml = (str) =>
      str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

    const getLogLevel = (line) => {
      const upper = line.toUpperCase();
      if (upper.includes('ERROR') || upper.includes('ERR')) return 'log-error';
      if (upper.includes('WARN')) return 'log-warn';
      if (upper.includes('DEBUG')) return 'log-debug';
      if (upper.includes('INFO')) return 'log-info';
      return 'log-other';
    };

    const renderLogs = (logs) => {
      if (!logs) {
        logOutput.textContent = 'Nessun log disponibile';
        return;
      }

      const lines = logs.split(/\r?\n/);
      const html = lines
        .filter((line) => line !== '')
        .map((line) => {
          const levelClass = getLogLevel(line);
          return `<div class="log-line ${levelClass}"><span class="log-bullet">•</span><span>${escapeHtml(line)}</span></div>`;
        })
        .join('');

      logOutput.innerHTML = html || '<div class="muted">Nessun log disponibile</div>';
    };

    const updateLogs = async () => {
      if (!currentContainerId) return;
      try {
        const tail = logTail.value;
        const data = await fetchJSON(`/api/containers/${currentContainerId}/logs?tail=${tail}`);
        renderLogs(data.logs);
      } catch (err) {
        logOutput.textContent = 'Impossibile recuperare i log';
      }
    };

    const updateUpdates = async (force = false) => {
      if (!currentContainerId) return;
      try {
        const url = `/api/containers/${currentContainerId}/updates`;
        const data = await fetchJSON(url, force ? { method: 'POST' } : {});
        document.getElementById('updates-image').textContent = data.image_ref;
        document.getElementById('updates-repo').href = data.repo_link || '#';
        document.getElementById('updates-installed').textContent = data.installed_version || '-';
        document.getElementById('updates-remote').textContent = data.remote_version || '-';
        document.getElementById('updates-state').textContent = data.update_state;
        updatesFrequency.value = data.frequency_minutes?.toString() || '60';
        updatesFeedback.textContent = '';
        return data;
      } catch (err) {
        updatesFeedback.textContent = 'Impossibile recuperare le informazioni';
        return null;
      }
    };

    const installUpdates = async () => {
      if (!currentContainerId) return;
      showToast('Installazione aggiornamento in corso...', { type: 'info' });
      try {
        const res = await fetch(`/containers/${currentContainerId}/full_update`, { method: 'POST' });
        if (!res.ok) throw new Error('fail');
        showToast('Aggiornamento avviato', { type: 'success' });
        await updateUpdates(true);
      } catch (err) {
        showToast('Impossibile avviare l\'aggiornamento', { type: 'error' });
      }
    };

    const startPolling = () => {
      clearInterval(statsInterval);
      clearInterval(logsInterval);
      statsInterval = setInterval(updateStats, 3000);
      if (logAuto.checked) {
        logsInterval = setInterval(updateLogs, 4000);
      }
    };

    const stopPolling = () => {
      clearInterval(statsInterval);
      clearInterval(logsInterval);
    };

    const openModal = (id, name, initialTab = 'info') => {
      currentContainerId = id;
      modalTitle.textContent = name;
      statsHistory = { cpu: [], ram: [], net: [] };
      lastNet = null;
      modalEl.classList.add('visible');
      modalEl.setAttribute('aria-hidden', 'false');
      setPanel(initialTab);
      updateDetails();
      updateStats();
      updateLogs();
      updateUpdates();
      startPolling();
    };

    const closeModal = () => {
      stopPolling();
      modalEl.classList.remove('visible');
      modalEl.setAttribute('aria-hidden', 'true');
      currentContainerId = null;
    };

    document.getElementById('modal-close').addEventListener('click', closeModal);
    modalEl.addEventListener('click', (e) => {
      if (e.target === modalEl) closeModal();
    });

    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => setPanel(btn.dataset.tab));
    });

    document.querySelectorAll('[data-open-modal]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        openModal(btn.dataset.containerId, btn.dataset.containerName);
      });
    });

    document.querySelectorAll('[data-open-logs]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        openModal(btn.dataset.containerId, btn.dataset.containerName, 'logs');
      });
    });

    bulkButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        performBulkAction(btn.dataset.bulkAction);
      });
    });

    document.querySelectorAll('.row-clickable').forEach(row => {
      row.addEventListener('click', (e) => {
        if (e.target.closest('form')) return;
        if (e.target.closest('button') && !e.target.dataset.openModal) return;
        if (e.target.closest('.container-select')) return;
        openModal(row.dataset.containerId, row.dataset.containerName);
      });
    });

    logRefreshBtn.addEventListener('click', () => {
      updateLogs();
    });

    logAuto.addEventListener('change', () => {
      if (logAuto.checked) {
        logsInterval = setInterval(updateLogs, 4000);
      } else {
        clearInterval(logsInterval);
      }
    });

    updatesSave.addEventListener('click', async () => {
      if (!currentContainerId) return;
      try {
        const minutes = parseInt(updatesFrequency.value, 10) || 60;
        const data = await fetchJSON(`/api/containers/${currentContainerId}/updates/frequency`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ minutes })
        });
        updatesFeedback.textContent = `Frequenza salvata (${data.minutes} min)`;
      } catch (err) {
        updatesFeedback.textContent = 'Errore nel salvataggio';
      }
    });

    updatesCheck.addEventListener('click', async () => {
      updatesFeedback.textContent = 'Verifica in corso...';
      const data = await updateUpdates(true);
      updatesFeedback.textContent = 'Verifica completata';
      if (!data) return;

      if (data.update_state === 'up_to_date') {
        showToast('Il container è già aggiornato', { type: 'success' });
      } else if (data.update_state === 'update_available') {
        showToast('Aggiornamento disponibile. Vuoi installarlo?', {
          type: 'warning',
          actions: [
            { label: 'Installa', onClick: installUpdates },
            { label: 'Annulla' },
          ],
        });
      }
    });

    const params = new URLSearchParams(window.location.search);
    const initialContainerId = params.get('container');
    const initialTab = params.get('tab') || 'info';
    if (initialContainerId) {
      const targetRow = document.querySelector(`[data-container-id="${initialContainerId}"]`);
      const targetName = targetRow?.dataset?.containerName || 'Container';
      openModal(initialContainerId, targetName, initialTab);
    }
  </script>
</body>
</html>
