<!DOCTYPE html>
<html lang="{{ get_current_lang() }}">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D2HA ‚Äì Sicurezza</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/d2ha-theme.css') }}">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--font-base);
      background: var(--gradient-overlay), var(--color-bg);
      color: var(--color-text);
      min-height: 100vh;
    }
    a { color: inherit; text-decoration: none; }
    header {
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
      padding: var(--space-10) var(--space-12) var(--space-8);
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: var(--shadow-sm);
    }
    .brand-line {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-6);
      flex-wrap: wrap;
    }
    .brand-line h1 {
      margin: 0;
      font-size: 1.25rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      text-align: center;
    }
    nav {
      margin-top: var(--space-6);
      display: flex;
      gap: var(--space-4);
      flex-wrap: wrap;
    }
    .tab {
      padding: var(--space-5) var(--space-8);
      border-radius: 10px;
      background: var(--color-surface-muted);
      color: var(--color-muted);
      font-weight: 700;
      border: 1px solid transparent;
      transition: all 0.15s ease;
    }
    .tab:hover { color: var(--color-text); border-color: var(--color-border); }
    .tab.active {
      background: var(--gradient-accent);
      color: var(--color-on-accent);
      box-shadow: 0 6px 18px var(--color-accent-glow-soft);
    }
    .logout-link { margin-left: auto; }
    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: var(--space-12) var(--space-12) var(--space-16);
      display: flex;
      flex-direction: column;
      gap: var(--space-10);
    }
    .card { padding: 0; }
    .card-body { padding: var(--space-12); display: grid; gap: var(--space-10); }
    .card-header {
      padding: var(--space-10) var(--space-12);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: var(--space-8);
      flex-wrap: wrap;
    }
    .card-header h2, .card-header h3 { margin: 0; letter-spacing: 0.01em; }
    .muted { color: var(--color-muted); }
    .eyebrow { text-transform: uppercase; letter-spacing: 0.08em; font-size: var(--font-size-xs); margin: 0 0 var(--space-3); color: var(--color-muted); }
    .form-grid { display: grid; gap: var(--space-8); }
    .form-field { display: grid; gap: var(--space-3); }
    .form-label { font-weight: 700; color: var(--color-muted); font-size: var(--font-size-sm); }
    .help-text { color: var(--color-muted); font-size: var(--font-size-sm); }
    .actions { display: flex; gap: var(--space-6); flex-wrap: wrap; align-items: center; }
    .status-stack { display: flex; gap: var(--space-4); flex-wrap: wrap; align-items: center; }
    .password-input-wrapper { position: relative; display: flex; align-items: center; }
    .password-input-wrapper .input { padding-right: 44px; }
    .password-toggle {
      position: absolute;
      top: 50%;
      right: var(--space-4);
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--color-muted);
      cursor: pointer;
      padding: var(--space-3);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-control);
      transition: color 0.15s ease, background 0.15s ease;
    }
    .password-toggle:hover { color: var(--color-text); background: var(--color-surface-muted); }
    .pending-box {
      border-top: 1px dashed var(--color-border);
      padding: var(--space-10) 0 0;
      display: grid;
      gap: var(--space-6);
    }
    .qr-box { display: grid; gap: var(--space-6); align-items: center; grid-template-columns: auto 1fr; }
    .qr-box img { background: white; padding: var(--space-4); border-radius: var(--radius-control); box-shadow: var(--shadow-sm); }
    .secret-chip { padding: var(--space-4) var(--space-8); border-radius: var(--radius-pill); background: var(--color-surface-muted); border: 1px solid var(--color-border); display: inline-block; font-weight: 700; }
    @media (max-width: 700px) {
      .qr-box { grid-template-columns: 1fr; }
      nav { justify-content: flex-start; }
    }
  </style>
  {% include 'partials/notifications_styles.html' %}
</head>
<body class="theme-{{ get_current_theme() }}" data-safe-mode="{{ '1' if safe_mode_enabled else '0' }}" data-performance-mode="{{ '1' if performance_mode_enabled else '0' }}">
  <header>
    <div class="brand-line">
      <h1>D2HA</h1>
      {% include 'partials/notifications_panel.html' %}
    </div>
    <nav>
      <a href="{{ url_for('index') }}" class="tab {{ 'active' if active_page == 'home' else '' }}">Home</a>
      <a href="{{ url_for('containers_view') }}" class="tab {{ 'active' if active_page == 'containers' else '' }}">{{ t("nav.containers") }}</a>
      <a href="{{ url_for('images_view') }}" class="tab {{ 'active' if active_page == 'images' else '' }}">{{ t("nav.images") }}</a>
      <a href="{{ url_for('updates') }}" class="tab {{ 'active' if active_page == 'updates' else '' }}">{{ t("nav.updates") }}</a>
      <a href="{{ url_for('events_view') }}" class="tab {{ 'active' if active_page == 'events' else '' }}">{{ t("nav.events") }}</a>
      <a href="{{ url_for('autodiscovery_view') }}" class="tab {{ 'active' if active_page == 'autodiscovery' else '' }}">{{ t("nav.autodiscovery") }}</a>
      <a href="{{ url_for('logout') }}" class="tab logout-link">{{ t("nav.logout") }}</a>
    </nav>
  </header>

  <main>
    {% include 'partials/flash_messages.html' %}

    <section class="card">
      <div class="card-header">
        <div>
          <p class="eyebrow">Sicurezza</p>
          <h2>Impostazioni di sicurezza</h2>
          <p class="muted">Aggiorna le credenziali admin, gestisci il timeout di sessione e proteggi l'accesso con la 2FA.</p>
        </div>
        <div class="status-stack">
          <span class="status-pill {{ 'success' if two_factor_enabled else 'warn' }}">2FA {{ 'attiva' if two_factor_enabled else 'non abilitata' }}</span>
          <span class="status-pill info">Certificati: gestiti esternamente</span>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <div>
          <p class="eyebrow">Sessione</p>
          <h3>Timeout di sessione</h3>
          <p class="muted">Configura il logout automatico per inattivit√†.</p>
        </div>
      </div>
      <div class="card-body">
        <form method="POST" class="form-grid">
          <input type="hidden" name="action" value="update_session_timeout" />
          <div class="form-field">
            <label class="form-label">Password attuale</label>
            <div class="password-input-wrapper">
              <input type="password" name="current_password" class="input" autocomplete="current-password" required />
              <button type="button" class="password-toggle" aria-label="{{ t('password.toggle.show') }}" title="{{ t('password.toggle.show') }}">üëÅ</button>
            </div>
          </div>
          {% if two_factor_enabled %}
          <div class="form-field">
            <label class="form-label">Codice 2FA corrente</label>
            <input type="text" name="current_totp_code" class="input" inputmode="numeric" autocomplete="one-time-code" />
          </div>
          {% endif %}
          <div class="form-field">
            <label class="form-label">{{ t('security.session_timeout_label') }}</label>
            <p class="help-text">{{ t('security.session_timeout_hint') }}</p>
            <input type="number" name="session_timeout_minutes" class="input" min="1" max="1440" value="{{ session_timeout_minutes }}" required />
          </div>
          <div class="actions">
            <button type="submit" class="btn-primary">Salva timeout</button>
          </div>
        </form>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <div>
          <p class="eyebrow">Credenziali</p>
          <h3>Cambia credenziali</h3>
          <p class="muted">Aggiorna username e/o password. Richiede la password attuale e, se attiva, anche un codice 2FA.</p>
        </div>
      </div>
      <div class="card-body">
        <form method="POST" class="form-grid">
          <input type="hidden" name="action" value="change_credentials" />
          <div class="form-field">
            <label class="form-label">Password attuale</label>
            <div class="password-input-wrapper">
              <input type="password" name="current_password" class="input" autocomplete="current-password" required />
              <button type="button" class="password-toggle" aria-label="{{ t('password.toggle.show') }}" title="{{ t('password.toggle.show') }}">üëÅ</button>
            </div>
          </div>
          {% if two_factor_enabled %}
          <div class="form-field">
            <label class="form-label">Codice 2FA corrente</label>
            <input type="text" name="current_totp_code" class="input" inputmode="numeric" autocomplete="one-time-code" />
          </div>
          {% endif %}
          <div class="form-field">
            <label class="form-label">Nuovo username (facoltativo)</label>
            <input type="text" name="new_username" class="input" value="{{ current_username }}" autocomplete="username" />
          </div>
          <div class="form-field">
            <label class="form-label">Nuova password (facoltativa)</label>
            <div class="password-input-wrapper">
              <input type="password" name="new_password" class="input" autocomplete="new-password" />
              <button type="button" class="password-toggle" aria-label="{{ t('password.toggle.show') }}" title="{{ t('password.toggle.show') }}">üëÅ</button>
            </div>
          </div>
          <div class="form-field">
            <label class="form-label">Conferma nuova password</label>
            <div class="password-input-wrapper">
              <input type="password" name="new_password_confirm" class="input" autocomplete="new-password" />
              <button type="button" class="password-toggle" aria-label="{{ t('password.toggle.show') }}" title="{{ t('password.toggle.show') }}">üëÅ</button>
            </div>
          </div>
          <div class="actions">
            <button type="submit" class="btn-primary">Aggiorna credenziali</button>
            <span class="help-text">Minimo 10 caratteri e niente "admin".</span>
          </div>
        </form>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <div>
          <p class="eyebrow">Secondo fattore</p>
          <h3>Autenticazione a due fattori</h3>
          <p class="muted">Proteggi l'accesso con un secondo fattore TOTP (Google Authenticator, Aegis...).</p>
        </div>
        <div class="status-stack">
          <span class="status-pill {{ 'success' if two_factor_enabled else 'warn' }}">2FA {{ 'attiva' if two_factor_enabled else 'non abilitata' }}</span>
        </div>
      </div>
      <div class="card-body">
        {% if not two_factor_enabled %}
          <form method="POST" class="form-grid">
            <input type="hidden" name="action" value="enable_2fa" />
            <div class="form-field">
              <label class="form-label">Password attuale</label>
              <div class="password-input-wrapper">
                <input type="password" name="current_password" class="input" autocomplete="current-password" required />
                <button type="button" class="password-toggle" aria-label="{{ t('password.toggle.show') }}" title="{{ t('password.toggle.show') }}">üëÅ</button>
              </div>
            </div>
            <div class="actions">
              <button type="submit" class="btn-primary">Abilita 2FA</button>
              <span class="help-text">Richiede conferma con un codice generato.</span>
            </div>
          </form>
        {% else %}
          <form method="POST" class="form-grid">
            <input type="hidden" name="action" value="disable_2fa" />
            <div class="form-field">
              <label class="form-label">Password attuale</label>
              <div class="password-input-wrapper">
                <input type="password" name="current_password" class="input" autocomplete="current-password" required />
                <button type="button" class="password-toggle" aria-label="{{ t('password.toggle.show') }}" title="{{ t('password.toggle.show') }}">üëÅ</button>
              </div>
            </div>
            <div class="form-field">
              <label class="form-label">Codice 2FA corrente</label>
              <input type="text" name="current_totp_code" class="input" inputmode="numeric" autocomplete="one-time-code" required />
            </div>
            <div class="actions">
              <button type="submit" class="btn-secondary">Disabilita 2FA</button>
              <span class="help-text">Servono password e codice valido.</span>
            </div>
          </form>
        {% endif %}

        {% if pending_2fa_setup and provisioning_uri %}
          <div class="pending-box">
            <p><strong>Setup 2FA in sospeso.</strong> Scansiona il QR o inserisci la chiave segreta, quindi verifica con un codice generato.</p>
            <div class="qr-box">
              {% if qr_code_data_uri %}
                <img src="{{ qr_code_data_uri }}" alt="QR 2FA" width="180" height="180" />
              {% endif %}
              <div>
                <div class="secret-chip">Segreto: {{ totp_secret or 'n/d' }}</div>
                <p class="muted" style="word-break: break-all;">URI: {{ provisioning_uri }}</p>
              </div>
            </div>
            <form method="POST" class="form-grid">
              <input type="hidden" name="action" value="confirm_enable_2fa" />
              <div class="form-field">
                <label class="form-label">Inserisci un codice generato dall'app</label>
                <input type="text" name="verify_totp_code" class="input" inputmode="numeric" autocomplete="one-time-code" required />
              </div>
              <div class="actions">
                <button type="submit" class="btn-primary">Conferma e abilita 2FA</button>
              </div>
            </form>
          </div>
        {% endif %}
      </div>
    </section>
  </main>

  <script>
    (function enhancePasswordInputs() {
      const showLabel = '{{ t('password.toggle.show') }}';
      const hideLabel = '{{ t('password.toggle.hide') }}';

      document.querySelectorAll('input[type="password"]').forEach((input) => {
        const existingWrapper = input.closest('.password-input-wrapper');
        const wrapper = existingWrapper || (() => {
          const created = document.createElement('div');
          created.className = 'password-input-wrapper';
          input.parentNode.insertBefore(created, input);
          created.appendChild(input);
          return created;
        })();

        let toggle = wrapper.querySelector('.password-toggle');
        if (!toggle) {
          toggle = document.createElement('button');
          toggle.type = 'button';
          toggle.className = 'password-toggle';
          wrapper.appendChild(toggle);
        }

        if (toggle.dataset.bound === 'true') return;

        const updateState = (isHidden) => {
          toggle.setAttribute('aria-label', isHidden ? showLabel : hideLabel);
          toggle.title = isHidden ? showLabel : hideLabel;
          toggle.textContent = isHidden ? 'üëÅ' : 'üôà';
        };

        updateState(true);

        toggle.addEventListener('click', () => {
          const isHidden = input.type === 'password';
          input.type = isHidden ? 'text' : 'password';
          updateState(!isHidden);
        });

        toggle.dataset.bound = 'true';
      });
    })();
  </script>

  {% include 'partials/notifications_script.html' %}
</body>
</html>
