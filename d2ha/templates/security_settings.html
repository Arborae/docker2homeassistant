<!DOCTYPE html>
<html lang="{{ get_current_lang() }}">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D2HA ‚Äì Sicurezza</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/favicon.png') }}">
  {% include 'partials/notifications_styles.html' %}
</head>

<body class="theme-{{ get_current_theme() }}" data-safe-mode="{{ '1' if safe_mode_enabled else '0' }}"
  data-performance-mode="{{ '1' if performance_mode_enabled else '0' }}"
  data-debug-mode="{{ '1' if debug_mode_enabled else '0' }}">
  <header>
    <div class="header-shell">
      {% include 'partials/notifications_panel.html' %}
      <nav id="primaryNav" role="navigation">
        <a href="{{ url_for('ui.index') }}" class="tab {{ 'active' if active_page == 'home' else '' }}">Home</a>
        <a href="{{ url_for('ui.containers_view') }}"
          class="tab {{ 'active' if active_page == 'containers' else '' }}">{{
          t("nav.containers") }}</a>
        <a href="{{ url_for('ui.images_view') }}" class="tab {{ 'active' if active_page == 'images' else '' }}">{{
          t("nav.images") }}</a>
        <a href="{{ url_for('ui.volumes_view') }}" class="tab {{ 'active' if active_page == 'volumes' else '' }}">{{
          t("nav.volumes") }}</a>
        <a href="{{ url_for('ui.networks_view') }}" class="tab {{ 'active' if active_page == 'networks' else '' }}">{{
          t("nav.networks") }}</a>
        <a href="{{ url_for('ui.updates') }}" class="tab {{ 'active' if active_page == 'updates' else '' }}">{{
          t("nav.updates") }}</a>
        <a href="{{ url_for('ui.events_view') }}" class="tab {{ 'active' if active_page == 'events' else '' }}">{{
          t("nav.events") }}</a>
        <a href="{{ url_for('ui.autodiscovery_view') }}"
          class="tab {{ 'active' if active_page == 'autodiscovery' else '' }}">{{ t("nav.autodiscovery") }}</a>
        <a href="{{ url_for('auth.logout') }}" class="tab logout-link">{{ t("nav.logout") }}</a>
      </nav>
    </div>
  </header>

  {% include 'partials/flash_messages.html' %}

  <div class="layout layout-single">
    <main>
      <div class="page-header">
        <div class="page-eyebrow">Configurazione</div>
        <h1 class="page-title">Impostazioni di sicurezza</h1>
        <p class="page-subtitle">Questa pagina ti permette di aggiornare le credenziali admin e gestire la 2FA.
          L'account controlla Docker su questo host: usa password robuste e preferisci sempre la 2FA.</p>
      </div>

      <div class="grid">
        <!-- Session Timeout Card -->
        <div class="card">
          <div class="flex-between">
            <h2>Timeout di sessione</h2>
          </div>
          <p class="muted small" style="margin-top: 4px; margin-bottom: 16px;">Configura il logout automatico per
            inattivit√†.</p>
          <form method="POST">
            <input type="hidden" name="action" value="update_session_timeout" />
            <div class="form-control">
              <label>Password attuale</label>
              <div class="password-input-wrapper">
                <input class="input" type="password" name="current_password" autocomplete="current-password" required />
                <button type="button" class="password-toggle" aria-label="{{ t('password.toggle.show') }}"
                  title="{{ t('password.toggle.show') }}">üëÅ</button>
              </div>
            </div>

            {% if two_factor_enabled %}
            <div class="form-control">
              <label>Codice 2FA corrente</label>
              <input class="input" type="text" name="current_totp_code" inputmode="numeric"
                autocomplete="one-time-code" />
            </div>
            {% endif %}

            <div class="form-control">
              <label>{{ t('security.session_timeout_label') }}</label>
              <div class="status-chip"
                style="margin-bottom:8px; background:transparent; padding:0; border:none; color:var(--muted); font-weight:400;">
                {{ t('security.session_timeout_hint') }}</div>
              <input class="input" type="number" name="session_timeout_minutes" min="1" max="1440"
                value="{{ session_timeout_minutes }}" required />
            </div>

            <div class="actions" style="margin-top: 12px;">
              <button type="submit" class="btn-primary-glow">Salva timeout</button>
            </div>
          </form>
        </div>

        <!-- Credentials Card -->
        <div class="card">
          <h2>Cambia credenziali</h2>
          <p class="muted small" style="margin-top: 4px; margin-bottom: 16px;">Aggiorna username e/o password. Richiede
            la password attuale e, se attiva, anche un codice 2FA.</p>
          <form method="POST">
            <input type="hidden" name="action" value="change_credentials" />

            <div class="form-row">
              <div class="form-control">
                <label>Password attuale</label>
                <div class="password-input-wrapper">
                  <input class="input" type="password" name="current_password" autocomplete="current-password"
                    required />
                  <button type="button" class="password-toggle" aria-label="{{ t('password.toggle.show') }}"
                    title="{{ t('password.toggle.show') }}">üëÅ</button>
                </div>
              </div>
              {% if two_factor_enabled %}
              <div class="form-control">
                <label>Codice 2FA corrente</label>
                <input class="input" type="text" name="current_totp_code" inputmode="numeric"
                  autocomplete="one-time-code" />
              </div>
              {% endif %}
            </div>

            <div class="form-control">
              <label>Nuovo username (facoltativo)</label>
              <input class="input" type="text" name="new_username" value="{{ current_username }}"
                autocomplete="username" />
            </div>

            <div class="form-row">
              <div class="form-control">
                <label>Nuova password (facoltativa)</label>
                <div class="password-input-wrapper">
                  <input class="input" type="password" name="new_password" autocomplete="new-password" />
                  <button type="button" class="password-toggle" aria-label="{{ t('password.toggle.show') }}"
                    title="{{ t('password.toggle.show') }}">üëÅ</button>
                </div>
              </div>
              <div class="form-control">
                <label>Conferma nuova password</label>
                <div class="password-input-wrapper">
                  <input class="input" type="password" name="new_password_confirm" autocomplete="new-password" />
                  <button type="button" class="password-toggle" aria-label="{{ t('password.toggle.show') }}"
                    title="{{ t('password.toggle.show') }}">üëÅ</button>
                </div>
              </div>
            </div>

            <div class="actions" style="margin-top: 12px; align-items: center;">
              <button type="submit" class="btn-primary-glow">Aggiorna credenziali</button>
              <span class="small muted">Minimo 10 caratteri e niente "admin".</span>
            </div>
          </form>
        </div>

        <!-- 2FA Card -->
        <div class="card">
          <div class="flex-between">
            <h2>Autenticazione a due fattori</h2>
            <div class="status-chip {{ 'success' if two_factor_enabled else 'danger' }}">
              <span class="dot"></span>
              <span>{{ 'Attiva' if two_factor_enabled else 'Disattivata' }}</span>
            </div>
          </div>
          <p class="muted small" style="margin-top: 4px; margin-bottom: 16px;">Proteggi l'accesso con un secondo fattore
            TOTP (Google Authenticator, Aegis...).</p>

          {% if not two_factor_enabled %}
          <form method="POST">
            <input type="hidden" name="action" value="enable_2fa" />
            <div class="form-control">
              <label>Password attuale</label>
              <div class="password-input-wrapper">
                <input class="input" type="password" name="current_password" autocomplete="current-password" required />
                <button type="button" class="password-toggle" aria-label="{{ t('password.toggle.show') }}"
                  title="{{ t('password.toggle.show') }}">üëÅ</button>
              </div>
            </div>
            <div class="actions" style="margin-top: 12px;">
              <button type="submit" class="btn-primary-glow">Abilita 2FA</button>
              <span class="small muted">Richiede conferma con un codice generato.</span>
            </div>
          </form>
          {% else %}
          <form method="POST">
            <input type="hidden" name="action" value="disable_2fa" />
            <div class="form-row">
              <div class="form-control">
                <label>Password attuale</label>
                <div class="password-input-wrapper">
                  <input class="input" type="password" name="current_password" autocomplete="current-password"
                    required />
                  <button type="button" class="password-toggle" aria-label="{{ t('password.toggle.show') }}"
                    title="{{ t('password.toggle.show') }}">üëÅ</button>
                </div>
              </div>
              <div class="form-control">
                <label>Codice 2FA corrente</label>
                <input class="input" type="text" name="current_totp_code" inputmode="numeric"
                  autocomplete="one-time-code" required />
              </div>
            </div>
            <div class="actions" style="margin-top: 12px;">
              <button type="submit" class="btn btn-danger">Disabilita 2FA</button>
              <span class="small muted">Servono password e codice valido.</span>
            </div>
          </form>
          {% endif %}

          {% if pending_2fa_setup and provisioning_uri %}
          <div class="debug-panel" style="margin-top: 20px; height: auto; border: 1px dashed var(--accent-border);">
            <div class="debug-header">
              <div class="debug-title" style="font-size: 1rem;">Setup 2FA in sospeso</div>
            </div>
            <div class="debug-body" style="padding: 16px; display: block;">
              <p style="margin-bottom: 12px;">Scansiona il QR o inserisci la chiave segreta, quindi verifica con un
                codice generato.</p>

              <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
                {% if qr_code_data_uri %}
                <div style="background: white; padding: 10px; border-radius: 12px;">
                  <img src="{{ qr_code_data_uri }}" alt="QR 2FA" width="160" height="160" style="display: block;" />
                </div>
                {% endif %}
                <div style="flex: 1; min-width: 200px;">
                  <div class="form-control">
                    <label>Segreto</label>
                    <code
                      style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; display: block;">{{ totp_secret or 'n/d' }}</code>
                  </div>
                  <div class="small muted" style="word-break: break-all; margin-top: 8px;">URI: {{ provisioning_uri }}
                  </div>
                </div>
              </div>

              <form method="POST" style="margin-top: 20px;">
                <input type="hidden" name="action" value="confirm_enable_2fa" />
                <div class="form-control">
                  <label>Inserisci un codice generato dall'app</label>
                  <div style="display: flex; gap: 10px;">
                    <input class="input" type="text" name="verify_totp_code" inputmode="numeric"
                      autocomplete="one-time-code" required placeholder="000000" style="max-width: 200px;" />
                    <button type="submit" class="btn-primary-glow">Conferma e abilita 2FA</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </main>
  </div>

  <script>
    (function enhancePasswordInputs() {
      const showLabel = '{{ t('password.toggle.show') }}';
      const hideLabel = '{{ t('password.toggle.hide') }}';

      document.querySelectorAll('input[type="password"]').forEach((input) => {
        const existingWrapper = input.closest('.password-input-wrapper');
        const wrapper = existingWrapper || (() => {
          const created = document.createElement('div');
          created.className = 'password-input-wrapper';
          input.parentNode.insertBefore(created, input);
          created.appendChild(input);
          return created;
        })();

        let toggle = wrapper.querySelector('.password-toggle');
        if (!toggle) {
          toggle = document.createElement('button');
          toggle.type = 'button';
          toggle.className = 'password-toggle';
          wrapper.appendChild(toggle);
        }

        if (toggle.dataset.bound === 'true') return;

        const updateState = (isHidden) => {
          toggle.setAttribute('aria-label', isHidden ? showLabel : hideLabel);
          toggle.title = isHidden ? showLabel : hideLabel;
          toggle.textContent = isHidden ? 'üëÅ' : 'üôà';
        };

        updateState(true);

        toggle.addEventListener('click', () => {
          const isHidden = input.type === 'password';
          input.type = isHidden ? 'text' : 'password';
          updateState(!isHidden);
        });

        toggle.dataset.bound = 'true';
      });
    })();
  </script>

  {% include 'partials/notifications_script.html' %}
</body>

</html>